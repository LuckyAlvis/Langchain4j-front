<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>耀耀工厂 - 系统概览</title>
    <link rel="stylesheet" href="permission-admin.css">
    <link rel="stylesheet" href="dashboard.css">
    <!-- 引入 ECharts -->
    <script src="js/echarts.min.js"></script>
</head>
<body>
    <div class="app-container">
        <!-- 侧边栏 -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <img src="logo.png" alt="耀耀工厂">
                </div>
                <h2>耀耀工厂</h2>
            </div>
            <div class="sidebar-nav">
                <a href="dashboard.html" class="nav-item active">
                    <i>📊</i>
                    <span>系统概览</span>
                </a>
                <a href="permission-admin.html" class="nav-item">
                    <i>🔑</i>
                    <span>权限管理</span>
                </a>
                <a href="system-logs.html" class="nav-item">
                    <i>📝</i>
                    <span>系统日志</span>
                </a>
            </div>
        </div>

        <!-- 主内容区域 -->
        <div class="main-content">
            <!-- 顶部导航 -->
            <div class="top-nav">
                <div class="breadcrumb">
                    系统概览
                </div>
                <div class="user-profile">
                    <div class="user-info" onclick="toggleUserMenu()">
                        <div class="avatar">戴</div>
                        <span class="username">超级管理员-戴倚凡</span>
                        <i class="dropdown-icon">▼</i>
                    </div>
                    <div class="user-menu" id="userMenu">
                        <div class="menu-item" onclick="logout()">
                            <i class="menu-icon">↩</i>
                            <span>退出登录</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 注释掉平台筛选区域 -->
            <!--
            <div class="platform-filter-area">
                <div class="filter-label">平台选择：</div>
                <div class="multi-select-container">
                    <div class="multi-select-header" id="platformSelectHeader">
                        <span class="selected-text">全部</span>
                        <span class="dropdown-icon">▼</span>
                    </div>
                    <div class="multi-select-dropdown" id="platformSelectDropdown">
                        <div class="multi-select-option">
                            <label>
                                <input type="checkbox" value="all" checked id="selectAllPlatforms"> 全部
                            </label>
                        </div>
                        <div class="multi-select-option">
                            <label>
                                <input type="checkbox" value="1" class="platform-option"> 第一平台
                            </label>
                        </div>
                        <div class="multi-select-option">
                            <label>
                                <input type="checkbox" value="2" class="platform-option"> 第二平台
                            </label>
                        </div>
                        <div class="multi-select-option">
                            <label>
                                <input type="checkbox" value="3" class="platform-option"> 第三平台
                            </label>
                        </div>
                        <div class="multi-select-option">
                            <label>
                                <input type="checkbox" value="4" class="platform-option"> 第四平台
                            </label>
                        </div>
                        <div class="multi-select-option">
                            <label>
                                <input type="checkbox" value="5" class="platform-option"> 第五平台
                            </label>
                        </div>
                    </div>
                </div>
                <button class="platform-search-btn" id="queryPlatformData">查询</button>
            </div>
            -->

            <!-- 注释掉数据看板 -->
            <!--
            <div class="dashboard-stats">
                <div class="stat-card">...</div>
                <div class="stat-card">...</div>
                <div class="stat-card">...</div>
                <div class="stat-card">...</div>
            </div>
            -->

            <!-- 添加新的动态排序折线图容器 -->
            <div class="card full-width-card">
                <div class="card-header">
                    <h3 class="card-title">注册人数变化趋势</h3>
                </div>
                <div class="card-body">
                    <div id="registrationTrendChart" class="chart-container"></div>
                </div>
            </div>

            <!-- 在统计卡片下方添加图表区域，保留原有的饼图 -->
            <div class="chart-row">
                <!-- 岗位分布饼图 -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">岗位总体分布</h3>
                    </div>
                    <div class="card-body">
                        <div id="jobDistributionChart" class="chart-container"></div>
                    </div>
                </div>

                <!-- 部门分布饼图 -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">部门总体分布</h3>
                    </div>
                    <div class="card-body">
                        <div id="userDistributionChart" class="chart-container"></div>
                    </div>
                </div>
            </div>

            <!-- 添加新的平台对比图表区域 -->
            <div class="full-width-chart-row">
                <!-- 岗位分布对比柱状图 -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">各平台岗位分布对比</h3>
                    </div>
                    <div class="card-body">
                        <div id="jobComparisonChart" class="chart-container"></div>
                    </div>
                </div>
                
                <!-- 部门分布对比柱状图 -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">各平台部门分布对比</h3>
                    </div>
                    <div class="card-body">
                        <div id="deptComparisonChart" class="chart-container"></div>
                    </div>
                </div>
            </div>

            <!-- 最近活动
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">最近活动</h3>
                </div>
                <div class="card-body">
                    <div class="activity-list">
                        <div class="activity-item">
                            <div class="activity-icon approved">✓</div>
                            <div class="activity-content">
                                <div class="activity-text">
                                    <div class="activity-title">审批通过 - 张三</div>
                                    <div class="activity-meta">
                                        <span class="activity-time">10分钟前</span>
                                        <span class="activity-user">戴倚凡</span>
                                    </div>
                                </div>
                                <div class="activity-detail">
                                    <button class="view-detail-btn">查看详情</button>
                                </div>
                            </div>
                        </div>
                        <div class="activity-item">
                            <div class="activity-icon login">→</div>
                            <div class="activity-content">
                                <div class="activity-text">
                                    <div class="activity-title">系统登录 - 李四</div>
                                    <div class="activity-meta">
                                        <span class="activity-time">30分钟前</span>
                                    </div>
                                </div>
                                <div class="activity-detail">
                                    <button class="view-detail-btn">查看详情</button>
                                </div>
                            </div>
                        </div>
                        <div class="activity-item">
                            <div class="activity-icon rejected">✗</div>
                            <div class="activity-content">
                                <div class="activity-text">
                                    <div class="activity-title">审批拒绝 - 王五</div>
                                    <div class="activity-meta">
                                        <span class="activity-time">1小时前</span>
                                        <span class="activity-user">戴倚凡</span>
                                    </div>
                                </div>
                                <div class="activity-detail">
                                    <button class="view-detail-btn">查看详情</button>
                                </div>
                            </div>
                        </div>
                        <div class="activity-item">
                            <div class="activity-icon new">+</div>
                            <div class="activity-content">
                                <div class="activity-text">
                                    <div class="activity-title">权限申请 - 赵六</div>
                                    <div class="activity-meta">
                                        <span class="activity-time">3小时前</span>
                                    </div>
                                </div>
                            </div>
                            <div class="activity-detail">
                                <button class="view-detail-btn">查看详情</button>
                            </div>
                        </div>
                        <div class="activity-item">
                            <div class="activity-icon revoked">-</div>
                            <div class="activity-content">
                                <div class="activity-text">
                                    <div class="activity-title">权限收回 - 孙七</div>
                                    <div class="activity-meta">
                                        <span class="activity-time">昨天 15:30</span>
                                    </div>
                                </div>
                            </div>
                            <div class="activity-detail">
                                <button class="view-detail-btn">查看详情</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div> -->
        </div>
    </div>

    <!-- 在dashboard.html底部添加的模态框，与system-logs.html中相同 -->
    <div id="activity-detail-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>操作详情</h3>
                <span class="close-btn">&times;</span>
            </div>
            <div class="modal-body">
                <div class="detail-section">
                    <h4>基本信息</h4>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-label">操作类型</div>
                            <div class="detail-value">审批通过</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">操作时间</div>
                            <div class="detail-value">2023-10-26 14:35:22</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">操作人</div>
                            <div class="detail-value">戴倚凡（管理员）</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">IP地址</div>
                            <div class="detail-value">192.168.1.102</div>
                        </div>
                    </div>
                </div>
                
                <div class="detail-section">
                    <h4>申请信息</h4>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-label">申请人</div>
                            <div class="detail-value">张三</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">所属部门</div>
                            <div class="detail-value">中國建築國際-中建香港-海宏技術有限公司-海宏公司團隊(駐深)-數字化提升部二部</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">邮箱</div>
                            <div class="detail-value">zhangsan@example.com</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">岗位名称</div>
                            <div class="detail-value">高级开发工程师</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">邮箱</div>
                            <div class="detail-value">zhangsan@example.com</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">申请权限</div>
                            <div class="detail-value">耀耀工厂登录权限</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">申请时间</div>
                            <div class="detail-value">2023-10-26 10:20:35</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">申请原因</div>
                            <div class="detail-remarks">
                                因工作需要，需要访问中海通系统查询客户订单数据，以便进行技术支持和问题排查。系统中的用户日志和订单流程数据对解决客户反馈的问题至关重要。
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="detail-section">
                    <h4>操作备注</h4>
                    <div class="detail-remarks">
                        已核实用户身份和需求，符合公司安全政策要求，予以批准。用户权限长期有效。
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn cancel-btn">关闭</button>
            </div>
        </div>
    </div>

    <script>
        // 在document.ready之前，添加全局变量
        let jobComparisonChart = null;
        let deptComparisonChart = null;

        // 修复系统概览页面的问题
        document.addEventListener('DOMContentLoaded', function() {
            // ... existing code ...
            
            // 修复重复活动项的问题
            const activityItems = document.querySelectorAll('.activity-item');
            activityItems.forEach(item => {
                const titleElement = item.querySelector('.activity-title');
                if (titleElement) {
                    // 将"系统登录"改为"登录系统"
                    if (titleElement.textContent.includes('系统登录')) {
                        titleElement.textContent = titleElement.textContent.replace('系统登录', '登录系统');
                    }
                    
                    // 将"收回权限"改为"权限收回"
                    if (titleElement.textContent.includes('收回权限')) {
                        titleElement.textContent = titleElement.textContent.replace('收回权限', '权限收回');
                    }
                    
                    // 针对权限收回操作，移除操作人
                    if (titleElement.textContent.includes('权限收回')) {
                        const operatorElement = item.querySelector('.activity-user');
                        if (operatorElement) {
                            operatorElement.style.display = 'none';
                        }
                    }
                }
            });
            
            // 确保图表正确初始化
            initECharts();
            initComparisonCharts();
            initRegistrationTrendChart();
        });

        // 确保图表初始化函数正确定义
        function initECharts() {
            // 初始化部门分布ECharts实例
            var deptChartDom = document.getElementById('userDistributionChart');
            var deptChart = echarts.init(deptChartDom);

            // 部门分布配置项和数据
            var deptOption = {
                tooltip: {
                    trigger: 'item',
                    formatter: '{a} <br/>{b}: {c} ({d}%)'
                },
                legend: {
                    orient: 'horizontal',
                    bottom: 0,
                    data: ['中國建築國際-中建香港-海宏技術有限公司-海宏公司團隊(駐深)-數字化提升部二部', '中國建築國際-中建香港-房屋公司-房屋公司團隊（駐深）', '中國建築國際-中建澳門-总部部门-信息化管理部', '中國建築國際-中建澳門-总部部门-信息化管理部']
                },
                series: [
                    {
                        name: '部门分布',
                        type: 'pie',
                        radius: ['45%', '70%'],
                        avoidLabelOverlap: false,
                        itemStyle: {
                            borderRadius: 10,
                            borderColor: '#fff',
                            borderWidth: 2
                        },
                        label: {
                            show: false,
                            position: 'center'
                        },
                        emphasis: {
                            label: {
                                show: true,
                                fontSize: '18',
                                fontWeight: 'bold'
                            }
                        },
                        labelLine: {
                            show: false
                        },
                        data: [
                            {value: 148, name: '中國建築國際-中建香港-海宏技術有限公司-海宏公司團隊(駐深)-數字化提升部二部', itemStyle: {color: '#1890ff'}},
                            {value: 82, name: '中國建築國際-中建香港-房屋公司-房屋公司團隊（駐深）', itemStyle: {color: '#faad14'}},
                            {value: 66, name: '中國建築國際-中建澳門-总部部门-信息化管理部', itemStyle: {color: '#722ed1'}},
                            {value: 32, name: '中國建築國際-中建澳門-总部部门-信息化管理部', itemStyle: {color: '#bfbfbf'}}
                        ]
                    }
                ]
            };

            // 使用配置项显示部门分布图表
            deptChart.setOption(deptOption);

            // 初始化岗位分布ECharts实例
            var jobChartDom = document.getElementById('jobDistributionChart');
            var jobChart = echarts.init(jobChartDom);

            // 岗位分布配置项和数据
            var jobOption = {
                tooltip: {
                    trigger: 'item',
                    formatter: '{a} <br/>{b}: {c} ({d}%)'
                },
                legend: {
                    orient: 'horizontal',
                    bottom: 0,
                    data: ['技术开发主任', '助理技术开发主任', '助理总经理', '助理技术开发经理', '高级Java开发工程师']
                },
                series: [
                    {
                        name: '岗位分布',
                        type: 'pie',
                        radius: ['45%', '70%'],
                        avoidLabelOverlap: false,
                        itemStyle: {
                            borderRadius: 10,
                            borderColor: '#fff',
                            borderWidth: 2
                        },
                        label: {
                            show: false,
                            position: 'center'
                        },
                        emphasis: {
                            label: {
                                show: true,
                                fontSize: '18',
                                fontWeight: 'bold'
                            }
                        },
                        labelLine: {
                            show: false
                        },
                        data: [
                            {value: 120, name: '技术开发主任', itemStyle: {color: '#52c41a'}},
                            {value: 56, name: '助理技术开发主任', itemStyle: {color: '#13c2c2'}},
                            {value: 42, name: '助理总经理', itemStyle: {color: '#eb2f96'}},
                            {value: 68, name: '助理技术开发经理', itemStyle: {color: '#faad14'}},
                            {value: 42, name: '高级Java开发工程师', itemStyle: {color: '#2C4CDD'}}
                        ]
                    }
                ]
            };

            // 使用配置项显示岗位分布图表
            jobChart.setOption(jobOption);
        }

        // 添加初始化对比图表函数
        function initComparisonCharts() {
            // 初始化岗位分布对比图
            const jobCompDom = document.getElementById('jobComparisonChart');
            if (jobCompDom) {
                jobComparisonChart = echarts.init(jobCompDom);
                
                // 基础配置
                const jobCompOption = {
                    tooltip: {
                        trigger: 'axis',
                        axisPointer: {
                            type: 'shadow'
                        },
                        formatter: function(params) {
                            let result = params[0].name + '<br/>';
                            let total = 0;
                            
                            params.forEach(param => {
                                total += param.value;
                                const colorSpan = `<span style="display:inline-block;margin-right:5px;border-radius:10px;width:10px;height:10px;background-color:${param.color};"></span>`;
                                result += colorSpan + param.seriesName + ': ' + param.value + ' (' + ((param.value / total) * 100).toFixed(1) + '%)<br/>';
                            });
                            
                            result += `<b>总计: ${total}</b>`;
                            return result;
                        }
                    },
                    legend: {
                        data: ['技术开发主任', '助理技术开发主任', '助理总经理', '助理技术开发经理', '高级Java开发工程师'],
                        right: 10,
                        top: 10
                    },
                    grid: {
                        left: '3%',
                        right: '4%',
                        bottom: '15%',
                        top: '15%',
                        containLabel: true
                    },
                    yAxis: {
                        type: 'category',
                        data: ['第一平台', '第二平台', '第三平台', '第四平台', '第五平台'],
                        axisLabel: {
                            interval: 0
                        }
                    },
                    xAxis: {
                        type: 'value',
                        name: '人数',
                        nameLocation: 'end'
                    },
                    series: [
                        {
                            name: '技术开发主任',
                            type: 'bar',
                            stack: '总量',
                            emphasis: {
                                focus: 'series'
                            },
                            itemStyle: {color: '#52c41a'},
                            data: [65, 30, 15, 8, 2],
                            label: {
                                show: false,
                                position: 'insideRight'
                            }
                        },
                        {
                            name: '助理技术开发主任',
                            type: 'bar',
                            stack: '总量',
                            emphasis: {
                                focus: 'series'
                            },
                            itemStyle: {color: '#13c2c2'},
                            data: [25, 18, 12, 5, 1],
                            label: {
                                show: false,
                                position: 'insideRight'
                            }
                        },
                        {
                            name: '助理总经理',
                            type: 'bar',
                            stack: '总量',
                            emphasis: {
                                focus: 'series'
                            },
                            itemStyle: {color: '#eb2f96'},
                            data: [20, 15, 8, 3, 1],
                            label: {
                                show: false,
                                position: 'insideRight'
                            }
                        },
                        {
                            name: '助理技术开发经理',
                            type: 'bar',
                            stack: '总量',
                            emphasis: {
                                focus: 'series'
                            },
                            itemStyle: {color: '#faad14'},
                            data: [30, 20, 12, 6, 2],
                            label: {
                                show: false,
                                position: 'insideRight'
                            }
                        },
                        {
                            name: '高级Java开发工程师',
                            type: 'bar',
                            stack: '总量',
                            emphasis: {
                                focus: 'series'
                            },
                            itemStyle: {color: '#2C4CDD'},
                            data: [15, 10, 5, 2, 0],
                            label: {
                                show: false,
                                position: 'insideRight'
                            }
                        }
                    ]
                };
                
                jobComparisonChart.setOption(jobCompOption);
            }
            
            // 初始化部门分布对比图
            const deptCompDom = document.getElementById('deptComparisonChart');
            if (deptCompDom) {
                deptComparisonChart = echarts.init(deptCompDom);
                
                // 基础配置
                const deptCompOption = {
                    tooltip: {
                        trigger: 'axis',
                        axisPointer: {
                            type: 'shadow'
                        },
                        formatter: function(params) {
                            let result = params[0].name + '<br/>';
                            let total = 0;
                            
                            params.forEach(param => {
                                total += param.value;
                                const colorSpan = `<span style="display:inline-block;margin-right:5px;border-radius:10px;width:10px;height:10px;background-color:${param.color};"></span>`;
                                result += colorSpan + param.seriesName + ': ' + param.value + ' (' + ((param.value / total) * 100).toFixed(1) + '%)<br/>';
                            });
                            
                            result += `<b>总计: ${total}</b>`;
                            return result;
                        }
                    },
                    legend: {
                        data: ['中國建築國際-中建香港-海宏技術有限公司-海宏公司團隊(駐深)-數字化提升部二部', '中國建築國際-中建香港-房屋公司-房屋公司團隊（駐深）', '中國建築國際-中建澳門-总部部门-信息化管理部', '中國建築國際-中建澳門-总部部门-信息化管理部'],
                        right: 10,
                        top: 10
                    },
                    grid: {
                        left: '3%',
                        right: '4%',
                        bottom: '15%',
                        top: '15%',
                        containLabel: true
                    },
                    yAxis: {
                        type: 'category',
                        data: ['第一平台', '第二平台'],
                        axisLabel: {
                            interval: 0
                        }
                    },
                    xAxis: {
                        type: 'value',
                        name: '人数',
                        nameLocation: 'end'
                    },
                    series: [
                        {
                            name: '中國建築國際-中建香港-海宏技術有限公司-海宏公司團隊(駐深)-數字化提升部二部',
                            type: 'bar',
                            stack: '总量',
                            emphasis: {
                                focus: 'series'
                            },
                            itemStyle: {color: '#1890ff'},
                            data: [70, 35, 20, 10, 3],
                            label: {
                                show: false,
                                position: 'insideRight'
                            }
                        },
                        {
                            name: '中國建築國際-中建香港-房屋公司-房屋公司團隊（駐深）',
                            type: 'bar',
                            stack: '总量',
                            emphasis: {
                                focus: 'series'
                            },
                            itemStyle: {color: '#faad14'},
                            data: [35, 25, 15, 8, 2],
                            label: {
                                show: false,
                                position: 'insideRight'
                            }
                        },
                        {
                            name: '中國建築國際-中建澳門-总部部门-信息化管理部',
                            type: 'bar',
                            stack: '总量',
                            emphasis: {
                                focus: 'series'
                            },
                            itemStyle: {color: '#722ed1'},
                            data: [30, 20, 12, 5, 1],
                            label: {
                                show: false,
                                position: 'insideRight'
                            }
                        },
                        {
                            name: '中國建築國際-中建澳門-总部部门-信息化管理部',
                            type: 'bar',
                            stack: '总量',
                            emphasis: {
                                focus: 'series'
                            },
                            itemStyle: {color: '#bfbfbf'},
                            data: [15, 8, 4, 2, 0],
                            label: {
                                show: false,
                                position: 'insideRight'
                            }
                        }
                    ]
                };
                
                deptComparisonChart.setOption(deptCompOption);
            }
        }

        // 添加更新对比图表函数
        function updateComparisonCharts(platformIds) {
            const platformNames = {
                '1': '第一平台',
                '2': '第二平台',
                '3': '第三平台',
                '4': '第四平台',
                '5': '第五平台'
            };
            
            // 筛选并排序选中的平台
            const selectedPlatformNames = platformIds.map(id => platformNames[id]).filter(Boolean);
            
            // 准备岗位分布数据
            const jobSeriesData = {};
            const jobCategories = ['技术开发主任', '助理技术开发主任', '助理总经理', '助理技术开发经理', '高级Java开发工程师'];
            
            // 初始化数据结构
            jobCategories.forEach(category => {
                jobSeriesData[category] = [];
            });
            
            // 填充各平台各岗位的数据
            platformIds.forEach(platformId => {
                const platformData = window.platformData[platformId];
                
                jobCategories.forEach(category => {
                    const categoryData = platformData.jobDistribution.find(item => item.name === category);
                    jobSeriesData[category].push(categoryData ? categoryData.value : 0);
                });
            });
            
            // 更新岗位分布对比图
            if (jobComparisonChart) {
                jobComparisonChart.setOption({
                    yAxis: {
                        data: selectedPlatformNames
                    },
                    series: [
                        {
                            name: '技术开发主任',
                            data: jobSeriesData['技术开发主任']
                        },
                        {
                            name: '助理技术开发主任',
                            data: jobSeriesData['助理技术开发主任']
                        },
                        {
                            name: '助理总经理',
                            data: jobSeriesData['助理总经理']
                        },
                        {
                            name: '助理技术开发经理',
                            data: jobSeriesData['助理技术开发经理']
                        },
                        {
                            name: '高级Java开发工程师',
                            data: jobSeriesData['高级Java开发工程师']
                        }
                    ]
                });
            }
            
            // 准备部门分布数据
            const deptSeriesData = {};
            const deptCategories = ['中國建築國際-中建香港-海宏技術有限公司-海宏公司團隊(駐深)-數字化提升部二部', '中國建築國際-中建香港-房屋公司-房屋公司團隊（駐深）', '中國建築國際-中建澳門-总部部门-信息化管理部', '中國建築國際-中建澳門-总部部门-信息化管理部'];
            
            // 初始化数据结构
            deptCategories.forEach(category => {
                deptSeriesData[category] = [];
            });
            
            // 填充各平台各部门的数据
            platformIds.forEach(platformId => {
                const platformData = window.platformData[platformId];
                
                deptCategories.forEach(category => {
                    const categoryData = platformData.deptDistribution.find(item => item.name === category);
                    deptSeriesData[category].push(categoryData ? categoryData.value : 0);
                });
            });
            
            // 更新部门分布对比图
            if (deptComparisonChart) {
                deptComparisonChart.setOption({
                    yAxis: {
                        data: selectedPlatformNames
                    },
                    series: [
                        {
                            name: '中國建築國際-中建香港-海宏技術有限公司-海宏公司團隊(駐深)-數字化提升部二部',
                            data: deptSeriesData['中國建築國際-中建香港-海宏技術有限公司-海宏公司團隊(駐深)-數字化提升部二部']
                        },
                        {
                            name: '中國建築國際-中建香港-房屋公司-房屋公司團隊（駐深）',
                            data: deptSeriesData['中國建築國際-中建香港-房屋公司-房屋公司團隊（駐深）']
                        },
                        {
                            name: '中國建築國際-中建澳門-总部部门-信息化管理部',
                            data: deptSeriesData['中國建築國際-中建澳門-总部部门-信息化管理部']
                        },
                        {
                            name: '中國建築國際-中建澳門-总部部门-信息化管理部',
                            data: deptSeriesData['中國建築國際-中建澳門-总部部门-信息化管理部']
                        }
                    ]
                });
            }
        }

        // 用户菜单相关功能
        function toggleUserMenu() {
            const menu = document.getElementById('userMenu');
            if (menu.style.display === 'block') {
                menu.style.display = 'none';
            } else {
                menu.style.display = 'block';
            }
        }

        // 点击页面其他地方关闭菜单
        document.addEventListener('click', function (event) {
            const userInfo = document.querySelector('.user-info');
            const userMenu = document.getElementById('userMenu');

            if (!userInfo.contains(event.target) && userMenu.style.display === 'block') {
                userMenu.style.display = 'none';
            }
        }, true);

        function logout() {
            if (confirm('确定要退出登录吗？')) {
                window.location.href = 'login.html';
            }
        }

        // 确保在DOM完全加载后执行
        document.addEventListener('DOMContentLoaded', function() {
            // 获取模态框和相关元素
            const activityModal = document.getElementById('activity-detail-modal');
            
            // 确保模态框存在
            if (!activityModal) {
                console.error('活动详情模态框不存在');
                return;
            }
            
            const detailButtons = document.querySelectorAll('.activity-detail .view-detail-btn');
            const closeBtn = activityModal.querySelector('.close-btn');
            const cancelBtn = activityModal.querySelector('.modal-btn.cancel-btn');
            
            console.log('找到查看详情按钮数量:', detailButtons.length); // 调试信息
            
            // 为所有查看详情按钮添加点击事件
            detailButtons.forEach(button => {
                button.addEventListener('click', function(event) {
                    event.preventDefault(); // 防止按钮默认行为
                    
                    // 获取活动类型
                    const activityItem = this.closest('.activity-item');
                    
                    if (!activityItem) {
                        console.error('无法找到父级活动项元素');
                        return;
                    }
                    
                    const activityIcon = activityItem.querySelector('.activity-icon');
                    const activityTitle = activityItem.querySelector('.activity-title');
                    
                    if (!activityIcon || !activityTitle) {
                        console.error('活动图标或标题不存在');
                        return;
                    }
                    
                    console.log('点击查看详情:', activityTitle.textContent); // 调试信息
                    
                    // 根据类型设置不同的模态框内容
                    updateActivityModalContent(activityIcon.className, activityTitle.textContent);
                    
                    // 显示模态框
                    activityModal.style.display = 'flex';
                });
            });
            
            // 根据活动类型更新模态框内容
            function updateActivityModalContent(iconClass, title) {
                console.log('更新模态框内容:', iconClass, title); // 调试信息
                
                // 设置模态框标题
                const modalTitle = activityModal.querySelector('.modal-header h3');
                if (modalTitle) {
                    modalTitle.textContent = title.includes('-') ? 
                        title.split('-')[0].trim() + '详情' : '操作详情';
                }
                
                // 获取申请人名称
                let userName = '';
                if (title.includes('-')) {
                    userName = title.split('-')[1].trim();
                } else if (title.includes('的')) {
                    userName = title.split('的')[0].trim();
                }
                
                // 根据用户名设置相关信息
                let jobId = 'ZH001';
                let department = '中國建築國際-中建香港-海宏技術有限公司-海宏公司團隊(駐深)-數字化提升部二部';
                let position = '高级开发工程师';
                let email = 'zhangsan@example.com';
                
                // 根据不同用户设置不同信息
                if (userName.includes('李四')) {
                    jobId = 'ZH002';
                    department = '中國建築國際-中建香港-房屋公司-房屋公司團隊（駐深）';
                    position = '市场专员';
                    email = 'lisi@example.com';
                } else if (userName.includes('王五')) {
                    jobId = 'ZH003';
                    department = '中國建築國際-中建澳門-总部部门-信息化管理部';
                    position = '助理技术开发主任';
                    email = 'wangwu@example.com';
                } else if (userName.includes('赵六')) {
                    jobId = 'ZH004';
                    department = '中國建築國際-中建香港-人力资源部';
                    position = 'HR专员';
                    email = 'zhaoliu@example.com';
                } else if (userName.includes('钱七')) {
                    jobId = 'ZH005';
                    department = '中國建築國際-中建香港-海宏技術有限公司-海宏公司團隊(駐深)-數字化提升部二部';
                    position = '开发工程师';
                    email = 'qianqi@example.com';
                }
                
                // 更新用户相关信息
                const detailItems = activityModal.querySelectorAll('.detail-item');
                detailItems.forEach(item => {
                    const label = item.querySelector('.detail-label');
                    const value = item.querySelector('.detail-value');
                    
                    if (label && value) {
                        if (label.textContent === '申请人') {
                            value.textContent = userName;
                        } else if (label.textContent === '邮箱') {
                            value.textContent = jobId;
                        } else if (label.textContent === '所属部门') {
                            value.textContent = department;
                        } else if (label.textContent === '岗位名称') {
                            value.textContent = position;
                        } else if (label.textContent === '邮箱') {
                            value.textContent = email;
                        }
                    }
                });
                
                // 获取备注部分元素
                const remarkSection = activityModal.querySelector('.detail-section:nth-of-type(4)');
                if (!remarkSection) {
                    console.error('无法找到备注部分');
                    return;
                }
                
                const remarkContent = remarkSection.querySelector('.detail-remarks');
                
                // 获取申请原因部分元素
                const reasonSection = activityModal.querySelector('.detail-section:nth-of-type(3)');
                
                // 根据图标类名判断活动类型
                if (iconClass.includes('approved')) {
                    // 审批通过
                    remarkSection.querySelector('h4').textContent = '审批备注';
                    remarkContent.textContent = '已核实用户身份和需求，符合公司安全政策要求，予以批准。用户权限长期有效。';
                    remarkContent.style.borderLeftColor = '#52c41a'; // 绿色
                    remarkContent.style.backgroundColor = '#f6ffed';
                    reasonSection.style.display = 'block'; // 显示申请原因
                } 
                else if (iconClass.includes('rejected')) {
                    // 审批拒绝
                    remarkSection.querySelector('h4').textContent = '拒绝理由';
                    remarkContent.textContent = '申请用途与用户岗位职责不符，无法确认业务需求的真实性。建议由部门主管重新提交申请并详细说明业务需求。';
                    remarkContent.style.borderLeftColor = '#f5222d'; // 红色
                    remarkContent.style.backgroundColor = '#fff1f0';
                    reasonSection.style.display = 'block'; // 显示申请原因
                }
                else if (iconClass.includes('login')) {
                    // 登录操作
                    remarkSection.querySelector('h4').textContent = '登录信息';
                    remarkContent.textContent = '登录成功。设备信息：Windows 10，Chrome 浏览器。登录位置：公司内网，IP地址匹配常用位置。';
                    remarkContent.style.borderLeftColor = '#1890ff'; // 蓝色
                    remarkContent.style.backgroundColor = '#e6f7ff';
                    reasonSection.style.display = 'none'; // 隐藏申请原因
                }
                else if (iconClass.includes('new')) {
                    // 新申请
                    remarkSection.querySelector('h4').textContent = '申请状态';
                    remarkContent.textContent = '申请已提交，等待管理员审批。预计处理时间：24小时内。';
                    remarkContent.style.borderLeftColor = '#faad14'; // 黄色
                    remarkContent.style.backgroundColor = '#fffbe6';
                    reasonSection.style.display = 'block'; // 显示申请原因
                }
                else if (iconClass.includes('revoked')) {
                    // 收回权限
                    remarkSection.querySelector('h4').textContent = '操作备注';
                    remarkContent.textContent = '根据公司权限管理规定，用户30天未使用该权限，系统自动收回。用户可重新申请。';
                    remarkContent.style.borderLeftColor = '#bfbfbf'; // 灰色
                    remarkContent.style.backgroundColor = '#fafafa';
                    reasonSection.style.display = 'none'; // 隐藏申请原因
                }
                
                // 调整申请信息部分的显示与隐藏
                const appInfoSection = activityModal.querySelector('.detail-section:nth-of-type(2)');
                if (iconClass.includes('login')) {
                    // 登录操作不显示申请信息，而是显示用户信息
                    appInfoSection.querySelector('h4').textContent = '用户信息';
                    appInfoSection.querySelectorAll('.detail-item').forEach((item, index) => {
                        const label = item.querySelector('.detail-label');
                        const value = item.querySelector('.detail-value');
                        
                        switch(index) {
                            case 0:
                                label.textContent = '用户名';
                                value.textContent = '李四';
                                break;
                            case 1:
                                label.textContent = '所属部门';
                                value.textContent = '中國建築國際-中建香港-房屋公司-房屋公司團隊（駐深）';
                                break;
                            case 2:
                                label.textContent = '用户角色';
                                value.textContent = '普通用户';
                                break;
                            case 3:
                                label.textContent = '登录时间';
                                value.textContent = '2023-10-26 14:30:22';
                                break;
                        }
                    });
                } else {
                    // 其他操作显示申请信息
                    appInfoSection.querySelector('h4').textContent = '申请信息';
                    
                    // 根据标题获取用户名
                    let userName = '张三'; // 默认
                    if (title.includes('-')) {
                        userName = title.split('-')[1].trim().split('的')[0];
                    }
                    
                    appInfoSection.querySelectorAll('.detail-item').forEach((item, index) => {
                        const label = item.querySelector('.detail-label');
                        const value = item.querySelector('.detail-value');
                        
                        switch(index) {
                            case 0:
                                label.textContent = '申请人';
                                value.textContent = userName;
                                break;
                            case 1:
                                label.textContent = '所属部门';
                                value.textContent = userName === '张三' ? '中國建築國際-中建香港-海宏技術有限公司-海宏公司團隊(駐深)-數字化提升部二部' : 
                                                    userName === '王五' ? '财务部' : 
                                                    userName === '赵六' ? '中國建築國際-中建澳門-总部部门-信息化管理部' : '中國建築國際-中建香港-房屋公司-房屋公司團隊（駐深）';
                                break;
                            case 2:
                                label.textContent = '邮箱';
                                value.textContent = 'zhangsan@example.com';
                                break;
                            case 3:
                                label.textContent = '岗位名称';
                                value.textContent = '高级开发工程师';
                                break;
                            case 4:
                                label.textContent = '邮箱';
                                value.textContent = 'zhangsan@example.com';
                                break;
                            case 5:
                                label.textContent = '申请权限';
                                value.textContent = '中海通登录权限';
                                break;
                            case 6:
                                label.textContent = '申请时间';
                                value.textContent = '2023-10-26 10:20:35';
                                break;
                        }
                    });
                }
            }
            
            // 关闭模态框的事件处理
            if (closeBtn) {
                closeBtn.addEventListener('click', () => {
                    activityModal.style.display = 'none';
                });
            }
            
            if (cancelBtn) {
                cancelBtn.addEventListener('click', () => {
                    activityModal.style.display = 'none';
                });
            }
            
            window.addEventListener('click', (event) => {
                if (event.target === activityModal) {
                    activityModal.style.display = 'none';
                }
            });
        });

        // 平台数据 - 模拟各平台的数据
        const platformData = {
            all: {
                onlineUsers: 42,
                dailyVisits: 256,
                pendingApprovals: 15,
                authorizedUsers: 328,
                jobDistribution: [
                    {value: 120, name: '技术开发主任', itemStyle: {color: '#52c41a'}},
                    {value: 56, name: '助理技术开发主任', itemStyle: {color: '#13c2c2'}},
                    {value: 42, name: '助理总经理', itemStyle: {color: '#eb2f96'}},
                    {value: 68, name: '助理技术开发经理', itemStyle: {color: '#faad14'}},
                    {value: 42, name: '高级Java开发工程师', itemStyle: {color: '#2C4CDD'}}
                ],
                deptDistribution: [
                    {value: 148, name: '中國建築國際-中建香港-海宏技術有限公司-海宏公司團隊(駐深)-數字化提升部二部', itemStyle: {color: '#1890ff'}},
                    {value: 82, name: '中國建築國際-中建香港-房屋公司-房屋公司團隊（駐深）', itemStyle: {color: '#faad14'}},
                    {value: 66, name: '中國建築國際-中建澳門-总部部门-信息化管理部', itemStyle: {color: '#722ed1'}},
                    {value: 32, name: '中國建築國際-中建澳門-总部部门-信息化管理部', itemStyle: {color: '#bfbfbf'}}
                ]
            },
            1: {
                onlineUsers: 18,
                dailyVisits: 112,
                pendingApprovals: 7,
                authorizedUsers: 145,
                jobDistribution: [
                    {value: 65, name: '技术开发主任', itemStyle: {color: '#52c41a'}},
                    {value: 25, name: '助理技术开发主任', itemStyle: {color: '#13c2c2'}},
                    {value: 18, name: '助理总经理', itemStyle: {color: '#eb2f96'}},
                    {value: 22, name: '助理技术开发经理', itemStyle: {color: '#faad14'}},
                    {value: 15, name: '高级Java开发工程师', itemStyle: {color: '#2C4CDD'}}
                ],
                deptDistribution: [
                    {value: 75, name: '中國建築國際-中建香港-海宏技術有限公司-海宏公司團隊(駐深)-數字化提升部二部', itemStyle: {color: '#1890ff'}},
                    {value: 35, name: '中國建築國際-中建香港-房屋公司-房屋公司團隊（駐深）', itemStyle: {color: '#faad14'}},
                    {value: 25, name: '中國建築國際-中建澳門-总部部门-信息化管理部', itemStyle: {color: '#722ed1'}},
                    {value: 10, name: '中國建築國際-中建澳門-总部部门-信息化管理部', itemStyle: {color: '#bfbfbf'}}
                ]
            },
            2: {
                onlineUsers: 12,
                dailyVisits: 84,
                pendingApprovals: 4,
                authorizedUsers: 93,
                jobDistribution: [
                    {value: 30, name: '技术开发主任', itemStyle: {color: '#52c41a'}},
                    {value: 16, name: '助理技术开发主任', itemStyle: {color: '#13c2c2'}},
                    {value: 12, name: '助理总经理', itemStyle: {color: '#eb2f96'}},
                    {value: 25, name: '助理技术开发经理', itemStyle: {color: '#faad14'}},
                    {value: 10, name: '高级Java开发工程师', itemStyle: {color: '#2C4CDD'}}
                ],
                deptDistribution: [
                    {value: 38, name: '中國建築國際-中建香港-海宏技術有限公司-海宏公司團隊(駐深)-數字化提升部二部', itemStyle: {color: '#1890ff'}},
                    {value: 28, name: '中國建築國際-中建香港-房屋公司-房屋公司團隊（駐深）', itemStyle: {color: '#faad14'}},
                    {value: 18, name: '中國建築國際-中建澳門-总部部门-信息化管理部', itemStyle: {color: '#722ed1'}},
                    {value: 9, name: '中國建築國際-中建澳門-总部部门-信息化管理部', itemStyle: {color: '#bfbfbf'}}
                ]
            },
            3: {
                onlineUsers: 8,
                dailyVisits: 32,
                pendingApprovals: 2,
                authorizedUsers: 45,
                jobDistribution: [
                    {value: 15, name: '技术开发主任', itemStyle: {color: '#52c41a'}},
                    {value: 8, name: '助理技术开发主任', itemStyle: {color: '#13c2c2'}},
                    {value: 7, name: '助理总经理', itemStyle: {color: '#eb2f96'}},
                    {value: 10, name: '助理技术开发经理', itemStyle: {color: '#faad14'}},
                    {value: 5, name: '高级Java开发工程师', itemStyle: {color: '#2C4CDD'}}
                ],
                deptDistribution: [
                    {value: 20, name: '中國建築國際-中建香港-海宏技術有限公司-海宏公司團隊(駐深)-數字化提升部二部', itemStyle: {color: '#1890ff'}},
                    {value: 12, name: '中國建築國際-中建香港-房屋公司-房屋公司團隊（駐深）', itemStyle: {color: '#faad14'}},
                    {value: 10, name: '中國建築國際-中建澳門-总部部门-信息化管理部', itemStyle: {color: '#722ed1'}},
                    {value: 3, name: '中國建築國際-中建澳門-总部部门-信息化管理部', itemStyle: {color: '#bfbfbf'}}
                ]
            },
            4: {
                onlineUsers: 3,
                dailyVisits: 18,
                pendingApprovals: 1,
                authorizedUsers: 25,
                jobDistribution: [
                    {value: 8, name: '技术开发主任', itemStyle: {color: '#52c41a'}},
                    {value: 5, name: '助理技术开发主任', itemStyle: {color: '#13c2c2'}},
                    {value: 3, name: '助理总经理', itemStyle: {color: '#eb2f96'}},
                    {value: 6, name: '助理技术开发经理', itemStyle: {color: '#faad14'}},
                    {value: 3, name: '高级Java开发工程师', itemStyle: {color: '#2C4CDD'}}
                ],
                deptDistribution: [
                    {value: 10, name: '中國建築國際-中建香港-海宏技術有限公司-海宏公司團隊(駐深)-數字化提升部二部', itemStyle: {color: '#1890ff'}},
                    {value: 5, name: '中國建築國際-中建香港-房屋公司-房屋公司團隊（駐深）', itemStyle: {color: '#faad14'}},
                    {value: 7, name: '中國建築國際-中建澳門-总部部门-信息化管理部', itemStyle: {color: '#722ed1'}},
                    {value: 3, name: '中國建築國際-中建澳門-总部部门-信息化管理部', itemStyle: {color: '#bfbfbf'}}
                ]
            },
            5: {
                onlineUsers: 1,
                dailyVisits: 10,
                pendingApprovals: 1,
                authorizedUsers: 20,
                jobDistribution: [
                    {value: 2, name: '技术开发主任', itemStyle: {color: '#52c41a'}},
                    {value: 2, name: '助理技术开发主任', itemStyle: {color: '#13c2c2'}},
                    {value: 2, name: '助理总经理', itemStyle: {color: '#eb2f96'}},
                    {value: 5, name: '助理技术开发经理', itemStyle: {color: '#faad14'}},
                    {value: 9, name: '高级Java开发工程师', itemStyle: {color: '#2C4CDD'}}
                ],
                deptDistribution: [
                    {value: 5, name: '中國建築國際-中建香港-海宏技術有限公司-海宏公司團隊(駐深)-數字化提升部二部', itemStyle: {color: '#1890ff'}},
                    {value: 2, name: '中國建築國際-中建香港-房屋公司-房屋公司團隊（駐深）', itemStyle: {color: '#faad14'}},
                    {value: 6, name: '中國建築國際-中建澳門-总部部门-信息化管理部', itemStyle: {color: '#722ed1'}},
                    {value: 7, name: '中國建築國際-中建澳門-总部部门-信息化管理部', itemStyle: {color: '#bfbfbf'}}
                ]
            }
        };
        
        // 平台选择相关逻辑
        document.addEventListener('DOMContentLoaded', function() {
            // 获取DOM元素
            const selectAllCheckbox = document.getElementById('selectAllPlatforms');
            const platformOptions = document.querySelectorAll('.platform-option');
            const queryButton = document.getElementById('queryPlatformData');
            
            const multiSelectHeader = document.getElementById('platformSelectHeader');
            const multiSelectDropdown = document.getElementById('platformSelectDropdown');
            const selectedTextSpan = multiSelectHeader.querySelector('.selected-text');
            
            // 点击头部打开/关闭下拉框
            multiSelectHeader.addEventListener('click', function(e) {
                e.stopPropagation();
                multiSelectHeader.classList.toggle('active');
                multiSelectDropdown.classList.toggle('visible');
            });
            
            // 点击其他地方关闭下拉框
            document.addEventListener('click', function() {
                multiSelectHeader.classList.remove('active');
                multiSelectDropdown.classList.remove('visible');
            });
            
            // 防止点击下拉框内部时关闭下拉框
            multiSelectDropdown.addEventListener('click', function(e) {
                e.stopPropagation();
            });
            
            // 全选/取消全选
            selectAllCheckbox.addEventListener('change', function() {
                platformOptions.forEach(option => {
                    option.checked = this.checked;
                    option.disabled = this.checked;
                });
                
                // 更新选中文本
                updateSelectedText();
            });
            
            // 单个平台选择时更新全选状态
            platformOptions.forEach(option => {
                option.addEventListener('change', function() {
                    // 如果取消勾选某个平台，则取消全选
                    if (!this.checked && selectAllCheckbox.checked) {
                        selectAllCheckbox.checked = false;
                        platformOptions.forEach(opt => {
                            opt.disabled = false;
                        });
                    }
                    
                    // 如果所有平台都被选中，则自动勾选全选
                    const allSelected = Array.from(platformOptions).every(opt => opt.checked);
                    if (allSelected) {
                        selectAllCheckbox.checked = true;
                        platformOptions.forEach(opt => {
                            opt.disabled = true;
                        });
                    }
                    
                    // 更新选中文本
                    updateSelectedText();
                });
            });
            
            // 更新选中平台的显示文本
            function updateSelectedText() {
                if (selectAllCheckbox.checked) {
                    selectedTextSpan.textContent = '全部';
                    return;
                }
                
                const selectedPlatforms = Array.from(platformOptions)
                    .filter(option => option.checked)
                    .map(option => {
                        // 通过查找相邻文本获取平台名称
                        return option.parentNode.textContent.trim();
                    });
                
                if (selectedPlatforms.length === 0) {
                    selectedTextSpan.textContent = '请选择平台';
                } else if (selectedPlatforms.length <= 2) {
                    selectedTextSpan.textContent = selectedPlatforms.join('、');
                } else {
                    selectedTextSpan.textContent = `已选择 ${selectedPlatforms.length} 个平台`;
                }
            }
            
            // 查询按钮点击事件
            queryButton.addEventListener('click', function() {
                // 关闭下拉框
                multiSelectHeader.classList.remove('active');
                multiSelectDropdown.classList.remove('visible');
                
                updateDashboard();
            });
            
            // 初始加载时更新仪表盘
            updateDashboard();
        });
        
        // 根据选择的平台更新仪表盘数据
        function updateDashboard() {
            const selectAllCheckbox = document.getElementById('selectAllPlatforms');
            const platformOptions = document.querySelectorAll('.platform-option');
            
            // 如果选择了"全部"，直接使用全部数据
            if (selectAllCheckbox.checked) {
                updateStatCards(platformData.all);
                updatePieCharts(platformData.all);
                updateComparisonCharts(Object.keys(platformData).filter(key => key !== 'all'));
                return;
            }
            
            // 获取选中的平台
            const selectedPlatforms = Array.from(platformOptions)
                .filter(option => option.checked)
                .map(option => option.value);
            
            // 如果没有选择平台，显示提示并返回
            if (selectedPlatforms.length === 0) {
                alert('请至少选择一个平台');
                return;
            }
            
            // 合并选中平台的数据
            const mergedData = mergeSelectedPlatformsData(selectedPlatforms);
            
            // 更新统计卡片和饼图
            updateStatCards(mergedData);
            updatePieCharts(mergedData);
            
            // 更新对比图表
            updateComparisonCharts(selectedPlatforms);
        }
        
        // 合并选中平台的数据
        function mergeSelectedPlatformsData(platforms) {
            // 初始化合并后的数据结构
            const merged = {
                onlineUsers: 0,
                dailyVisits: 0,
                pendingApprovals: 0,
                authorizedUsers: 0,
                jobDistribution: [],
                deptDistribution: []
            };
            
            // 合并数字统计
            platforms.forEach(platform => {
                const data = platformData[platform];
                merged.onlineUsers += data.onlineUsers;
                merged.dailyVisits += data.dailyVisits;
                merged.pendingApprovals += data.pendingApprovals;
                merged.authorizedUsers += data.authorizedUsers;
            });
            
            // 合并岗位分布数据
            const jobCategories = ['技术开发主任', '助理技术开发主任', '助理总经理', '助理技术开发经理', '高级Java开发工程师'];
            const jobColors = ['#52c41a', '#13c2c2', '#eb2f96', '#faad14', '#2C4CDD'];
            
            jobCategories.forEach((category, index) => {
                const totalValue = platforms.reduce((sum, platform) => {
                    const categoryData = platformData[platform].jobDistribution.find(item => item.name === category);
                    return sum + (categoryData ? categoryData.value : 0);
                }, 0);
                
                merged.jobDistribution.push({
                    value: totalValue,
                    name: category,
                    itemStyle: {color: jobColors[index]}
                });
            });
            
            // 合并部门分布数据
            const deptCategories = ['中國建築國際-中建香港-海宏技術有限公司-海宏公司團隊(駐深)-數字化提升部二部', '中國建築國際-中建香港-房屋公司-房屋公司團隊（駐深）', '中國建築國際-中建澳門-总部部门-信息化管理部', '中國建築國際-中建澳門-总部部门-信息化管理部'];
            const deptColors = ['#1890ff', '#faad14', '#722ed1', '#bfbfbf'];
            
            deptCategories.forEach((category, index) => {
                const totalValue = platforms.reduce((sum, platform) => {
                    const categoryData = platformData[platform].deptDistribution.find(item => item.name === category);
                    return sum + (categoryData ? categoryData.value : 0);
                }, 0);
                
                merged.deptDistribution.push({
                    value: totalValue,
                    name: category,
                    itemStyle: {color: deptColors[index]}
                });
            });
            
            return merged;
        }
        
        // 更新统计卡片
        function updateStatCards(data) {
            document.querySelector('.stat-value:nth-child(1)').textContent = data.onlineUsers;
            document.querySelector('.dashboard-stats .stat-card:nth-child(2) .stat-value').textContent = data.dailyVisits;
            document.querySelector('.dashboard-stats .stat-card:nth-child(3) .stat-value').textContent = data.pendingApprovals;
            document.querySelector('.dashboard-stats .stat-card:nth-child(4) .stat-value').textContent = data.authorizedUsers;
        }
        
        // 更新饼图 (原updateCharts函数改名)
        function updatePieCharts(data) {
            // 更新岗位分布饼图
            const jobChart = echarts.getInstanceByDom(document.getElementById('jobDistributionChart'));
            if (jobChart) {
                jobChart.setOption({
                    series: [{
                        data: data.jobDistribution
                    }]
                });
            }
            
            // 更新部门分布饼图
            const deptChart = echarts.getInstanceByDom(document.getElementById('userDistributionChart'));
            if (deptChart) {
                deptChart.setOption({
                    series: [{
                        data: data.deptDistribution
                    }]
                });
            }
        }

        // 初始化动态排序折线图
        function initRegistrationTrendChart() {
            const chartDom = document.getElementById('registrationTrendChart');
            if (!chartDom) return;
            
            const myChart = echarts.init(chartDom);
            
            // 平台列表
            const platforms = [
                '第一平台',
                '第二平台'
            ];
            
            // 平台颜色映射
            const platformColors = {
                '第一平台': '#1890ff',
                '第二平台': '#52c41a',
                '第三平台': '#faad14',
                '第四平台': '#f5222d',
                '第五平台': '#722ed1'
            };
            
            // 生成模拟数据 - 30天的各平台注册人数
            const generateMockData = () => {
                const now = new Date('2025-04-23'); // 固定日期，避免每次刷新变化
                const data = [];
                
                // 为每个平台生成基础趋势
                const baseTrends = {
                    '第一平台': { base: 150, growth: 1.3, variance: 20 },
                    '第二平台': { base: 100, growth: 1.3, variance: 15 },
                    '第三平台': { base: 70, growth: 1.3, variance: 10 },
                    '第四平台': { base: 40, growth: 1.2, variance: 8 },
                    '第五平台': { base: 20, growth: 1.1, variance: 5 }
                };
                
                // 生成30天的数据
                for (let i = 29; i >= 0; i--) {
                    const date = new Date(now);
                    date.setDate(date.getDate() - i);
                    const dateStr = date.toISOString().slice(0, 10);
                    
                    platforms.forEach(platform => {
                        const trend = baseTrends[platform];
                        const dayNum = 30 - i;
                        
                        // 计算当天注册数（基础值 + 增长 + 随机波动）
                        const base = trend.base;
                        const growth = Math.pow(trend.growth, dayNum / 5); // 使增长更加平滑
                        const variance = Math.random() * trend.variance * 2 - trend.variance;
                        
                        const registrations = Math.floor(base * growth + variance);
                        
                        data.push({
                            Date: dateStr,
                            Platform: platform,
                            Registrations: Math.max(1, registrations) // 确保至少有1个注册
                        });
                    });
                }
                
                return data;
            };
            
            const rawData = generateMockData();
            
            // 在创建系列之前，预先计算每个平台最后一天的数据
            const lastDayData = {};
            platforms.forEach(platform => {
                const platformData = rawData.filter(d => d.Platform === platform);
                const sortedData = platformData.sort((a, b) => new Date(b.Date) - new Date(a.Date));
                lastDayData[platform] = sortedData[0].Registrations;
            });
            
            // 为每个平台创建数据集和系列
            const datasetWithFilters = [];
            const seriesList = [];
            
            platforms.forEach(platform => {
                const datasetId = 'dataset_' + platform.replace(/\s+/g, '_');
                
                datasetWithFilters.push({
                    id: datasetId,
                    fromDatasetId: 'dataset_raw',
                    transform: {
                        type: 'filter',
                        config: {
                            dimension: 'Platform', 
                            '=': platform
                        }
                    }
                });
                
                seriesList.push({
                    type: 'line',
                    datasetId: datasetId,
                    showSymbol: false,
                    name: platform,
                    // 指定线条颜色，保持一致性
                    lineStyle: {
                        color: platformColors[platform]
                    },
                    itemStyle: {
                        color: platformColors[platform]
                    },
                    endLabel: {
                        show: true,
                        formatter: function(params) {
                            // 更健壮的数据提取方式
                            let registrationValue;
                            
                            // 检查不同可能的数据结构
                            if (typeof params.value === 'object') {
                                if (params.value.Registrations !== undefined) {
                                    // 如果是对象格式 {Date, Platform, Registrations}
                                    registrationValue = params.value.Registrations;
                                } else if (Array.isArray(params.value) && params.value.length > 2) {
                                    // 如果是数组格式 [Date, Platform, Registrations]
                                    registrationValue = params.value[2];
                                } else {
                                    // 备用，尝试从原始数据中获取
                                    const lastData = rawData.filter(d => 
                                        d.Platform === platform).sort((a, b) => 
                                        new Date(b.Date) - new Date(a.Date))[0];
                                    
                                    registrationValue = lastData ? lastData.Registrations : '';
                                }
                            } else {
                                // 直接使用值
                                registrationValue = params.value;
                            }
                            
                            return platform + ': ' + (registrationValue !== undefined ? registrationValue : '');
                        },
                        backgroundColor: '#fff',
                        padding: [3, 5],
                        borderRadius: 3,
                        shadowColor: 'rgba(0, 0, 0, 0.1)',
                        shadowBlur: 3
                    },
                    labelLayout: {
                        moveOverlap: 'shiftY',
                        draggable: true
                    },
                    emphasis: {
                        focus: 'series'
                    },
                    encode: {
                        x: 'Date',
                        y: 'Registrations',
                        label: ['Platform', 'Registrations'],
                        itemName: 'Date',
                        tooltip: ['Registrations']
                    }
                });
            });
            
            const option = {
                animationDuration: 300,
                dataset: [
                    {
                        id: 'dataset_raw',
                        source: rawData
                    },
                    ...datasetWithFilters
                ],
                title: {
                    text: '近30天注册人数变化趋势',
                    left: 'center'
                },
                tooltip: {
                    order: 'valueDesc',
                    trigger: 'axis',
                    formatter: function(params) {
                        let result = params[0].axisValue + '<br>';
                        
                        // 按数值从大到小排序
                        params.sort((a, b) => {
                            // 修复：确保我们获取的是数字而不是undefined
                            const valueA = typeof a.value[2] === 'number' ? a.value[2] : a.value.Registrations;
                            const valueB = typeof b.value[2] === 'number' ? b.value[2] : b.value.Registrations;
                            return valueB - valueA;
                        });
                        
                        params.forEach(param => {
                            // 修复：根据数据结构正确获取值
                            const value = typeof param.value[2] === 'number' ? 
                                          param.value[2] : 
                                          (param.value.Registrations !== undefined ? 
                                           param.value.Registrations : 
                                           param.value);
                            
                            const colorSpan = `<span style="display:inline-block;margin-right:5px;border-radius:10px;width:10px;height:10px;background-color:${param.color};"></span>`;
                            result += colorSpan + param.seriesName + ': ' + value + '<br>';
                        });
                        
                        return result;
                    }
                },
                xAxis: {
                    type: 'category',
                    nameLocation: 'middle',
                    axisLabel: {
                        formatter: function(value) {
                            // 只显示月和日
                            const date = new Date(value);
                            return (date.getMonth() + 1) + '-' + date.getDate();
                        }
                    }
                },
                yAxis: {
                    name: '注册人数',
                    nameTextStyle: {
                        padding: [0, 0, 0, 40]  // 增加名称与轴的距离
                    }
                },
                grid: {
                    right: 140,
                    left: 80,
                    bottom: 80
                },
                legend: {
                    type: 'scroll',
                    orient: 'horizontal',
                    bottom: 10,
                    textStyle: {
                        color: '#333'
                    },
                    selectedMode: true
                },
                series: seriesList
            };
            
            myChart.setOption(option);
            
            // 改为使用 rendered 事件，在渲染完成后修复 endLabel
            myChart.on('rendered', function() {
                // 确保图表已正确渲染并包含所有数据点
                platforms.forEach((platform, index) => {
                    // 获取对应平台的最后一天数据
                    const lastDayValue = lastDayData[platform];
                    
                    // 在动画完成后，设置固定的endLabel
                    myChart.setOption({
                        series: [{
                            name: platform,
                            endLabel: {
                                show: true,
                                formatter: platform + ': ' + lastDayValue,
                                backgroundColor: '#fff',
                                padding: [3, 5],
                                borderRadius: 3,
                                shadowColor: 'rgba(0, 0, 0, 0.1)',
                                shadowBlur: 3
                            }
                        }]
                    }, {replaceMerge: false, notMerge: false});
                });
            });
            
            // 添加到window.resize事件处理中
            if (window.echartInstances) {
                window.echartInstances.push(myChart);
            } else {
                window.echartInstances = [myChart];
            }
        }
    </script>
</body>
</html> 