<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>耀耀工厂 - 权限管理后台</title>
    <link rel="stylesheet" href="permission-admin.css">
    <style>
        /* 添加到现有样式表或添加到<head>部分 */
        .action-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* 可以添加实际禁用状态的样式 */
        .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* 添加一个样式，用于当复选框处于indeterminate状态时更改外观 */
        input[type="checkbox"]:indeterminate {
            background-color: #e0e0e0;
            border-color: #999;
        }
        
        /* 添加到现有样式 */
        input[type="checkbox"]:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background-color: #f0f0f0;
        }
        
        /* 可以为已处理行添加一个轻微的背景色 */
        #approval-tab tbody tr:has(td:nth-child(9) .status-approved),
        #approval-tab tbody tr:has(td:nth-child(9) .status-rejected) {
            background-color: #f9f9f9;
        }

        /* 状态标签 - 恢复原始样式 */
        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 2px;
            font-size: 12px;
        }

        .status-pending {
            background-color: #faad14;
            color: white;
        }

        .status-approved {
            background-color: #52c41a;
            color: white;
        }

        .status-rejected {
            background-color: #f5222d;
            color: white;
        }
        
        /* 参考system-logs.css中的detail-remarks样式 */
        .detail-remarks {
            background-color: #f8f9fa;
            border-radius: 4px;
            padding: 12px;
            font-size: 14px;
            color: #666;
            line-height: 1.5;
            margin-top: 6px;
            border-left: 3px solid #e6f7ff;
        }
        
        /* 申请原因样式 */
        .detail-section:nth-of-type(2) .detail-remarks {
            border-left-color: #faad14;
            background-color: #fffbe6;
        }
        
        /* 审批通过备注样式 */
        .detail-section:nth-of-type(3) .detail-remarks.approved {
            border-left-color: #52c41a;
            background-color: #f6ffed;
        }
        
        /* 审批拒绝理由样式 */
        .detail-section:nth-of-type(3) .detail-remarks.rejected {
            border-left-color: #f5222d;
            background-color: #fff1f0;
        }
        
        /* 批量操作按钮禁用状态样式 */
        .batch-actions .action-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }
        
        /* 数量指示器样式 */
        .count-indicator {
            display: inline-block;
            background-color: #1890ff;
            color: white;
            border-radius: 12px;
            padding: 0px 8px;
            font-size: 12px;
            line-height: 20px;
            margin-left: 5px;
            vertical-align: middle;
        }
        
        /* 优化登录记录表格样式 */
        .detail-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            table-layout: fixed;
        }
        
        .detail-table th, 
        .detail-table td {
            border: 1px solid #f0f0f0;
            padding: 8px 12px;
            text-align: left;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .detail-table th {
            background-color: #fafafa;
            font-weight: 500;
            color: #666;
        }
        
        /* 设置列宽度 */
        .detail-table th:first-child,
        .detail-table td:first-child {
            width: 40%;  /* 登录时间列宽 */
        }
        
        .detail-table th:nth-child(2),
        .detail-table td:nth-child(2) {
            width: 35%;  /* 登录设备列宽 */
        }
        
        .detail-table th:last-child,
        .detail-table td:last-child {
            width: 25%;  /* IP地址列宽 */
        }
        
        .detail-table tbody tr:hover {
            background-color: #f5f7fa;
        }
        
        /* 分页选择器样式 */
        .pagination-options {
            display: flex;
            align-items: center;
            margin-right: 15px;
        }
        
        .pagination-options select {
            margin: 0 5px;
            padding: 5px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            background-color: white;
            font-size: 14px;
        }
        
        .pagination-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
        }
        
        .pagination {
            display: flex;
        }
        
        /* 管理平台多选框样式 */
        #manage-platform-select {
            width: 100%;
        }
        
        #manage-platform-select .multi-select-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            background-color: white;
            cursor: pointer;
        }
        
        #manage-platform-select .multi-select-header.active {
            border-color: #1890ff;
            box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.2);
        }
        
        #manage-platform-select .multi-select-dropdown {
            display: none;
            position: absolute;
            width: 100%;
            max-height: 250px;
            overflow-y: auto;
            background-color: white;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            margin-top: 2px;
            z-index: 100;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }
        
        #manage-platform-select .multi-select-dropdown.active {
            display: block;
        }
        
        #manage-platform-select .multi-select-option {
            padding: 8px 12px;
            cursor: pointer;
        }
        
        #manage-platform-select .multi-select-option:hover {
            background-color: #f5f5f5;
        }
        
        #manage-platform-select .multi-select-option input {
            margin-right: 8px;
        }
        
        /* 强制管理平台多选框在平台管理员角色选中时显示 */
        #add-user-modal input[name="role"][value="platform-admin"]:checked ~ #step-confirm .form-group:has(#manage-platform-select) {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
        
        /* 确保管理平台下拉框的样式正确 */
        #manage-platform-select {
            position: relative;
            width: 100%;
        }
        
        #manage-platform-select .multi-select-dropdown {
            width: 100%;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- 侧边栏 -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <img src="logo.png" alt="耀耀工厂">
                </div>
                <h2>耀耀工厂</h2>
            </div>
            <div class="sidebar-nav">
                <a href="dashboard.html" class="nav-item">
                    <i>📊</i>
                    <span>系统概览</span>
                </a>
                <a href="permission-admin.html" class="nav-item active">
                    <i>🔑</i>
                    <span>权限管理</span>
                </a>
                <a href="system-logs.html" class="nav-item">
                    <i>📝</i>
                    <span>系统日志</span>
                </a>
            </div>
        </div>

        <!-- 主内容区域 -->
        <div class="main-content">
            <!-- 顶部导航 -->
            <div class="top-nav">
                <div class="breadcrumb">
                    权限管理
                </div>
                <div class="user-profile">
                    <div class="user-info" onclick="toggleUserMenu()">
                        <div class="avatar">戴</div>
                        <span class="username">管理员-戴倚凡</span>
                        <i class="dropdown-icon">▼</i>
                    </div>
                    <div class="user-menu" id="userMenu">
                        <div class="menu-item" onclick="logout()">
                            <i class="menu-icon">↩</i>
                            <span>退出登录</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 标签页 -->
            <div class="tabs">
                <div class="tab-item" onclick="showTab('approval')">权限审批</div>
                <div class="tab-item active" onclick="showTab('authorized')">已授权用户</div>
<!--                <div class="tab-item" onclick="showTab('active')">当前登录用户</div>-->
            </div>

            <!-- 权限审批内容卡片 -->
            <div id="approval-tab" class="card tab-content" style="display: none;">
                <div class="card-header">
                    <h3 class="card-title">权限申请列表</h3>
                </div>
                <div class="card-body">
                    <!-- 筛选区域 -->
                    <div class="filter-area">
                        <div class="filter-item">
                            <label>姓名:</label>
                            <input type="text" placeholder="请输入姓名">
                        </div>
                        <div class="filter-item">
                            <label>域账号:</label>
                            <input type="text" placeholder="请输入域账号">
                        </div>
                        <div class="filter-item">
                            <label>部门:</label>
                            <select>
                                <option value="">全部</option>
                                <option value="info">中國建築國際-信息化管理部</option>
                                <option value="house">中國建築國際-中建香港-房屋公司-房屋公司團隊（駐深）</option>
                                <option value="haihong">中國建築國際-中建香港-海宏技術有限公司-海宏公司團隊(駐深)-數字化提升部二部</option>
                                <option value="hr">中國建築國際-中建香港-中國建築國際-中建香港-中國建築國際-中建香港-中國建築國際-中建香港-人力资源部部部部</option>
                                <option value="finance">中國建築國際-金融業務部</option>
                                <option value="macau">中國建築國際-中建澳門-总部部门-信息化管理部</option>
                            </select>
                        </div>
                        <div class="filter-item">
                            <label>申请时间:</label>
                            <input type="date" class="date-picker">
                            <span class="date-separator">至</span>
                            <input type="date" class="date-picker">
                        </div>
                        <div class="filter-item">
                            <label>审批状态:</label>
                            <select>
                                <option value="">全部</option>
                                <option value="pending">待审批</option>
                                <option value="approved">已通过</option>
                                <option value="rejected">已拒绝</option>
                            </select>
                        </div>
                        <div class="filter-item">
                            <label>平台:</label>
                            <div class="multi-select" id="approval-platform-filter">
                                <div class="multi-select-header">
                                    <span>全部</span>
                                    <span class="arrow">▼</span>
                                </div>
                                <div class="multi-select-dropdown">
                                    <div class="multi-select-option">
                                        <input type="checkbox" value="一" checked> 第一平台
                                    </div>
                                    <div class="multi-select-option">
                                        <input type="checkbox" value="二" checked> 第二平台
                                    </div>
                                    <div class="multi-select-option">
                                        <input type="checkbox" value="三" checked> 第三平台
                                    </div>
                                    <div class="multi-select-option">
                                        <input type="checkbox" value="四" checked> 第四平台
                                    </div>
                                    <div class="multi-select-option">
                                        <input type="checkbox" value="五" checked> 第五平台
                                    </div>
                                </div>
                            </div>
                        </div>
<!--                        <div class="filter-item">-->
<!--                            <label>角色:</label>-->
<!--                            <div class="multi-select" id="approval-role-filter">-->
<!--                                <div class="multi-select-header">-->
<!--                                    <span>全部</span>-->
<!--                                    <span class="arrow">▼</span>-->
<!--                                </div>-->
<!--                                <div class="multi-select-dropdown">-->
<!--                                    <div class="multi-select-option">-->
<!--                                    <input type="checkbox" value="user" checked> 普通用户-->
<!--                                </div>-->
<!--                                    <div class="multi-select-option">-->
<!--                                    <input type="checkbox" value="platform-admin" checked> 平台管理员-->
<!--                                    </div>-->
<!--                                </div>-->
<!--                            </div>-->
<!--                        </div>-->
                        <div class="filter-item">
                            <button class="search-btn">搜索</button>
                            <button class="reset-btn">重置</button>
                        </div>
                    </div>

                    <!-- 批量操作 -->
                    <div class="batch-actions">
                        <button class="action-btn approve-btn">批量通过</button>
                        <button class="action-btn reject-btn">批量拒绝</button>
                    </div>

                    <!-- 表格内容 -->
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th><input type="checkbox"></th>
                                    <th>姓名</th>
                                    <th>域账号</th>
                                    <th>部门</th>
                                    <th>平台</th>
                                    <th>角色</th>
                                    <th>申请时间<span style="color: red">(默认倒序排列)</span></th>
                                    <th>申请理由</th>
                                    <th>状态</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><input type="checkbox"></td>
                                    <td>张三</td>
                                    <td>zhangsan</td>
                                    <td>中國建築國際-中建香港-海宏技術有限公司-海宏公司團隊(駐深)-數字化提升部二部</td>
                                    <td><span class="platform-badge platform-1">第一平台</span></td>
                                    <td><span class="role-badge role-user">普通用户</span></td>
                                    <td>2025-04-25 14:30</td>
                                    <td>需要使用AI工具提升工作效率</td>
                                    <td><span class="status status-pending">待审批</span></td>
                                    <td>
                                        <button class="action-btn view-btn">查看</button>
                                        <button class="action-btn approve-btn">通过</button>
                                        <button class="action-btn reject-btn">拒绝</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox"></td>
                                    <td>李四</td>
                                    <td>lisi</td>
                                    <td>中國建築國際-信息化管理部</td>
                                    <td><span class="platform-badge platform-2">第二平台</span></td>
                                    <td><span class="role-badge role-user">普通用户</span></td>
                                    <td>2025-04-24 10:15</td>
                                    <td>需要调研AI产品功能</td>
                                    <td><span class="status status-pending">待审批</span></td>
                                    <td>
                                        <button class="action-btn view-btn">查看</button>
                                        <button class="action-btn approve-btn">通过</button>
                                        <button class="action-btn reject-btn">拒绝</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox"></td>
                                    <td>王五</td>
                                    <td>wangwu</td>
                                    <td>中國建築國際-信息化管理部</td>
                                    <td><span class="platform-badge platform-3">第三平台</span></td>
                                    <td><span class="role-badge role-user">普通用户</span></td>
                                    <td>2025-04-23 10:00</td>
                                    <td>产品设计需要使用AI助手</td>
                                    <td><span class="status status-approved">已通过</span></td>
                                    <td>
                                        <button class="action-btn view-btn">查看</button>
                                        <!-- <button class="action-btn remove-btn">拒绝</button> -->
                                    </td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox"></td>
                                    <td>赵六</td>
                                    <td>zhaoliu</td>
                                    <td>中國建築國際-中建香港-中國建築國際-中建香港-中國建築國際-中建香港-人力资源部部部</td>
                                    <td><span class="platform-badge platform-4">第四平台</span></td>
                                    <td><span class="role-badge role-user">普通用户</span></td>
                                    <td>2025-04-22 09:30</td>
                                    <td>部门需开发问答智能体，烦请审批</td>
                                    <td><span class="status status-rejected">已拒绝</span></td>
                                    <td>
                                        <button class="action-btn view-btn">查看</button>
                                        <!-- <button class="action-btn approve-btn">通过</button> -->
                                    </td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox"></td>
                                    <td>钱七</td>
                                    <td>qianqi</td>
                                    <td>中國建築國際-中建香港-海宏技術有限公司-海宏公司團隊(駐深)-數字化提升部二部</td>
                                    <td><span class="platform-badge platform-5">第五平台</span></td>
                                    <td><span class="role-badge role-user">普通用户</span></td>
                                    <td>2025-04-21 09:30</td>
                                    <td>开发需要使用AI接口</td>
                                    <td><span class="status status-pending">待审批</span></td>
                                    <td>
                                        <button class="action-btn view-btn">查看</button>
                                        <button class="action-btn approve-btn">通过</button>
                                        <button class="action-btn reject-btn">拒绝</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- 分页 -->
                    <div class="pagination">
                        <button>&lt;</button>
                        <button class="active">1</button>
                        <button>2</button>
                        <button>3</button>
                        <button>&gt;</button>
                    </div>
                </div>
            </div>

            <!-- 已授权用户内容卡片 -->
            <div id="authorized-tab" class="card tab-content">
                <div class="card-header">
                    <h3 class="card-title">已授权用户列表</h3>
                    <button class="add-btn"  onclick="showAddUserModal()"">+ 添加用户权限</button>
                </div>
                <div class="card-body">
                    <!-- 筛选区域 -->
                    <div class="filter-area">
                        <div class="filter-item">
                            <label>姓名:</label>
                            <input type="text" placeholder="请输入姓名">
                        </div>
                        <div class="filter-item">
                            <label>域账号:</label>
                            <input type="text" placeholder="请输入域账号">
                        </div>
                        <div class="filter-item">
                            <label>部门:</label>
                            <select>
                                <option value="">全部</option>
                                <option value="info">中國建築國際-信息化管理部</option>
                                <option value="house">中國建築國際-中建香港-房屋公司-房屋公司團隊（駐深）</option>
                                <option value="haihong">中國建築國際-中建香港-海宏技術有限公司-海宏公司團隊(駐深)-數字化提升部二部</option>
                                <option value="hr">中國建築國際-中建香港-中國建築國際-中建香港-中國建築國際-中建香港-中國建築國際-中建香港-人力资源部部部部</option>
                                <option value="finance">中國建築國際-金融業務部</option>
                                <option value="macau">中國建築國際-中建澳門-总部部门-信息化管理部</option>
                            </select>
                        </div>
                        <div class="filter-item">
                            <label>授权时间:</label>
                            <input type="date" class="date-picker">
                            <span class="date-separator">至</span>
                            <input type="date" class="date-picker">
                        </div>
                        <div class="filter-item">
                            <label>平台:</label>
                            <div class="multi-select" id="authorized-platform-filter">
                                <div class="multi-select-header">
                                    <span>全部</span>
                                    <span class="arrow">▼</span>
                                </div>
                                <div class="multi-select-dropdown">
                                    <div class="multi-select-option">
                                        <input type="checkbox" value="一" checked> 第一平台
                                    </div>
                                    <div class="multi-select-option">
                                        <input type="checkbox" value="二" checked> 第二平台
                                    </div>
                                    <div class="multi-select-option">
                                        <input type="checkbox" value="三" checked> 第三平台
                                    </div>
                                    <div class="multi-select-option">
                                        <input type="checkbox" value="四" checked> 第四平台
                                    </div>
                                    <div class="multi-select-option">
                                        <input type="checkbox" value="五" checked> 第五平台
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="filter-item">
                            <label>角色:</label>
                            <div class="multi-select" id="authorized-role-filter">
                                <div class="multi-select-header">
                                    <span>全部</span>
                                    <span class="arrow">▼</span>
                                </div>
                                <div class="multi-select-dropdown">
                                    <div class="multi-select-option">
                                        <input type="checkbox" value="user" checked> 普通用户
                                    </div>
                                    <div class="multi-select-option">
                                        <input type="checkbox" value="platform-admin" checked> 平台管理员
                                    </div>
                                    <div class="multi-select-option">
                                        <input type="checkbox" value="admin" checked> 超级管理员
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="filter-item filter-buttons">
                            <button class="search-btn">搜索</button>
                            <button class="reset-btn">重置</button>
                        </div>
                    </div>

                    <!-- 添加批量操作区域 -->
                    <div class="batch-actions">
                        <button class="action-btn remove-btn">批量收回权限</button>
                    </div>

                    <!-- 表格内容 -->
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th><input type="checkbox"></th>
                                    <th>姓名</th>
                                    <th>域账号</th>
                                    <th>部门</th>
                                    <th>平台</th>
                                    <th>角色</th>
                                    <th>授权时间<span style="color: red">(默认倒序排列)</span></th>
                                    <th>最近登录</th>
<!--                                    <th>访问次数</th>-->
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><input type="checkbox"></td>
                                    <td>张三</td>
                                    <td>zhangsan</td>
                                    <td>中國建築國際-中建香港-海宏技術有限公司-海宏公司團隊(駐深)-數字化提升部二部</td>
                                    <td><span class="platform-badge platform-1">第一平台</span></td>
                                    <td><span class="role-badge role-user">普通用户</span></td>
                                    <td>2025-04-25 08:28</td>
                                    <td>2025-04-25 14:30</td>
<!--                                    <td>42次</td>-->
                                    <td>
                                        <button class="action-btn view-btn">查看</button>
                                        <button class="action-btn remove-btn">收回权限</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox"></td>
                                    <td>李四</td>
                                    <td>lisi</td>
                                    <td>中國建築國際-信息化管理部</td>
                                    <td><span class="platform-badge platform-2">第二平台</span><span class="platform-badge platform-3">第三平台</span></td>
                                    <td><span class="role-badge role-platform-admin">平台管理员</span></td>
                                    <td>2025-04-24 08:28</td>
                                    <td>2025-04-25 08:31</td>
<!--                                    <td>68次</td>-->
                                    <td>
                                        <button class="action-btn view-btn">查看</button>
                                        <button class="action-btn remove-btn">收回权限</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox"></td>
                                    <td>王五</td>
                                    <td>wangwu</td>
                                    <td>中國建築國際-中建澳門-总部部门-信息化管理部</td>
                                    <td><span class="platform-badge platform-3">第三平台</span></td>
                                    <td><span class="role-badge role-user">普通用户</span></td>
                                    <td>2025-04-23 08:28</td>
                                    <td>2025-04-24 18:20</td>
<!--                                    <td>126次</td>-->
                                    <td>
                                        <button class="action-btn view-btn">查看</button>
                                        <button class="action-btn remove-btn">收回权限</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox"></td>
                                    <td>赵六</td>
                                    <td>zhaoliu</td>
                                    <td>中國建築國際-中建香港-中國建築國際-中建香港-中國建築國際-中建香港-人力资源部部部</td>
                                    <td><span class="platform-badge platform-4">第四平台</span></td>
                                    <td><span class="role-badge role-user">普通用户</span></td>
                                    <td>2025-04-22 08:28</td>
                                    <td>2025-04-25 12:11</td>
<!--                                    <td>18次</td>-->
                                    <td>
                                        <button class="action-btn view-btn">查看</button>
                                        <button class="action-btn remove-btn">收回权限</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox"></td>
                                    <td>钱七</td>
                                    <td>qianqi</td>
                                    <td>中國建築國際-中建香港-海宏技術有限公司-海宏公司團隊(駐深)-數字化提升部二部</td>
                                    <td><span class="platform-badge platform-5">第五平台</span></td>
                                    <td><span class="role-badge role-user">普通用户</span></td>
                                    <td>2025-04-21 08:28</td>
                                    <td>2025-04-24 11:30</td>
<!--                                    <td>24次</td>-->
                                    <td>
                                        <button class="action-btn view-btn">查看</button>
                                        <button class="action-btn remove-btn">收回权限</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- 分页 -->
                    <div class="pagination">
                        <button>&lt;</button>
                        <button class="active">1</button>
                        <button>2</button>
                        <button>3</button>
                        <button>&gt;</button>
                    </div>
                </div>
            </div>

            <!-- 当前登录用户内容卡片 -->
            <div id="active-tab" class="card tab-content" style="display: none;">
                <div class="card-header">
                    <h3 class="card-title">当前登录用户</h3>
                </div>
                <div class="card-body">
                    <!-- 筛选区域 -->
                    <div class="filter-area">
                        <div class="filter-item">
                            <label>姓名:</label>
                            <input type="text" placeholder="请输入姓名">
                        </div>
                        <div class="filter-item">
                            <label>域账号:</label>
                            <input type="text" placeholder="请输入域账号">
                        </div>
                        <div class="filter-item">
                            <label>部门:</label>
                            <select>
                                <option value="">全部</option>
                                <option value="info">中國建築國際-信息化管理部</option>
                                <option value="house">中國建築國際-中建香港-房屋公司-房屋公司團隊（駐深）</option>
                                <option value="haihong">中國建築國際-中建香港-海宏技術有限公司-海宏公司團隊(駐深)-數字化提升部二部</option>
                                <option value="hr">中國建築國際-中建香港-中國建築國際-中建香港-中國建築國際-中建香港-中國建築國際-中建香港-人力资源部部部部</option>
                                <option value="finance">中國建築國際-金融業務部</option>
                                <option value="macau">中國建築國際-中建澳門-总部部门-信息化管理部</option>
                            </select>
                        </div>
                        <div class="filter-item">
                            <label>平台:</label>
                            <div class="multi-select" id="platform-filter">
                                <div class="multi-select-header">
                                    <span>全部</span>
                                    <span class="arrow">▼</span>
                                </div>
                                <div class="multi-select-dropdown">
                                    <div class="multi-select-option">
                                        <input type="checkbox" value="一" checked> 第一平台
                                    </div>
                                    <div class="multi-select-option">
                                        <input type="checkbox" value="二" checked> 第二平台
                                    </div>
                                    <div class="multi-select-option">
                                        <input type="checkbox" value="三" checked> 第三平台
                                    </div>
                                    <div class="multi-select-option">
                                        <input type="checkbox" value="四" checked> 第四平台
                                    </div>
                                    <div class="multi-select-option">
                                        <input type="checkbox" value="五" checked> 第五平台
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="filter-item">
                            <label>角色:</label>
                            <div class="multi-select" id="role-filter">
                                <div class="multi-select-header">
                                    <span>全部</span>
                                    <span class="arrow">▼</span>
                                </div>
                                <div class="multi-select-dropdown">
                                    <div class="multi-select-option">
                                        <input type="checkbox" value="user" checked> 普通用户
                                    </div>
                                    <div class="multi-select-option">
                                        <input type="checkbox" value="platform-admin" checked> 平台管理员
                                    </div>
                                    <div class="multi-select-option">
                                        <input type="checkbox" value="admin" checked> 超级管理员
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="filter-item">
                            <label>登录时间:</label>
                            <input type="date" class="date-picker">
                            <span class="date-separator">至</span>
                            <input type="date" class="date-picker">
                        </div>
                        <div class="filter-item">
                            <button class="search-btn">搜索</button>
                            <button class="reset-btn">重置</button>
                        </div>
                    </div>

                    <!-- 添加批量操作区域 -->
                    <div class="batch-actions">
                        <button class="action-btn force-logout-btn">批量强制退出</button>
                    </div>

                    <!-- 表格内容 -->
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th><input type="checkbox"></th>
                                    <th>姓名</th>
                                    <th>域账号</th>
                                    <th>部门</th>
                                    <th>平台</th>
                                    <th>角色</th>
                                    <th>登录时间</th>
                                    <th>IP地址</th>
                                    <th>登录设备</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><input type="checkbox"></td>
                                    <td>张三</td>
                                    <td>zhangsan</td>
                                    <td>中國建築國際-中建香港-海宏技術有限公司-海宏公司團隊(駐深)-數字化提升部二部</td>
                                    <td><span class="platform-badge platform-1">第一平台</span></td>
                                    <td><span class="role-badge role-user">普通用户</span></td>
                                    <td>2024-10-15 14:30</td>
                                    <td>192.168.1.101</td>
                                    <td>Chrome Windows</td>
                                    <td>
                                        <button class="action-btn view-btn">查看</button>
                                        <button class="action-btn force-logout-btn">强制退出</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox"></td>
                                    <td>李四</td>
                                    <td>lisi</td>
                                    <td>中國建築國際-信息化管理部</td>
                                    <td><span class="platform-badge platform-2">第二平台</span></td>
                                    <td><span class="role-badge role-platform-admin">平台管理员</span></td>
                                    <td>2024-10-15 09:15</td>
                                    <td>192.168.1.102</td>
                                    <td>Safari MacOS</td>
                                    <td>
                                        <button class="action-btn view-btn">查看</button>
                                        <button class="action-btn force-logout-btn">强制退出</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox"></td>
                                    <td>王五</td>
                                    <td>wangwu</td>
                                    <td>中國建築國際-信息化管理部</td>
                                    <td><span class="platform-badge platform-3">第三平台</span></td>
                                    <td><span class="role-badge role-user">普通用户</span></td>
                                    <td>2024-10-15 10:45</td>
                                    <td>192.168.1.103</td>
                                    <td>Edge Windows</td>
                                    <td>
                                        <button class="action-btn view-btn">查看</button>
                                        <button class="action-btn force-logout-btn">强制退出</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox"></td>
                                    <td>赵六</td>
                                    <td>zhaoliu</td>
                                    <td>中國建築國際-中建香港-中國建築國際-中建香港-中國建築國際-中建香港-人力资源部部部</td>
                                    <td><span class="platform-badge platform-4">第四平台</span></td>
                                    <td><span class="role-badge role-user">普通用户</span></td>
                                    <td>2024-10-15 11:30</td>
                                    <td>192.168.1.104</td>
                                    <td>Firefox Linux</td>
                                    <td>
                                        <button class="action-btn view-btn">查看</button>
                                        <button class="action-btn force-logout-btn">强制退出</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox"></td>
                                    <td>钱七</td>
                                    <td>qianqi</td>
                                    <td>中國建築國際-中建香港-海宏技術有限公司-海宏公司團隊(駐深)-數字化提升部二部</td>
                                    <td><span class="platform-badge platform-5">第五平台</span></td>
                                    <td><span class="role-badge role-user">普通用户</span></td>
                                    <td>2024-10-15 08:30</td>
                                    <td>192.168.1.105</td>
                                    <td>Chrome Android</td>
                                    <td>
                                        <button class="action-btn view-btn">查看</button>
                                        <button class="action-btn force-logout-btn">强制退出</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 用户详情模态框 -->
            <div id="user-detail-modal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>用户详情</h3>
                        <button class="close-btn" onclick="closeModal('user-detail-modal')">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="user-info-section">
                            <h4>基本信息</h4>
                            <div class="info-grid">
                                <div class="info-item">
                                    <div class="info-label">姓名：</div>
                                    <div class="info-value name-value">张三</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">域账号：</div>
                                    <div class="info-value email-value">zhangsan</div>
                                    <!-- 原来可能是:
                                    <div class="info-label">工号：</div>
                                    <div class="info-value employeeId-value">ZH001</div>
                                    -->
                                </div>
                                <!-- 其他信息项... -->
                            </div>
                        </div>
                        <!-- 其他详情部分... -->
                    </div>
                </div>
            </div>

            <!-- 审批操作弹窗 -->
            <div id="approval-action-modal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>审批操作</h3>
                        <span class="close-btn">&times;</span>
                    </div>
                    <div class="modal-body">
                        <div class="approval-form">
                            <div class="form-group">
                                <label for="approval-comment">审批意见</label>
                                <textarea id="approval-comment" rows="3" placeholder="请输入您的审批意见..."></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="modal-btn submit-btn">提交</button>
                        <button class="modal-btn cancel-btn">关闭</button>
                    </div>
                </div>
            </div>

            <!-- 修改添加用户权限弹窗，改为先根据域账号查找用户，再确认添加 -->
            <div class="modal" id="add-user-modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>添加用户权限</h3>
                        <button class="close-btn" onclick="closeAddUserModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <form id="addUserForm">
                            <!-- 第一步：域账号搜索表单 -->
                            <div id="step-search" style="display: block;">
                                <div class="form-group">
                                    <label class="form-label required">用户域账号</label>
                                    <div class="email-search-container">
                                        <input type="text" class="form-input" id="search-email" placeholder="请输入企业域账号进行查找" required>
                                        <!-- <button type="button" class="search-user-btn" onclick="searchUserByEmail()">查找用户</button> -->
                                    </div>
                                    <span class="field-hint">请输入用户的完整企业域账号，将从企业IM系统中查找对应的用户信息</span>
                                </div>
                                <div id="email-search-message" class="search-message" style="display: none;"></div>
                            </div>

                            <!-- 第二步：用户信息确认和授权设置 -->
                            <div id="step-confirm" style="display: none;">
                                <div class="form-group">
                                    <div class="section-header">
                                        <label class="form-label">查找到的用户信息</label>
                                        <button type="button" class="back-btn" onclick="backToSearch()">返回重新查找</button>
                                    </div>
                                    <div class="user-info-card">
                                        <div class="user-avatar">
                                            <div class="avatar-placeholder">
                                                <span id="user-initials">--</span>
                                            </div>
                                        </div>
                                        <div class="user-details">
                                            <div class="detail-row">
                                                <span class="detail-label">姓名:</span>
                                                <span class="detail-value" id="user-name">--</span>
                                            </div>
                                            <div class="detail-row">
                                                <span class="detail-label">部门:</span>
                                                <span class="detail-value" id="user-department">--</span>
                                            </div>
                                            <div class="detail-row">
                                                <span class="detail-label">岗位:</span>
                                                <span class="detail-value" id="user-position">--</span>
                                            </div>
                                            <div class="detail-row">
                                                <span class="detail-label">域账号:</span>
                                                <span class="detail-value" id="user-email">--</span>
                                            </div>
                                            <!-- 添加所属平台 -->
                                            <div class="detail-row">
                                                <span class="detail-label">所属平台:</span>
                                                <span class="detail-value" id="user-platform">
                                                    <span class="platform-badge platform-1">第一平台</span>
                                                </span>
                                                <input type="hidden" name="platform" id="platform-input" value="1">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="confirm-message">
                                        <p>请确认以上用户信息是否正确，如不正确请返回重新查找</p>
                                    </div>
                                </div>
                                
                                <div class="form-group role-selection-group" id="roleSelectionGroup">
                                    <label class="form-label required">用户角色</label>
                                    <div class="role-options">
                                        <div class="role-option">
                                            <label class="role-option-label">
                                                <input type="radio" name="role" value="user" checked>
                                                <div>
                                                    <div class="role-option-title">普通用户</div>
                                                    <div class="role-option-desc">可以使用平台的基本功能，无管理权限</div>
                                                </div>
                                            </label>
                                        </div>
                                        <div class="role-option" id="platformAdminOption">
                                            <label class="role-option-label">
                                                <input type="radio" name="role" value="platform-admin">
                                                <div>
                                                    <div class="role-option-title">平台管理员</div>
                                                    <div class="role-option-desc">可以管理所在平台的用户和审批权限申请</div>
                                                </div>
                                            </label>
                                        </div>
                                    </div>
                                    <span class="field-hint">选择适合的用户角色，不同角色具有不同的权限</span>
                                    <span class="field-hint">只有超级管理员可以看到这项，平台管理员只能开通普通用户权限</span>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label required">管理平台</label>
                                    <div class="multi-select" id="manage-platform-select">
                                        <div class="multi-select-header">
                                            <span>选择管理平台</span>
                                            <span class="arrow">▼</span>
                                        </div>
                                        <div class="multi-select-dropdown">
                                            <div class="multi-select-option">
                                                <input type="checkbox" value="1" checked> 第一平台
                                            </div>
                                            <div class="multi-select-option">
                                                <input type="checkbox" value="2"> 第二平台
                                            </div>
                                            <div class="multi-select-option">
                                                <input type="checkbox" value="3"> 第三平台
                                            </div>
                                            <div class="multi-select-option">
                                                <input type="checkbox" value="4"> 第四平台
                                            </div>
                                            <div class="multi-select-option">
                                                <input type="checkbox" value="5"> 第五平台
                                            </div>
                                        </div>
                                    </div>
                                    <span class="field-hint">选择用户可以管理的平台，仅在角色为"平台管理员"时有效</span>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label required">授权备注</label>
                                    <textarea class="form-input" name="reason" placeholder="请详细说明授权原因、业务需求或用途..." required></textarea>
                                    <span class="field-hint">详细的说明有助于记录和追踪权限授予的原因，也便于以后的权限审计</span>
                                </div>
                            </div>
                            
                            <div class="form-actions">
                                <button type="button" class="btn btn-default" onclick="closeAddUserModal()">取消</button>
                                <button type="button" id="step-search-btn" class="btn btn-primary" style="display: none;" onclick="searchUserByEmail()">查找用户</button>
                                <button type="button" id="step-confirm-btn" class="btn btn-primary" style="display: none;" onclick="addUser()">确认添加</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 页面加载时显示默认标签页
        document.addEventListener('DOMContentLoaded', function() {
            // 修改默认显示为权限审批标签页
            showTab('approval');
            
            // 确保模态框初始隐藏
            const modal = document.getElementById('user-detail-modal');
            if (modal) {
                modal.style.display = 'none';
            }
            
            // 使用正确的选择器绑定查看按钮事件
            const viewButtons = document.querySelectorAll('.view-btn');
            viewButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // 获取当前行的数据
                    const row = this.closest('tr');
                    
                    // 确定当前是哪个标签页
                    const tabId = row.closest('.tab-content').id;
                    
                    // 根据标签页调用不同的详情展示函数
                    if (tabId === 'approval-tab') {
                        showApprovalDetails(row);
                    } else if (tabId === 'authorized-tab') {
                        showAuthorizedUserDetails(row);
                    } else if (tabId === 'active-tab') {
                        showActiveUserDetails(row);
                    }
                });
            });
            
            // 点击模态框外部关闭
            window.addEventListener('click', function(event) {
                const modal = document.getElementById('user-detail-modal');
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
            
            // 为每个分页组件添加页码选择器
            updatePaginationComponents();
        });

        function showTab(tabName) {
            // 隐藏所有tab内容
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.style.display = 'none';
            });
            
            // 显示选中的tab内容
            document.getElementById(tabName + '-tab').style.display = 'block';
            
            // 更新tab状态
            document.querySelectorAll('.tab-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // 找到对应的tab项并添加active类
            const tabs = document.querySelectorAll('.tab-item');
            switch(tabName) {
                case 'approval':
                    tabs[0].classList.add('active');
                    break;
                case 'authorized':
                    tabs[1].classList.add('active');
                    break;
                case 'active':
                    tabs[2].classList.add('active');
                    break;
            }
        }
        
        // 为标签项添加点击事件监听器
        document.querySelectorAll('.tab-item').forEach((tab, index) => {
            tab.addEventListener('click', function() {
                const tabNames = ['approval', 'authorized', 'active'];
                showTab(tabNames[index]);
            });
        });

        function toggleUserMenu() {
            const menu = document.getElementById('userMenu');
            if (menu.style.display === 'block') {
                menu.style.display = 'none';
            } else {
                menu.style.display = 'block';
            }
        }

        // 点击页面其他地方关闭菜单
        document.addEventListener('click', function(event) {
            const userInfo = document.querySelector('.user-info');
            const userMenu = document.getElementById('userMenu');
            
            if (!userInfo.contains(event.target) && userMenu.style.display === 'block') {
                userMenu.style.display = 'none';
            }
        }, true);

        function logout() {
            if (confirm('确定要退出登录吗？')) {
                window.location.href = 'login.html';
            }
        }

        // 完善审批通过操作函数
        function approveApproval(row, comment) {
            if (!row) return;
            
            // 1. 更新状态列
            const statusCell = row.querySelector('td:nth-child(9)');
            if (statusCell) {
                statusCell.innerHTML = '<span class="status status-approved">已通过</span>';
            }
            
            // 2. 移除拒绝按钮，并禁用复选框
            const actionsCell = row.querySelector('td:nth-child(10)');
            if (actionsCell) {
                // 保留查看按钮，移除其他按钮
                const viewBtn = actionsCell.querySelector('.view-btn');
                actionsCell.innerHTML = '';
                if (viewBtn) {
                    const newViewBtn = viewBtn.cloneNode(true);
                    actionsCell.appendChild(newViewBtn);
                }
            }
            
            // 3. 禁用复选框
            const checkbox = row.querySelector('td:first-child input[type="checkbox"]');
            if (checkbox) {
                checkbox.disabled = true;
                checkbox.checked = false;
                checkbox.parentElement.title = '已处理的审批单不可选择';
            }
            
            // 4. 记录审批意见（实际应该发送到后端）
            console.log('审批通过，意见：', comment || '无');
            
            // 5. 存储审批备注到行上的自定义属性，以便查看详情时显示
            row.setAttribute('data-approval-comment', comment || '');
            
            // 6. 更新表头复选框状态和批量操作按钮状态
            updateApprovalHeaderCheckboxState();
            updateBatchActionStatus('approval');
            
            // 7. 重新绑定查看按钮事件
            setupViewButtonEvents();
        }

        // 完善审批拒绝操作函数
        function rejectApproval(row, comment) {
            if (!row) return;
            
            // 1. 更新状态列
            const statusCell = row.querySelector('td:nth-child(9)');
            if (statusCell) {
                statusCell.innerHTML = '<span class="status status-rejected">已拒绝</span>';
            }
            
            // 2. 移除通过/拒绝按钮
            const actionsCell = row.querySelector('td:nth-child(10)');
            if (actionsCell) {
                // 保留查看按钮，移除其他按钮
                const viewBtn = actionsCell.querySelector('.view-btn');
                actionsCell.innerHTML = '';
                if (viewBtn) {
                    const newViewBtn = viewBtn.cloneNode(true);
                    actionsCell.appendChild(newViewBtn);
                }
            }
            
            // 3. 禁用复选框
            const checkbox = row.querySelector('td:first-child input[type="checkbox"]');
            if (checkbox) {
                checkbox.disabled = true;
                checkbox.checked = false;
                checkbox.parentElement.title = '已处理的审批单不可选择';
            }
            
            // 4. 记录审批意见（实际应该发送到后端）
            console.log('审批拒绝，理由：', comment || '无');
            
            // 5. 存储拒绝理由到行上的自定义属性，以便查看详情时显示
            row.setAttribute('data-rejection-reason', comment || '');
            
            // 6. 更新表头复选框状态和批量操作按钮状态
            updateApprovalHeaderCheckboxState();
            updateBatchActionStatus('approval');
            
            // 7. 重新绑定查看按钮事件
            setupViewButtonEvents();
        }

        // 更新表头复选框状态
        function updateApprovalHeaderCheckboxState() {
            const availableCheckboxes = document.querySelectorAll('#approval-tab table tbody td:first-child input[type="checkbox"]:not([disabled])');
            const checkedCheckboxes = document.querySelectorAll('#approval-tab table tbody td:first-child input[type="checkbox"]:checked:not([disabled])');
            const headerCheckbox = document.querySelector('#approval-tab table thead th:first-child input[type="checkbox"]');
            
            if (headerCheckbox && availableCheckboxes.length > 0) {
                const allChecked = Array.from(availableCheckboxes).every(cb => cb.checked);
                const anyChecked = Array.from(availableCheckboxes).some(cb => cb.checked);
                
                headerCheckbox.checked = allChecked;
                headerCheckbox.indeterminate = anyChecked && !allChecked;
            } else if (headerCheckbox) {
                // 如果没有可用的复选框，则取消选中表头复选框
                headerCheckbox.checked = false;
                headerCheckbox.indeterminate = false;
            }
            
            // 更新批量操作按钮状态
            updateBatchActionStatus('approval', checkedCheckboxes.length);
        }

        // 更新批量操作按钮状态
        function updateBatchActionStatus(tabName, checkedCount) {
            // 获取批量操作按钮
            const batchApproveBtn = document.querySelector(`#${tabName}-tab .batch-actions .approve-btn`);
            const batchRejectBtn = document.querySelector(`#${tabName}-tab .batch-actions .reject-btn`);
            
            if (batchApproveBtn && batchRejectBtn) {
                if (checkedCount > 0) {
                    // 有选中项，启用按钮并显示数量
                    batchApproveBtn.classList.remove('disabled');
                    batchRejectBtn.classList.remove('disabled');
                    
                    // 更新按钮文本，显示选中数量
                    batchApproveBtn.textContent = `批量通过 (${checkedCount})`;
                    batchRejectBtn.textContent = `批量拒绝 (${checkedCount})`;
                } else {
                    // 无选中项，禁用按钮
                    batchApproveBtn.classList.add('disabled');
                    batchRejectBtn.classList.add('disabled');
                    
                    // 恢复默认文本
                    batchApproveBtn.textContent = '批量通过';
                    batchRejectBtn.textContent = '批量拒绝';
                }
            }
        }

        // 批量审批操作
        function batchApprovalAction(action) {
            // 获取所有选中的未处理行
            const checkedRows = document.querySelectorAll('#approval-tab table tbody td:first-child input[type="checkbox"]:checked:not([disabled])');
            
            if (checkedRows.length === 0) {
                alert('请先选择待处理的申请');
                return;
            }
            
            // 显示批量审批模态框
            const modal = document.getElementById('approval-action-modal');
            if (!modal) return;
            
            // 设置模态框标题，添加选中数量显示
            modal.querySelector('.modal-header h3').innerHTML = formatBatchTitle(action, checkedRows.length);
            
            // 显示模态框
            modal.style.display = 'flex';
            
            // 聚焦到文本框
            setTimeout(() => {
                document.getElementById('approval-comment').focus();
            }, 100);
            
            // 保存当前批量操作类型和选中的行
            modal.dataset.action = action;
            modal.dataset.rows = Array.from(checkedRows).map(cb => {
                return Array.from(cb.closest('tr').parentNode.children).indexOf(cb.closest('tr'));
            }).join(',');
            
            // 将提交按钮的事件处理程序改为批量处理
            const submitBtn = modal.querySelector('.submit-btn');
            if (submitBtn) {
                // 移除现有的事件监听器（如果有）
                const newSubmitBtn = submitBtn.cloneNode(true);
                submitBtn.parentNode.replaceChild(newSubmitBtn, submitBtn);
                
                // 添加新的事件监听器
                newSubmitBtn.addEventListener('click', function() {
                    // 获取批量审批意见
                    const comment = document.getElementById('approval-comment').value.trim();
                    
                    // 获取选中的行索引
                    const rowIndices = modal.dataset.rows.split(',').map(Number);
                    const tbody = document.querySelector('#approval-tab table tbody');
                    const rows = tbody.querySelectorAll('tr');
                    
                    // 执行批量操作
                    rowIndices.forEach(index => {
                        if (index >= 0 && index < rows.length) {
                            const row = rows[index];
                            if (modal.dataset.action === 'approve') {
                                approveApproval(row, comment);
                            } else {
                                rejectApproval(row, comment);
                            }
                        }
                    });
                    
                    // 关闭模态框
                    modal.style.display = 'none';
                    
                    // 清空文本框
                    document.getElementById('approval-comment').value = '';
                    
                    // 显示操作成功消息
                    alert(`已${modal.dataset.action === 'approve' ? '批量通过' : '批量拒绝'} ${rowIndices.length} 条申请`);
                });
            }
        }

        // 为审批操作弹窗添加事件处理
        document.addEventListener('DOMContentLoaded', function() {
            // 获取单个审批按钮
            const approveButtons = document.querySelectorAll('#approval-tab .approve-btn:not(.batch-actions .approve-btn)');
            const rejectButtons = document.querySelectorAll('#approval-tab .reject-btn:not(.batch-actions .reject-btn)');
            
            // 为单个审批按钮添加事件监听器
            approveButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // 获取当前行
                    const row = this.closest('tr');
                    
                    // 获取审批模态框
                    const modal = document.getElementById('approval-action-modal');
                    if (!modal) return;
                    
                    // 设置模态框标题
                    modal.querySelector('.modal-header h3').textContent = '审批通过';
                    
                    // 显示模态框
                    modal.style.display = 'flex';
                    
                    // 聚焦到文本框
                    setTimeout(() => {
                        document.getElementById('approval-comment').focus();
                    }, 100);
                    
                    // 获取提交按钮
                    const submitBtn = modal.querySelector('.submit-btn');
                    if (submitBtn) {
                        // 移除现有的事件监听器
                        const newSubmitBtn = submitBtn.cloneNode(true);
                        submitBtn.parentNode.replaceChild(newSubmitBtn, submitBtn);
                        
                        // 添加新的事件监听器
                        newSubmitBtn.addEventListener('click', function() {
                            // 获取审批意见
                            const comment = document.getElementById('approval-comment').value.trim();
                            
                            // 执行审批通过操作
                            approveApproval(row, comment);
                            
                            // 关闭模态框
                            modal.style.display = 'none';
                            
                            // 清空文本框
                            document.getElementById('approval-comment').value = '';
                        });
                    }
                });
            });
            
            rejectButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // 获取当前行
                    const row = this.closest('tr');
                    
                    // 获取审批模态框
                    const modal = document.getElementById('approval-action-modal');
                    if (!modal) return;
                    
                    // 设置模态框标题
                    modal.querySelector('.modal-header h3').textContent = '审批拒绝';
                    
                    // 显示模态框
                    modal.style.display = 'flex';
                    
                    // 聚焦到文本框
                    setTimeout(() => {
                        document.getElementById('approval-comment').focus();
                    }, 100);
                    
                    // 获取提交按钮
                    const submitBtn = modal.querySelector('.submit-btn');
                    if (submitBtn) {
                        // 移除现有的事件监听器
                        const newSubmitBtn = submitBtn.cloneNode(true);
                        submitBtn.parentNode.replaceChild(newSubmitBtn, submitBtn);
                        
                        // 添加新的事件监听器
                        newSubmitBtn.addEventListener('click', function() {
                            // 获取审批意见
                            const comment = document.getElementById('approval-comment').value.trim();
                            
                            // 执行审批拒绝操作
                            rejectApproval(row, comment);
                            
                            // 关闭模态框
                            modal.style.display = 'none';
                            
                            // 清空文本框
                            document.getElementById('approval-comment').value = '';
                        });
                    }
                });
            });
            
            // 获取批量操作按钮
            const batchApproveBtn = document.querySelector('#approval-tab .batch-actions .approve-btn');
            const batchRejectBtn = document.querySelector('#approval-tab .batch-actions .reject-btn');
            
            // 为批量审批按钮添加事件监听器
            if (batchApproveBtn) {
                batchApproveBtn.addEventListener('click', function() {
                    batchApprovalAction('approve');
                });
            }
            
            if (batchRejectBtn) {
                batchRejectBtn.addEventListener('click', function() {
                    batchApprovalAction('reject');
                });
            }
            
            // 为关闭按钮添加事件
            const closeButtons = document.querySelectorAll('#approval-action-modal .close-btn, #approval-action-modal .cancel-btn');
            closeButtons.forEach(button => {
                button.addEventListener('click', function() {
                    document.getElementById('approval-action-modal').style.display = 'none';
                    document.getElementById('approval-comment').value = '';
                });
            });
            
            // 点击模态框外部关闭
            window.addEventListener('click', function(event) {
                const modal = document.getElementById('approval-action-modal');
                if (event.target === modal) {
                    modal.style.display = 'none';
                    document.getElementById('approval-comment').value = '';
                }
            });
        });

        // 修改 showAddUserModal 函数确保管理平台多选框在模态框打开时正确初始化
        function showAddUserModal() {
            const modal = document.getElementById('add-user-modal');
            
            // 重置表单状态
            document.getElementById('step-search').style.display = 'block';
            document.getElementById('step-confirm').style.display = 'none';
            document.getElementById('step-search-btn').style.display = 'block';
            document.getElementById('step-confirm-btn').style.display = 'none';
            
            // 清空域账号搜索框
            document.getElementById('search-email').value = '';
            
            // 隐藏搜索消息
            const searchMessage = document.getElementById('email-search-message');
            searchMessage.style.display = 'none';
            searchMessage.className = 'search-message';
            searchMessage.textContent = '';
            
            // 显示模态框
            modal.style.display = 'flex';
            
            // 初始化角色选择和管理平台下拉框
            setTimeout(() => {
                // 用setTimeout确保DOM已经完全渲染
                console.log('初始化角色选择和管理平台下拉框');
                initRoleSelection();
                
                // 确保管理平台表单组初始状态是隐藏的（因为默认选择普通用户）
                const managePlatformGroup = document.querySelector('#manage-platform-select').closest('.form-group');
                if (managePlatformGroup) {
                    console.log('确保管理平台表单组初始隐藏');
                    managePlatformGroup.style.display = 'none';
                }
            }, 100);
        }

        // 关闭添加用户弹窗
        function closeAddUserModal() {
            const modal = document.getElementById('add-user-modal');
            modal.style.display = 'none';
            
            // 重置表单
            document.getElementById('addUserForm').reset();
        }

        // 根据域账号查找用户
        function searchUserByEmail() {
            const email = document.getElementById('search-email').value.trim();
            const searchMessage = document.getElementById('email-search-message');
            
            // 验证域账号格式
            // if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
            //     searchMessage.className = 'search-message error';
            //     searchMessage.textContent = '请输入有效的企业域账号地址';
            //     searchMessage.style.display = 'block';
            //     return;
            // }
            
            // 显示加载状态
            searchMessage.className = 'search-message loading';
            searchMessage.textContent = '正在查询用户信息，请稍候...';
            searchMessage.style.display = 'block';
            
            // 模拟API请求延迟
            setTimeout(() => {
                // 这里是模拟的用户数据，实际应该从API获取
                const userData = mockSearchUserByEmail(email);
                
                if (userData) {
                    // 用户找到了，填充用户信息
                    populateUserInfo(userData);
                    
                    // 切换到第二步
                    document.getElementById('step-search').style.display = 'none';
                    document.getElementById('step-confirm').style.display = 'block';
                    document.getElementById('step-search-btn').style.display = 'none';
                    document.getElementById('step-confirm-btn').style.display = 'block';
                    
                    // 隐藏搜索消息
                    searchMessage.style.display = 'none';
                    
                    // 添加延迟确保DOM已更新
                    setTimeout(() => {
                        console.log('搜索成功，初始化角色选择');
                        
                        // 确保开始时选择普通用户
                        document.querySelector('#add-user-modal input[name="role"][value="user"]').checked = true;
                        
                        // 初始化角色选择（触发handleRoleChange）
                        initRoleSelection();
                        
                        // 确保管理平台多选框隐藏
                        const managePlatformGroup = document.querySelector('#manage-platform-select').closest('.form-group');
                        if (managePlatformGroup) {
                            managePlatformGroup.style.display = 'none';
                            console.log('确保管理平台表单组初始隐藏');
                        }
                        
                        // 为角色选项添加事件监听器
                        document.querySelectorAll('#add-user-modal input[name="role"]').forEach(radio => {
                            radio.addEventListener('change', function() {
                                console.log('角色选择变更:', this.value);
                                handleRoleChange();
                            });
                        });
                    }, 100);
                } else {
                    // 用户未找到
                    searchMessage.className = 'search-message error';
                    searchMessage.textContent = '未找到此域账号对应的用户，请检查域账号地址是否正确';
                    searchMessage.innerHTML += '<br>样例: zhangsan, lisi';
                    searchMessage.style.display = 'block';
                }
            }, 1000); // 模拟1秒延迟
        }

        // 模拟根据域账号搜索用户（实际实现中应该调用后端API）
        function mockSearchUserByEmail(email) {
            // 模拟的用户数据库
            const users = {
                'zhangsan': {
                    name: '张三',
                    employeeId: 'zhangsan',
                    department: '中國建築國際-信息化管理部',
                    position: '高级Java开发工程师',
                    email: 'zhangsan',
                    platform: '一'  // 添加平台信息
                },
                'lisi': {
                    name: '李四',
                    employeeId: 'lisi',
                    department: '中國建築國際-中建香港-房屋公司-房屋公司團隊（駐深）',
                    position: '高级Java开发工程师',
                    email: 'lisi',
                    platform: '二'  // 添加平台信息
                },
                'wangwu': {
                    name: '王五',
                    employeeId: 'wangwu',
                    department: '中國建築國際-中建香港-海宏技術有限公司-海宏公司團隊(駐深)-數字化提升部二部',
                    position: '高级Java开发工程师',
                    email: 'wangwu',
                    platform: '三'  // 添加平台信息
                },
                'zhaoliu': {
                    name: '赵六',
                    employeeId: 'zhaoliu',
                    department: '中國建築國際-中建香港-中國建築國際-中建香港-中國建築國際-中建香港-中國建築國際-中建香港-人力资源部部部部',
                    position: '高级Java开发工程师',
                    email: 'zhaoliu',
                    platform: '四'  // 添加平台信息
                },
                'qianqi': {
                    name: '钱七',
                    employeeId: 'qianqi',
                    department: '中國建築國際-金融業務部',
                    position: '高级Java开发工程师',
                    email: 'qianqi',
                    platform: '二'  // 添加平台信息
                },
                'liuer': {
                    name: '刘二',
                    employeeId: 'liuer',
                    department: '中國建築國際-中建澳門-总部部门-信息化管理部',
                    position: '高级Java开发工程师',
                    email: 'liuer',
                    platform: '三'  // 添加平台信息
                }
            };
            
            // 返回找到的用户或null
            return users[email] || null;
        }

        // 填充用户信息到确认页面
        function populateUserInfo(userData) {
            document.getElementById('user-name').textContent = userData.name;
            // document.getElementById('user-employeeId').textContent = userData.employeeId;
            document.getElementById('user-department').textContent = userData.department;
            document.getElementById('user-position').textContent = userData.position;
            document.getElementById('user-email').textContent = userData.email;
            
            // 设置用户的平台信息
            const platformElement = document.getElementById('user-platform');
            const platformInput = document.getElementById('platform-input');
            const platformNumber = userData.platform || '一'; // 如果未指定平台，默认为第一平台
            
            platformElement.innerHTML = `<span class="platform-badge platform-${platformNumber}">第${platformNumber}平台</span>`;
            platformInput.value = platformNumber;
            
            // 设置头像缩写
            if (userData.name) {
                const initials = userData.name.substring(0, 1);
                document.getElementById('user-initials').textContent = initials;
            }
        }

        // 返回到搜索步骤
        function backToSearch() {
            document.getElementById('step-search').style.display = 'block';
            document.getElementById('step-confirm').style.display = 'none';
            document.getElementById('step-search-btn').style.display = 'block';
            document.getElementById('step-confirm-btn').style.display = 'none';
        }

        // 添加用户（确认步骤后）
        function addUser() {
            // 获取用户信息
            const name = document.getElementById('user-name').textContent;
            const department = document.getElementById('user-department').textContent;
            const position = document.getElementById('user-position').textContent;
            const email = document.getElementById('user-email').textContent;
            
            // 获取授权信息
            const reason = document.querySelector('#add-user-modal textarea[name="reason"]').value.trim();
            
            // 获取平台和角色
            const platform = document.getElementById('platform-input').value;
            const role = document.querySelector('#add-user-modal input[name="role"]:checked').value;
            
            // 获取管理平台（只在角色为平台管理员时有效）
            const managePlatforms = [];
            if (role === 'platform-admin') {
                const platformCheckboxes = document.querySelectorAll('#manage-platform-select .multi-select-option input:checked');
                platformCheckboxes.forEach(checkbox => {
                    managePlatforms.push(checkbox.value);
                });
                
                // 验证至少选择了一个管理平台
                if (managePlatforms.length === 0) {
                    alert('请至少选择一个管理平台');
                    return;
                }
            }
            
            // 验证授权理由
            if (!reason) {
                alert('请填写授权备注');
                return;
            }
            
            // 构建添加用户数据
            const userData = {
                user: {
                    name: name,
                    department: department,
                    position: position,
                    email: email
                },
                reason: reason,
                platform: platform,
                role: role,
                managePlatforms: role === 'platform-admin' ? managePlatforms : [],
                addTime: new Date().toISOString()
            };
            
            console.log('添加用户权限数据:', userData);
            
            // 模拟添加成功 - 添加到已授权用户列表中
            const authorizedTable = document.querySelector('#authorized-tab table tbody');
            
            const now = new Date();
            const dateFormatted = `${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2, '0')}-${now.getDate().toString().padStart(2, '0')}`;
            
            // 创建新行
            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td><input type="checkbox"></td>
                <td>${name}</td>
                <td>${email}</td>
                <td>${department}</td>
                <td><span class="platform-badge platform-${platform}">第${platform}平台</span></td>
                <td><span class="role-badge ${role === 'user' ? 'role-user' : role === 'platform-admin' ? 'role-platform-admin' : 'role-admin'}">${role === 'user' ? '普通用户' : role === 'platform-admin' ? '平台管理员' : '超级管理员'}</span></td>
                <td>${dateFormatted}</td>
                <td>${dateFormatted}</td>
                <td>0次</td>
                <td>
                    <button class="action-btn view-btn">查看</button>
                    <button class="action-btn remove-btn">收回权限</button>
                </td>
            `;
            
            // 将新行添加到表格顶部
            if (authorizedTable) {
                authorizedTable.insertBefore(newRow, authorizedTable.firstChild);
                
                // 绑定新行上的按钮事件
                const viewBtn = newRow.querySelector('.view-btn');
                const revokeBtn = newRow.querySelector('.remove-btn');
                
                if (viewBtn) {
                    viewBtn.addEventListener('click', function() {
                        // 显示用户详情，包括管理平台信息
                        let detailInfo = reason;
                        
                        // 如果是平台管理员，添加管理平台信息
                        if (role === 'platform-admin' && managePlatforms.length > 0) {
                            const platformsText = managePlatforms.map(p => `第${p}平台`).join('、');
                            detailInfo += `\n\n管理平台：${platformsText}`;
                        }
                        
                        showUserDetail(name, email, department, dateFormatted, detailInfo, '0次');
                    });
                }
                
                if (revokeBtn) {
                    revokeBtn.addEventListener('click', function() {
                        if (confirm(`确定要收回 ${name} 的权限吗？`)) {
                            // 删除整行，而不只是更改状态
                            authorizedTable.removeChild(newRow);
                            // 显示收回成功的消息
                            alert(`已成功收回 ${name} 的权限`);
                        }
                    });
                }
            }
            
            // 关闭弹窗
            alert('用户权限添加成功');
            closeAddUserModal();
        }

        // Function to check if current user is super admin
        function isSuperAdmin() {
            // In real implementation, this would check the current user's role from session/API
            // For demo purposes, we'll assume the current user is a super admin
            return true;
        }
        
        // Handle platform change
        function handlePlatformChange() {
            const platformSelect = document.querySelector('.platform-select');
            const platformAdminOption = document.getElementById('platformAdminOption');
            
            if (platformSelect && platformAdminOption) {
                // Only enable platform admin role for super admins on any platform
                // or platform admins on their own platform
                if (isSuperAdmin()) {
                    platformAdminOption.classList.remove('disabled');
                    platformAdminOption.querySelector('input').disabled = false;
                } else {
                    // For non-super admins, disable platform admin option
                    platformAdminOption.classList.add('disabled');
                    platformAdminOption.querySelector('input').disabled = true;
                    // Ensure "user" option is selected
                    document.querySelector('input[name="role"][value="user"]').checked = true;
                }
            }
        }
        
        // Initialize role selection when tab is switched or form is shown
        function initRoleSelection() {
            // 首先确保我们处理的是初始状态
            document.querySelector('#add-user-modal input[name="role"][value="user"]').checked = true;
            
            // 然后应用初始状态
            handleRoleChange();
            
            // 添加事件监听器以便角色选择变化时更新显示
            const roleOptions = document.querySelectorAll('#add-user-modal input[name="role"]');
            roleOptions.forEach(option => {
                // 移除现有的监听器以避免重复
                option.removeEventListener('change', handleRoleChange);
                // 添加新的监听器
                option.addEventListener('change', handleRoleChange);
            });
            
            // 初始化管理平台多选下拉框
            initManagePlatformSelect();
            
            console.log('角色选择初始化完成');
        }

        // Initialize all multi-select dropdowns
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize multi-select dropdowns
            initMultiSelectDropdowns();
        });

        function initMultiSelectDropdowns() {
            // Find all multi-select elements
            const multiSelects = document.querySelectorAll('.multi-select');
            
            multiSelects.forEach(select => {
                const header = select.querySelector('.multi-select-header');
                const dropdown = select.querySelector('.multi-select-dropdown');
                const options = select.querySelectorAll('.multi-select-option input');
                const headerText = header.querySelector('span');
                
                // Toggle dropdown on header click
                header.addEventListener('click', (e) => {
                    e.stopPropagation();
                    
                    // Close all other open dropdowns
                    document.querySelectorAll('.multi-select-dropdown.active').forEach(d => {
                        if (d !== dropdown) {
                            d.classList.remove('active');
                            d.closest('.multi-select').querySelector('.multi-select-header').classList.remove('active');
                        }
                    });
                    
                    // Toggle current dropdown
                    dropdown.classList.toggle('active');
                    header.classList.toggle('active');
                });
                
                // Handle option selection
                options.forEach(option => {
                    option.addEventListener('change', (e) => {
                        e.stopPropagation();
                        updateHeaderText(select);
                    });
                    
                    // Prevent dropdown from closing when clicking on options
                    option.parentElement.addEventListener('click', (e) => {
                        e.stopPropagation();
                    });
                });
                
                // Initial header text
                updateHeaderText(select);
            });
            
            // Close dropdowns when clicking outside
            document.addEventListener('click', () => {
                document.querySelectorAll('.multi-select-dropdown.active').forEach(dropdown => {
                    dropdown.classList.remove('active');
                    dropdown.closest('.multi-select').querySelector('.multi-select-header').classList.remove('active');
                });
            });
        }

        // Update the header text based on selected options
        function updateHeaderText(select) {
            const header = select.querySelector('.multi-select-header span');
            const options = select.querySelectorAll('.multi-select-option input');
            const selectedOptions = Array.from(options).filter(opt => opt.checked);
            
            if (selectedOptions.length === 0) {
                header.textContent = '请选择';
            } else if (selectedOptions.length === options.length) {
                header.textContent = '全部';
            } else if (selectedOptions.length <= 2) {
                const labels = selectedOptions.map(opt => {
                    const text = opt.parentElement.textContent.trim();
                    return text;
                });
                header.textContent = labels.join(', ');
            } else {
                header.textContent = `已选 ${selectedOptions.length} 项`;
            }
        }

        // 显示用户详情
        function showUserDetail(name, employeeId, department, addTime, reason, usageCount) {
            // 获取用户详情模态框
            const modal = document.getElementById('user-detail-modal');
            
            // 更新模态框标题和内容
            modal.querySelector('.modal-header h3').textContent = `用户详情 - ${name}`;
            
            // 填充用户信息
            const modalBody = modal.querySelector('.modal-body');
            modalBody.innerHTML = `
                <div class="detail-section">
                    <h4>用户信息</h4>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-label">姓名</div>
                            <div class="detail-value">${name}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">域账号</div>
                            <div class="detail-value">${employeeId}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">部门</div>
                            <div class="detail-value">${department}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">授权时间</div>
                            <div class="detail-value">${addTime}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">使用次数</div>
                            <div class="detail-value">${usageCount}</div>
                        </div>
                    </div>
                </div>
                
                <div class="detail-section">
                    <h4>授权备注</h4>
                    <div class="detail-remarks">
                        ${reason || '无'}
                    </div>
                </div>
            `;
            
            // 显示模态框
            modal.style.display = 'flex';
            
            // 确保关闭按钮有事件
            const closeBtn = modal.querySelector('.close-btn');
            if (closeBtn) {
                closeBtn.addEventListener('click', function() {
                    modal.style.display = 'none';
                });
            }
        }

        // 在页面加载时为已存在的收回权限按钮添加点击事件
        document.addEventListener('DOMContentLoaded', function() {
            // 为已授权用户表格中的所有收回权限按钮添加事件
            const removeButtons = document.querySelectorAll('#authorized-tab .remove-btn');
            removeButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const row = this.closest('tr');
                    const name = row.querySelector('td:nth-child(2)').textContent;
                    
                    if (confirm(`确定要收回 ${name} 的权限吗？`)) {
                        // 获取表格的tbody元素，然后移除整行
                        const tbody = row.parentNode;
                        tbody.removeChild(row);
                    }
                });
            });
            
            // 为已授权用户表格中的所有查看按钮添加事件
            const viewButtons = document.querySelectorAll('#authorized-tab .view-btn');
            viewButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const row = this.closest('tr');
                    const name = row.querySelector('td:nth-child(2)').textContent;
                    const employeeId = row.querySelector('td:nth-child(3)').textContent;
                    const department = row.querySelector('td:nth-child(4)').textContent;
                    const addTime = row.querySelector('td:nth-child(7)').textContent;
                    const usageCount = row.querySelector('td:nth-child(9)').textContent;
                    
                    // 模拟授权备注
                    const reasons = {
                        '张三': '需要使用AI工具提升工作效率',
                        '李四': '需要调研AI产品功能',
                        '王五': '产品设计需要使用AI助手',
                        '赵六': '部门需开发问答智能体，烦请审批',
                        '钱七': '开发需要使用AI接口'
                    };
                    
                    const reason = reasons[name] || '用户申请使用系统';
                    
                    // 显示用户详情
                    showUserDetail(name, employeeId, department, addTime, reason, usageCount);
                });
            });
        });

        // 添加表格全选/取消全选功能
        function setupTableCheckboxes() {
            // 获取已授权用户表格的表头复选框
            const authorizedHeaderCheckbox = document.querySelector('#authorized-tab table thead th:first-child input[type="checkbox"]');
            
            // 为表头复选框添加点击事件
            if (authorizedHeaderCheckbox) {
                authorizedHeaderCheckbox.addEventListener('change', function() {
                    // 获取表格中所有行的复选框
                    const rowCheckboxes = document.querySelectorAll('#authorized-tab table tbody td:first-child input[type="checkbox"]');
                    
                    // 设置所有行的复选框状态与表头复选框一致
                    rowCheckboxes.forEach(checkbox => {
                        checkbox.checked = authorizedHeaderCheckbox.checked;
                    });
                    
                    // 更新批量操作按钮的状态
                    updateBatchActionStatus('authorized');
                });
            }
            
            // 获取当前登录用户表格的表头复选框
            const activeHeaderCheckbox = document.querySelector('#active-tab table thead th:first-child input[type="checkbox"]');
            
            // 为表头复选框添加点击事件
            if (activeHeaderCheckbox) {
                activeHeaderCheckbox.addEventListener('change', function() {
                    // 获取表格中所有行的复选框
                    const rowCheckboxes = document.querySelectorAll('#active-tab table tbody td:first-child input[type="checkbox"]');
                    
                    // 设置所有行的复选框状态与表头复选框一致
                    rowCheckboxes.forEach(checkbox => {
                        checkbox.checked = activeHeaderCheckbox.checked;
                    });
                    
                    // 更新批量操作按钮的状态
                    updateBatchActionStatus('active');
                });
            }
            
            // 移除原来的审批表格表头复选框逻辑 (由新函数替代)
            
            // 为每个表格中的行复选框添加事件，以便在单个选择变化时更新表头复选框状态
            setupRowCheckboxes('authorized');
            setupRowCheckboxes('active');
            setupApprovalRowCheckboxes(); // 为审批表格使用特殊处理
        }

        // 设置表格行复选框的事件
        function setupRowCheckboxes(tabId) {
            const rowCheckboxes = document.querySelectorAll(`#${tabId}-tab table tbody td:first-child input[type="checkbox"]`);
            const headerCheckbox = document.querySelector(`#${tabId}-tab table thead th:first-child input[type="checkbox"]`);
            
            rowCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    // 检查是否所有行都被选中
                    const allChecked = Array.from(rowCheckboxes).every(cb => cb.checked);
                    const anyChecked = Array.from(rowCheckboxes).some(cb => cb.checked);
                    
                    // 更新表头复选框状态
                    if (headerCheckbox) {
                        headerCheckbox.checked = allChecked;
                        // 可以添加indeterminate状态表示部分选中
                        headerCheckbox.indeterminate = anyChecked && !allChecked;
                    }
                    
                    // 更新批量操作按钮的状态
                    updateBatchActionStatus(tabId);
                });
            });
        }

        // 初始化页面中所有批量操作按钮的状态
        function initBatchActionButtons() {
            // 为每个标签页更新批量操作按钮状态
            updateBatchActionStatus('authorized');
            updateBatchActionStatus('approval');
            updateBatchActionStatus('active');
        }

        // 修改批量收回权限功能
        function setupBatchRemovePermission() {
            // 获取批量收回权限按钮
            const batchRemoveBtn = document.querySelector('#authorized-tab .batch-actions .remove-btn');
            
            if (batchRemoveBtn) {
                batchRemoveBtn.addEventListener('click', function() {
                    // 获取所有选中的行复选框
                    const checkedRows = document.querySelectorAll('#authorized-tab table tbody td:first-child input[type="checkbox"]:checked');
                    
                    // 如果没有选中的行，按钮应该是禁用的，所以这里不需要额外检查
                    // 直接获取选中用户的姓名
                    const selectedUsers = Array.from(checkedRows).map(checkbox => {
                        const row = checkbox.closest('tr');
                        return row.querySelector('td:nth-child(2)').textContent;
                    });
                    
                    // 显示确认对话框
                    if (confirm(`确定要收回以下用户的权限吗？\n${selectedUsers.join('\n')}`)) {
                        // 遍历选中的行并删除
                        checkedRows.forEach(checkbox => {
                            const row = checkbox.closest('tr');
                            if (row && row.parentNode) {
                                row.parentNode.removeChild(row);
                            }
                        });
                        
                        // 重置表头复选框
                        const headerCheckbox = document.querySelector('#authorized-tab table thead th:first-child input[type="checkbox"]');
                        if (headerCheckbox) {
                            headerCheckbox.checked = false;
                            headerCheckbox.indeterminate = false;
                        }
                        
                        // 更新批量操作按钮状态
                        updateBatchActionStatus('authorized');
                    }
                });
            }
        }

        // 在页面加载完成后设置复选框联动
        document.addEventListener('DOMContentLoaded', function() {
            // ...现有的DOMContentLoaded事件处理程序...
            
            // 设置表格复选框联动
            setupTableCheckboxes();
            
            // 专门设置审批表头复选框
            setupApprovalHeaderCheckbox();
            
            // 禁用已处理的审批单复选框
            disableProcessedApprovalCheckboxes();
            
            // 设置批量收回权限功能
            setupBatchRemovePermission();
            
            // 初始化批量操作按钮状态 (禁用)
            initBatchActionButtons();
            
            // 初始化查看按钮事件，以显示审批备注/拒绝理由
            setupViewButtonEvents();
            
            // 初始化已处理审批单的数据
            initProcessedApprovalComments();
        });

        // 添加一个函数来禁用已处理审批单的复选框
        function disableProcessedApprovalCheckboxes() {
            // 获取所有审批单行
            const approvalRows = document.querySelectorAll('#approval-tab table tbody tr');
            
            approvalRows.forEach(row => {
                // 获取状态列，检查是否为"已通过"或"已拒绝"
                const statusElement = row.querySelector('td:nth-child(9) .status');
                if (statusElement) {
                    const status = statusElement.textContent;
                    
                    // 如果是已处理的状态，禁用复选框
                    if (status === '已通过' || status === '已拒绝') {
                        const checkbox = row.querySelector('td:first-child input[type="checkbox"]');
                        if (checkbox) {
                            checkbox.disabled = true;
                            checkbox.checked = false; // 确保未被选中
                            checkbox.parentElement.title = '已处理的审批单不可选择'; // 添加提示
                        }
                    }
                }
            });
        }

        // 修改表头复选框事件，只影响未禁用的复选框
        function setupApprovalHeaderCheckbox() {
            const approvalHeaderCheckbox = document.querySelector('#approval-tab table thead th:first-child input[type="checkbox"]');
            
            if (approvalHeaderCheckbox) {
                approvalHeaderCheckbox.addEventListener('change', function() {
                    // 只获取未禁用的行复选框
                    const availableRowCheckboxes = document.querySelectorAll('#approval-tab table tbody td:first-child input[type="checkbox"]:not([disabled])');
                    
                    // 设置所有可用行的复选框状态与表头复选框一致
                    availableRowCheckboxes.forEach(checkbox => {
                        checkbox.checked = approvalHeaderCheckbox.checked;
                    });
                    
                    // 更新批量操作按钮的状态
                    updateBatchActionStatus('approval');
                });
            }
        }

        // 专门为审批表格行复选框设置事件
        function setupApprovalRowCheckboxes() {
            const rowCheckboxes = document.querySelectorAll('#approval-tab table tbody td:first-child input[type="checkbox"]');
            const headerCheckbox = document.querySelector('#approval-tab table thead th:first-child input[type="checkbox"]');
            
            rowCheckboxes.forEach(checkbox => {
                // 只为未禁用的复选框添加事件
                if (!checkbox.disabled) {
                    checkbox.addEventListener('change', function() {
                        // 获取所有未禁用的复选框
                        const availableCheckboxes = document.querySelectorAll('#approval-tab table tbody td:first-child input[type="checkbox"]:not([disabled])');
                        
                        // 检查是否所有可用行都被选中
                        const allChecked = Array.from(availableCheckboxes).every(cb => cb.checked);
                        const anyChecked = Array.from(availableCheckboxes).some(cb => cb.checked);
                        
                        // 更新表头复选框状态
                        if (headerCheckbox) {
                            headerCheckbox.checked = allChecked;
                            // 可以添加indeterminate状态表示部分选中
                            headerCheckbox.indeterminate = anyChecked && !allChecked;
                        }
                        
                        // 更新批量操作按钮的状态
                        updateBatchActionStatus('approval');
                    });
                }
            });
        }

        // 为查看按钮绑定事件，显示包含审批备注/拒绝理由的用户详情
        function setupViewButtonEvents() {
            const viewButtons = document.querySelectorAll('.view-btn');
            viewButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // 获取当前行的数据
                    const row = this.closest('tr');
                    
                    // 确定当前是哪个标签页
                    const tabId = row.closest('.tab-content').id;
                    
                    // 根据标签页调用不同的详情展示函数
                    if (tabId === 'approval-tab') {
                        showApprovalDetails(row);
                    } else if (tabId === 'authorized-tab') {
                        showAuthorizedUserDetails(row);
                    } else if (tabId === 'active-tab') {
                        showActiveUserDetails(row);
                    }
                });
            });
        }

        // 权限审批详情展示函数
        function showApprovalDetails(row) {
            // 获取基本用户信息
            const name = row.querySelector('td:nth-child(2)').textContent.trim();
            // const jobId = row.querySelector('td:nth-child(3)').textContent.trim();
            const department = row.querySelector('td:nth-child(4)').textContent.trim();
            const platform = row.querySelector('td:nth-child(5)').textContent.trim();
            const role = row.querySelector('td:nth-child(6)').textContent.trim();
            const applyTime = row.querySelector('td:nth-child(7)').textContent.trim();
            const reason = row.querySelector('td:nth-child(8)').textContent.trim();
            
            // 获取状态和审批信息
            const statusEl = row.querySelector('td:nth-child(9) .status');
            const status = statusEl ? statusEl.textContent.trim() : '待审批';
            
            let approvalComment = '';
            if (status === '已通过') {
                approvalComment = row.getAttribute('data-approval-comment') || '';
            } else if (status === '已拒绝') {
                approvalComment = row.getAttribute('data-rejection-reason') || '';
            }
            
            // 补充其他信息
            let email = '';
            let position = '';
            
            // 根据不同用户设置不同信息
            if (name.includes('张三')) {
                email = 'zhangsan';
                position = '高级Java开发工程师';
            } else if (name.includes('李四')) {
                email = 'lisi';
                position = '高级Java开发工程师';
            } else if (name.includes('王五')) {
                email = 'wangwu';
                position = '高级Java开发工程师';
            } else if (name.includes('赵六')) {
                email = 'zhaoliu';
                position = '高级Java开发工程师';
            } else if (name.includes('钱七')) {
                email = 'qianqi';
                position = '高级Java开发工程师';
            } else if (name.includes('刘二')) {
                email = 'liuer';
                position = '高级Java开发工程师';
            }
            
            // 构建模态框内容
            let modalContent = `
                <div class="modal-header">
                    <h3>申请详情 - ${name}</h3>
                    <span class="close-btn">&times;</span>
                </div>
                <div class="modal-body">
                    <div class="detail-section">
                        <h4>申请信息</h4>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <div class="detail-label">申请人</div>
                                <div class="detail-value">${name}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">所属部门</div>
                                <div class="detail-value">${department}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">岗位名称</div>
                                <div class="detail-value">${position}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">域账号</div>
                                <div class="detail-value">${email}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">申请时间</div>
                                <div class="detail-value">${applyTime}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="detail-section">
                        <h4>申请原因</h4>
                        <div class="detail-remarks" style="border-left-color: #faad14; background-color: #fffbe6;">
                            ${reason}
                        </div>
                    </div>`;
            
            // 根据状态添加审批备注或拒绝理由
            if (status === '已通过' && approvalComment) {
                modalContent += `
                    <div class="detail-section">
                        <h4>审批备注</h4>
                        <div class="detail-remarks" style="border-left-color: #52c41a; background-color: #f6ffed;">
                            ${approvalComment}
                        </div>
                    </div>`;
            } else if (status === '已拒绝' && approvalComment) {
                modalContent += `
                    <div class="detail-section">
                        <h4>拒绝理由</h4>
                        <div class="detail-remarks" style="border-left-color: #f5222d; background-color: #fff1f0;">
                            ${approvalComment}
                        </div>
                    </div>`;
            }
            
            // 添加底部按钮
            modalContent += `
                </div>
                <div class="modal-footer">
                    <button class="modal-btn cancel-btn">关闭</button>
                </div>
            `;
            
            // 显示模态框
            showModalWithContent('user-detail-modal', modalContent);
        }

        // 已授权用户详情展示函数
        function showAuthorizedUserDetails(row) {
            // 获取基本用户信息
            const name = row.querySelector('td:nth-child(2)').textContent.trim();
            // const jobId = row.querySelector('td:nth-child(3)').textContent.trim();
            const department = row.querySelector('td:nth-child(4)').textContent.trim();
            const platform = row.querySelector('td:nth-child(5)').textContent.trim();
            const role = row.querySelector('td:nth-child(6)').textContent.trim();
            const applyTime = row.querySelector('td:nth-child(7)').textContent.trim();
            
            // 补充其他信息
            let email = '';
            let position = '';
            
            // 根据不同用户设置不同信息
            if (name.includes('张三')) {
                email = 'zhangsan';
                position = '高级Java开发工程师';
            } else if (name.includes('李四')) {
                email = 'lisi';
                position = '高级Java开发工程师';
            } else if (name.includes('王五')) {
                email = 'wangwu';
                position = '高级Java开发工程师';
            } else if (name.includes('赵六')) {
                email = 'zhaoliu';
                position = '高级Java开发工程师';
            } else if (name.includes('钱七')) {
                email = 'qianqi';
                position = '高级Java开发工程师';
            } else if (name.includes('刘二')) {
                email = 'liuer';
                position = '高级Java开发工程师';
            }
            
            // 构建模态框内容 - 移除了申请原因部分
            let modalContent = `
                <div class="modal-header">
                    <h3>权限详情 - ${name}</h3>
                    <span class="close-btn">&times;</span>
                </div>
                <div class="modal-body">
                    <div class="detail-section">
                        <h4>用户信息</h4>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <div class="detail-label">用户名</div>
                                <div class="detail-value">${name}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">所属部门</div>
                                <div class="detail-value">${department}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">所属平台</div>
                                <div class="detail-value">${platform}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">岗位名称</div>
                                <div class="detail-value">${position}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">域账号</div>
                                <div class="detail-value">${email}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">授权时间</div>
                                <div class="detail-value">${applyTime}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">授权方式</div>
                                <div class="detail-value">直接授权</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="modal-btn cancel-btn">关闭</button>
                </div>
            `;
            
            // 显示模态框
            showModalWithContent('user-detail-modal', modalContent);
        }

        // 当前登录用户详情展示函数
        function showActiveUserDetails(row) {
            // 获取基本用户信息
            const name = row.querySelector('td:nth-child(2)').textContent.trim();
            // const jobId = row.querySelector('td:nth-child(3)').textContent.trim();
            const department = row.querySelector('td:nth-child(4)').textContent.trim();
            const platform = row.querySelector('td:nth-child(5)').textContent.trim();
            const role = row.querySelector('td:nth-child(6)').textContent.trim();
            const statusEl = row.querySelector('td:nth-child(7)');
            const status = statusEl ? statusEl.textContent.trim() : '在线';
            
            // 补充其他信息
            let email = '';
            let position = '';
            
            // 根据不同用户设置不同信息
            if (name.includes('张三')) {
                email = 'zhangsan';
                position = '高级Java开发工程师';
            } else if (name.includes('李四')) {
                email = 'lisi';
                position = '高级Java开发工程师';
            } else if (name.includes('王五')) {
                email = 'wangwu';
                position = '高级Java开发工程师';
            } else if (name.includes('赵六')) {
                email = 'zhaoliu';
                position = '高级Java开发工程师';
            } else if (name.includes('钱七')) {
                email = 'qianqi';
                position = '高级Java开发工程师';
            } else if (name.includes('刘二')) {
                email = 'liuer';
                position = '高级Java开发工程师';
            }
            
            // 生成随机的浏览器信息
            const browsers = [
                'Chrome 96.0.4664.110', 
                'Firefox 95.0.2', 
                'Edge 97.0.1072.69', 
                'Safari 15.2', 
                'Chrome 97.0.4692.71'
            ];
            const randomBrowser = browsers[Math.floor(Math.random() * browsers.length)];
            
            // 获取当前日期时间
            const currentDate = new Date();
            const formattedDateTime = currentDate.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            }).replace(/\//g, '-');
            
            // 构建模态框内容
            let modalContent = `
                <div class="modal-header">
                    <h3>在线用户详情 - ${name}</h3>
                    <span class="close-btn">&times;</span>
                </div>
                <div class="modal-body">
                    <div class="detail-section">
                        <h4>用户信息</h4>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <div class="detail-label">用户名</div>
                                <div class="detail-value">${name}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">所属部门</div>
                                <div class="detail-value">${department}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">岗位名称</div>
                                <div class="detail-value">${position}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">域账号</div>
                                <div class="detail-value">${email}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">登录时间</div>
                                <div class="detail-value">${formattedDateTime}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">IP地址</div>
                                <div class="detail-value">192.168.1.${Math.floor(Math.random() * 255) + 1}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">登录设备</div>
                                <div class="detail-value">${randomBrowser}</div>
                            </div>
                        </div>
                    </div>`;
            
            // 创建3条随机的登录记录，日期逐渐往前
            const loginRecords = [];
            for (let i = 0; i < 3; i++) {
                // 创建时间偏移，每次多一些
                const offset = (i === 0) ? 2 : (i === 1) ? 6 : 24; // 小时偏移
                
                // 计算日期和格式化
                const recordDate = new Date(Date.now() - offset * 3600000);
                const formattedDate = recordDate.toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                }).replace(/\//g, '-');
                
                // 随机浏览器和IP
                const loginBrowser = browsers[Math.floor(Math.random() * browsers.length)];
                const loginIP = `192.168.1.${Math.floor(Math.random() * 255) + 1}`;
                
                loginRecords.push({
                    time: formattedDate,
                    browser: loginBrowser,
                    ip: loginIP
                });
            }
            
            // 添加登录记录表格
            modalContent += `
                <div class="detail-section">
                    <h4>登录记录</h4>
                    <table class="detail-table" style="width: 100%;">
                        <thead>
                            <tr>
                                <th>登录时间</th>
                                <th>登录设备</th>
                                <th>IP地址</th>
                            </tr>
                        </thead>
                        <tbody>`;
            
            // 添加每条登录记录
            loginRecords.forEach(record => {
                modalContent += `
                            <tr>
                                <td>${record.time}</td>
                                <td>${record.browser}</td>
                                <td>${record.ip}</td>
                            </tr>`;
            });
            
            modalContent += `
                        </tbody>
                    </table>
                </div>`;
            
            // 添加底部按钮
            modalContent += `
                </div>
                <div class="modal-footer">
                    <button class="modal-btn cancel-btn">关闭</button>
                </div>
            `;
            
            // 显示模态框
            showModalWithContent('user-detail-modal', modalContent);
        }

        // 辅助函数：显示带有特定内容的模态框
        function showModalWithContent(modalId, content) {
            const modal = document.getElementById(modalId);
            if (!modal) return;
            
            // 设置模态框内容
            modal.querySelector('.modal-content').innerHTML = content;
            
            // 为关闭按钮添加事件
            const closeBtn = modal.querySelector('.close-btn');
            const cancelBtn = modal.querySelector('.cancel-btn');
            
            if (closeBtn) {
                closeBtn.addEventListener('click', function() {
                    modal.style.display = 'none';
                });
            }
            
            if (cancelBtn) {
                cancelBtn.addEventListener('click', function() {
                    modal.style.display = 'none';
                });
            }
            
            // 显示模态框
            modal.style.display = 'flex';
        }

        // 初始化已处理审批单的数据属性 - 修改为仅检查状态，不添加默认备注
        function initProcessedApprovalComments() {
            // 获取所有已处理的审批单行
            const approvedRows = document.querySelectorAll('#approval-tab tbody tr:has(td:nth-child(9) .status-approved)');
            const rejectedRows = document.querySelectorAll('#approval-tab tbody tr:has(td:nth-child(9) .status-rejected)');
            
            // 检查已通过的行是否有审批备注属性
            approvedRows.forEach(row => {
                // 仅确保有属性，不填充默认值
                if (!row.hasAttribute('data-approval-comment')) {
                    row.setAttribute('data-approval-comment', '');
                }
            });
            
            // 检查已拒绝的行是否有拒绝理由属性
            rejectedRows.forEach(row => {
                // 仅确保有属性，不填充默认值
                if (!row.hasAttribute('data-rejection-reason')) {
                    row.setAttribute('data-rejection-reason', '');
                }
            });
        }

        // 为初始化数据添加审批备注/拒绝理由
        function initSampleApprovalComments() {
            // 获取所有已处理的审批单行
            const rows = document.querySelectorAll('#approval-tab tbody tr');
            
            rows.forEach(row => {
                const statusCell = row.querySelector('td:nth-child(9)');
                const statusText = statusCell ? statusCell.textContent.trim() : '';
                const name = row.querySelector('td:nth-child(2)').textContent.trim();
                
                // 为已通过的行添加审批备注
                if (statusText.includes('已通过')) {
                    let comment = '已核实用户身份和需求，符合公司安全政策要求，予以批准。';
                    
                    // 根据用户名设置不同的备注
                    if (name === '张三') {
                        comment += ' 用户是中國建築國際-中建香港-海宏技術有限公司-海宏公司團隊(駐深)-數字化提升部二部门核心成员，需使用此权限处理客户反馈问题。';
                    } else if (name === '李四') {
                        comment += ' 用户需短期访问系统进行市场数据分析。';
                    } else if (name === '王五') {
                        comment += ' 用户是产品核心成员，需要长期使用此功能。';
                    }
                    
                    row.setAttribute('data-approval-comment', comment);
                }
                
                // 为已拒绝的行添加拒绝理由
                if (statusText.includes('已拒绝')) {
                    let reason = '申请用途与用户岗位职责不符，无法确认业务需求的真实性。';
                    
                    // 根据用户名设置不同的理由
                    if (name === '赵六') {
                        reason += ' 中國建築國際-中建香港-中國建築國際-中建香港-中國建築國際-中建香港-人力资源部部部部门人员无权限访问该系统的敏感数据。';
                    } else if (name === '钱七') {
                        reason += ' 该权限需要由部门主管提出申请，请按正规流程重新申请。';
                    }
                    
                    row.setAttribute('data-rejection-reason', reason);
                }
            });
        }

        // 添加调试函数
        function debugApprovalComments() {
            console.log('调试审批备注/拒绝理由:');
            
            // 获取所有行
            const rows = document.querySelectorAll('#approval-tab tbody tr');
            
            rows.forEach((row, index) => {
                const name = row.querySelector('td:nth-child(2)').textContent.trim();
                const statusCell = row.querySelector('td:nth-child(9)');
                const statusText = statusCell ? statusCell.textContent.trim() : '待审批';
                const approvalComment = row.getAttribute('data-approval-comment');
                const rejectionReason = row.getAttribute('data-rejection-reason');
                
                console.log(`行 ${index+1} - ${name}:`);
                console.log('  状态:', statusText);
                console.log('  审批备注:', approvalComment || '无');
                console.log('  拒绝理由:', rejectionReason || '无');
            });
        }

        // 在初始化后调用调试函数
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化样例数据的审批备注/拒绝理由
            initSampleApprovalComments();
            
            // 初始化查看按钮事件
            setupViewButtonEvents();
            
            // 调试输出
            setTimeout(debugApprovalComments, 1000);
            
            // ... 其他初始化代码 ...
        });

        // 为表格复选框添加事件处理（通用函数）
        function setupAllCheckboxEvents() {
            // 为每个标签页设置复选框事件
            setupTabCheckboxEvents('approval');
            setupTabCheckboxEvents('authorized');
            setupTabCheckboxEvents('active');
        }

        // 为单个标签页的表格复选框添加事件处理
        function setupTabCheckboxEvents(tabName) {
            // 获取表头复选框
            const headerCheckbox = document.querySelector(`#${tabName}-tab table thead th:first-child input[type="checkbox"]`);
            
            // 获取所有行复选框
            const rowCheckboxes = document.querySelectorAll(`#${tabName}-tab table tbody td:first-child input[type="checkbox"]`);
            
            // 为表头复选框添加事件
            if (headerCheckbox) {
                headerCheckbox.addEventListener('change', function() {
                    // 获取所有未禁用的行复选框
                    const availableCheckboxes = document.querySelectorAll(`#${tabName}-tab table tbody td:first-child input[type="checkbox"]:not([disabled])`);
                    
                    // 设置所有可用复选框的状态与表头复选框一致
                    availableCheckboxes.forEach(checkbox => {
                        checkbox.checked = headerCheckbox.checked;
                    });
                    
                    // 更新批量操作按钮状态
                    const checkedCount = headerCheckbox.checked ? availableCheckboxes.length : 0;
                    updateBatchActionButtons(tabName, checkedCount);
                });
            }
            
            // 为所有行复选框添加事件
            rowCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    // 更新表头复选框状态和批量操作按钮状态
                    updateTableHeaderCheckboxState(tabName);
                });
            });
        }

        // 批量审批操作弹窗样式设置
        function setupModalStyles() {
            // 获取审批操作模态框
            const modal = document.getElementById('approval-action-modal');
            if (!modal) return;
            
            // 添加强调样式
            const style = document.createElement('style');
            style.textContent = `
                .approval-count {
                    font-size: 16px;
                    background-color: #1890ff;
                    color: white;
                    padding: 3px 8px;
                    border-radius: 12px;
                    margin-left: 10px;
                    display: inline-block;
                }
            `;
            document.head.appendChild(style);
        }

        // 格式化批量操作标题
        function formatBatchTitle(action, count) {
            return `
                <span>${action === 'approve' ? '批量通过' : '批量拒绝'}</span>
                <span class="approval-count">${count}条</span>
            `;
        }

        // 在 batchApprovalAction 函数中设置标题时调用
        // 将
        // modal.querySelector('.modal-header h3').textContent = `批量通过 (${checkedRows.length}条)`;
        // 改为
        // modal.querySelector('.modal-header h3').innerHTML = formatBatchTitle(action, checkedRows.length);

        // 在页面加载时初始化样式
        document.addEventListener('DOMContentLoaded', function() {
            // ... 其他初始化代码 ...
            
            // 设置模态框样式
            setupModalStyles();
            
            // ... 其他初始化代码 ...
        });

        // 批量收回权限操作
        function batchRevokePermission() {
            // 获取所有选中的行
            // const checkedRows = document.querySelectorAll('#authorized-tab table tbody td:first-child input[type="checkbox"]:checked:not([disabled])');
            
            // if (checkedRows.length === 0) {
            //     alert('请先选择要收回权限的用户');
            //     return;
            // }
            
            // 确认操作
            if (!confirm(`确定要收回 ${checkedRows.length} 名用户的权限吗？此操作不可撤销。`)) {
                return;
            }
            
            // 执行批量收回操作
            checkedRows.forEach(checkbox => {
                const row = checkbox.closest('tr');
                revokePermission(row);
            });
            
            // 更新表头复选框状态
            updateTableHeaderCheckboxState('authorized');
            
            // 显示操作成功消息
            alert(`已成功收回 ${checkedRows.length} 名用户的权限`);
        }

        // 批量强制退出操作
        function batchForceLogout() {
            // 获取所有选中的行
            const checkedRows = document.querySelectorAll('#active-tab table tbody td:first-child input[type="checkbox"]:checked:not([disabled])');
            
            if (checkedRows.length === 0) {
                alert('请先选择要强制退出的用户');
                return;
            }
            
            // 确认操作
            if (!confirm(`确定要强制 ${checkedRows.length} 名用户退出登录吗？这将中断他们当前的操作。`)) {
                return;
            }
            
            // 执行批量强制退出操作
            checkedRows.forEach(checkbox => {
                const row = checkbox.closest('tr');
                forceLogout(row);
            });
            
            // 更新表头复选框状态
            updateTableHeaderCheckboxState('active');
            
            // 显示操作成功消息
            alert(`已成功强制 ${checkedRows.length} 名用户退出登录`);
        }

        // 更新表头复选框状态和批量操作按钮状态（通用函数）
        function updateTableHeaderCheckboxState(tabName) {
            const availableCheckboxes = document.querySelectorAll(`#${tabName}-tab table tbody td:first-child input[type="checkbox"]:not([disabled])`);
            const checkedCheckboxes = document.querySelectorAll(`#${tabName}-tab table tbody td:first-child input[type="checkbox"]:checked:not([disabled])`);
            const headerCheckbox = document.querySelector(`#${tabName}-tab table thead th:first-child input[type="checkbox"]`);
            
            if (headerCheckbox && availableCheckboxes.length > 0) {
                const allChecked = Array.from(availableCheckboxes).every(cb => cb.checked);
                const anyChecked = Array.from(availableCheckboxes).some(cb => cb.checked);
                
                headerCheckbox.checked = allChecked;
                headerCheckbox.indeterminate = anyChecked && !allChecked;
            } else if (headerCheckbox) {
                // 如果没有可用的复选框，则取消选中表头复选框
                headerCheckbox.checked = false;
                headerCheckbox.indeterminate = false;
            }
            
            // 更新批量操作按钮状态
            updateBatchActionButtons(tabName, checkedCheckboxes.length);
        }

        // 更新批量操作按钮状态和数量显示
        function updateBatchActionButtons(tabName, checkedCount) {
            // 获取对应标签页的批量操作按钮
            let batchButtons = [];
            
            if (tabName === 'approval') {
                // 审批标签页
                batchButtons = [
                    { el: document.querySelector(`#${tabName}-tab .batch-actions .approve-btn`), text: '批量通过' },
                    { el: document.querySelector(`#${tabName}-tab .batch-actions .reject-btn`), text: '批量拒绝' }
                ];
            } else if (tabName === 'authorized') {
                // 已授权标签页
                batchButtons = [
                    { el: document.querySelector(`#${tabName}-tab .batch-actions .remove-btn`), text: '批量收回权限' }
                ];
            } else if (tabName === 'active') {
                // 在线用户标签页
                batchButtons = [
                    { el: document.querySelector(`#${tabName}-tab .batch-actions .force-logout-btn`), text: '批量强制退出' }
                ];
            }
            
            // 更新按钮文本和状态
            batchButtons.forEach(button => {
                if (button.el) {
                    if (checkedCount > 0) {
                        button.el.classList.remove('disabled');
                        button.el.textContent = `${button.text} (${checkedCount})`;
                    } else {
                        button.el.classList.add('disabled');
                        button.el.textContent = button.text;
                    }
                }
            });
        }

        // 在页面加载完成后初始化所有复选框事件和批量操作按钮状态
        document.addEventListener('DOMContentLoaded', function() {
            // ... 其他初始化代码 ...
            
            // 设置所有标签页的复选框事件
            setupAllCheckboxEvents();
            
            // 初始化所有标签页的批量操作按钮状态
            updateBatchActionButtons('approval', 0);
            updateBatchActionButtons('authorized', 0);
            updateBatchActionButtons('active', 0);
            
            // 添加批量收回和批量强制退出的事件处理
            setupBatchActionEvents();
            
            // ... 其他初始化代码 ...
        });

        // 设置批量操作按钮的事件处理
        function setupBatchActionEvents() {
            // 批量收回权限按钮
            const batchRevokeBtn = document.querySelector('#authorized-tab .batch-actions .remove-btn');
            if (batchRevokeBtn) {
                batchRevokeBtn.addEventListener('click', batchRevokePermission);
            }
            
            // 批量强制退出按钮
            const batchLogoutBtn = document.querySelector('#active-tab .batch-actions .force-logout-btn');
            if (batchLogoutBtn) {
                batchLogoutBtn.addEventListener('click', batchForceLogout);
            }
            
            // ... 审批相关的批量按钮事件已在其他地方设置 ...
        }

        // 收回用户权限操作
        function revokePermission(row) {
            if (!row) return;
            
            // 从表格中移除该行
            row.parentNode.removeChild(row);
            
            // 更新表头复选框状态和批量操作按钮状态
            updateTableHeaderCheckboxState('authorized');
            
            // 可以添加实际的后端操作代码，例如发送API请求
            console.log('已收回用户权限');
        }

        // 强制用户退出操作
        function forceLogout(row) {
            if (!row) return;
            
            // 修改用户状态为"已强制退出"
            const statusCell = row.querySelector('td:nth-child(7)');
            if (statusCell) {
                statusCell.innerHTML = '<span class="status status-rejected">已强制退出</span>';
            }
            
            // 禁用复选框
            const checkbox = row.querySelector('td:first-child input[type="checkbox"]');
            if (checkbox) {
                checkbox.disabled = true;
                checkbox.checked = false;
            }
            
            // 修改操作按钮
            const actionsCell = row.querySelector('td:last-child');
            if (actionsCell) {
                actionsCell.innerHTML = '<button class="action-btn view-btn">查看</button>';
            }
            
            // 更新表头复选框状态和批量操作按钮状态
            updateTableHeaderCheckboxState('active');
            
            // 可以添加实际的后端操作代码，例如发送API请求
            console.log('已强制用户退出');
        }

        // 强制退出功能
        function forceLogout(btn) {
            const row = btn.closest('tr');
            const name = row.querySelector('td:nth-child(2)').textContent.trim();
            const loginDevice = row.querySelector('td:nth-child(8)').textContent.trim();
            const ipAddress = row.querySelector('td:nth-child(7)').textContent.trim();
            
            if (confirm(`确定要强制 ${name} 退出登录吗？`)) {
                // 删除行
                row.remove();
                
                // 记录系统日志
                const logData = {
                    type: 'force-logout',
                    userName: name,
                    operatorName: '戴倚凡', // 当前登录管理员
                    device: loginDevice,
                    ip: ipAddress,
                    timestamp: new Date().getTime()
                };
                
                // 获取现有日志
                const storedLogs = JSON.parse(localStorage.getItem('systemLogs') || '[]');
                storedLogs.push(logData);
                localStorage.setItem('systemLogs', JSON.stringify(storedLogs));
                
                // 检查表格是否为空
                checkEmptyTable();
                
                // 显示消息
                alert(`已强制 ${name} 退出登录`);
            }
        }

        // 批量强制退出
        function batchForceLogout() {
            const selectedRows = document.querySelectorAll('#active-tab tbody tr input[type="checkbox"]:checked');
            const count = selectedRows.length;
            
            if (count === 0) {
                alert('请选择要强制退出的用户');
                return;
            }
            
            if (confirm(`确定要强制选中的 ${count} 名用户退出登录吗？`)) {
                const storedLogs = JSON.parse(localStorage.getItem('systemLogs') || '[]');
                
                // 处理每一行
                selectedRows.forEach(checkbox => {
                    const row = checkbox.closest('tr');
                    const name = row.querySelector('td:nth-child(2)').textContent.trim();
                    const loginDevice = row.querySelector('td:nth-child(8)').textContent.trim();
                    const ipAddress = row.querySelector('td:nth-child(7)').textContent.trim();
                    
                    // 记录系统日志
                    const logData = {
                        type: 'force-logout',
                        userName: name,
                        operatorName: '戴倚凡', // 当前登录管理员
                        device: loginDevice,
                        ip: ipAddress,
                        timestamp: new Date().getTime()
                    };
                    
                    storedLogs.push(logData);
                    
                    // 删除行
                    row.remove();
                });
                
                // 保存所有日志
                localStorage.setItem('systemLogs', JSON.stringify(storedLogs));
                
                // 检查表格是否为空
                checkEmptyTable();
                
                // 显示消息
                alert(`已强制 ${count} 名用户退出登录`);
            }
        }

        // 搜索用户函数
        function searchUser() {
            const email = document.querySelector('#add-user-modal input[name="email"]').value;
            // 原来可能是:
            // const employeeId = document.querySelector('#add-user-modal input[name="employeeId"]').value;
            
            if (!email) {
                showSearchMessage('请输入域账号', 'error');
                return;
            }
            
            // 模拟API调用
            showSearchMessage('正在查询用户信息...', 'loading');
            
            // 修改API调用参数
            setTimeout(() => {
                // 假设这是模拟从后端获取数据
                const userData = {
                    name: '张三',
                    email: email, // 替换原来的 employeeId
                    department: '中國建築國際-中建香港-海宏技術有限公司-海宏公司團隊(駐深)-數字化提升部二部',
                    // 其他用户数据...
                };
                
                displayUserInfo(userData);
                showSearchMessage('用户信息已找到', 'success');
            }, 1000);
        }

        // 显示用户信息函数
        function displayUserInfo(user) {
            // 修改显示字段
            document.querySelector('.user-details .name-value').textContent = user.name;
            document.querySelector('.user-details .email-value').textContent = user.email;
            // 原来可能是:
            // document.querySelector('.user-details .employeeId-value').textContent = user.employeeId;
            document.querySelector('.user-details .department-value').textContent = user.department;
            // 其他字段...
        }

        // 添加用户函数
        function addUser() {
            // 获取表单数据
            const name = document.querySelector('#add-user-modal input[name="name"]').value;
            const email = document.querySelector('#add-user-modal input[name="email"]').value;
            // 原来可能是:
            // const employeeId = document.querySelector('#add-user-modal input[name="employeeId"]').value;
            const department = document.querySelector('#add-user-modal select[name="department"]').value;
            
            // 获取平台和角色 (修复之前的错误)
            const platform = document.querySelector('#add-user-modal select[name="platform"]').value;
            const role = document.querySelector('#add-user-modal input[name="role"]:checked').value;
            
            // 验证
            if (!name || !email || !department || !platform || !role) {
                alert('请填写完整信息');
                return;
            }
            
            // 构建用户数据
            const userData = {
                name,
                email,  // 替换原来的 employeeId
                department,
                platform,
                role,
                // 其他数据...
            };
            
            // 提交数据逻辑...
            console.log('添加用户:', userData);
            closeModal('add-user-modal');
            // 刷新用户列表
            refreshUserList();
        }

        // 修改分页组件的函数
        function updatePaginationComponents() {
            // 获取所有分页组件
            const paginationElements = document.querySelectorAll('.pagination');
            
            paginationElements.forEach(pagination => {
                // 创建外层容器
                const paginationContainer = document.createElement('div');
                paginationContainer.className = 'pagination-container';
                
                // 创建选择每页条数的选择器
                const paginationOptions = document.createElement('div');
                paginationOptions.className = 'pagination-options';
                paginationOptions.innerHTML = `
                  <span>每页显示</span>
                  <select class="page-size-select">
                    <option value="10">10</option>
                    <option value="20" selected>20</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                  </select>
                  <span>条</span>
                `;
                
                // 将分页组件替换为新的结构
                const parent = pagination.parentElement;
                parent.insertBefore(paginationContainer, pagination);
                
                // 将原分页组件和选择器添加到新容器中
                paginationContainer.appendChild(paginationOptions);
                paginationContainer.appendChild(pagination);
                
                // 为选择器添加事件监听器
                const pageSizeSelect = paginationOptions.querySelector('.page-size-select');
                pageSizeSelect.addEventListener('change', function() {
                  const pageSize = parseInt(this.value);
                  
                  // 获取当前标签页ID，以确定是哪个表格
                  let tabId = '';
                  const tabContent = findParentWithClass(pagination, 'tab-content');
                  if (tabContent) {
                    tabId = tabContent.id;
                  }
                  
                  // 实际项目中，这里应该调用加载数据的函数重新加载对应页数的数据
                  console.log(`切换 ${tabId} 的每页条数为 ${pageSize} 条`);
                  
                  // 模拟切换页码 - 实际实现中应该调用加载数据的函数
                  simulatePageSizeChange(tabId, pageSize);
                });
            });
        }

        // 根据元素查找具有指定类名的父元素
        function findParentWithClass(element, className) {
            let parent = element.parentElement;
            while (parent) {
                if (parent.classList.contains(className)) {
                    return parent;
                }
                parent = parent.parentElement;
            }
            return null;
        }

        // 模拟页码切换 - 在真实实现中应替换为实际的数据加载函数
        function simulatePageSizeChange(tabId, pageSize) {
            // 在实际应用中，这里应该调用API重新加载数据
            // 这里只是简单地模拟切换页码后的效果
            
            // 更新当前活动的页码按钮
            const paginationButtons = document.querySelectorAll(`#${tabId} .pagination button`);
            paginationButtons.forEach(button => {
                button.classList.remove('active');
            });
            
            if (paginationButtons.length > 1) {
                paginationButtons[1].classList.add('active');
            }
            
            // 可以在这里添加一些视觉反馈，例如表格loading状态等
            const table = document.querySelector(`#${tabId} table`);
            if (table) {
                table.style.opacity = '0.6';
                setTimeout(() => {
                    table.style.opacity = '1';
                }, 500);
            }
            
            // 更新表格中显示的记录数量
            // 实际应用中，这应该由重新加载的数据决定
            updateTableRows(tabId, pageSize);
        }

        // 更新表格行数
        function updateTableRows(tabId, pageSize) {
            const tbody = document.querySelector(`#${tabId} table tbody`);
            if (!tbody) return;
            
            const rows = tbody.querySelectorAll('tr');
            
            // 显示所有行，然后根据pageSize隐藏多余的行
            rows.forEach((row, index) => {
                if (index < pageSize) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        // 处理角色变更
        function handleRoleChange() {
            // 检查当前选择的角色是否为平台管理员
            const isPlatformAdmin = document.querySelector('#add-user-modal input[name="role"][value="platform-admin"]').checked;
            
            // 找到管理平台表单组
            const managePlatformGroup = document.querySelector('#manage-platform-select').closest('.form-group');
            
            console.log('角色变更:', isPlatformAdmin ? '平台管理员' : '普通用户');
            console.log('管理平台表单组:', managePlatformGroup);
            
            // 根据角色设置显示/隐藏
            if (isPlatformAdmin) {
                managePlatformGroup.style.display = 'block';
                managePlatformGroup.style.opacity = '1';
                managePlatformGroup.style.visibility = 'visible';
                console.log('显示管理平台选择框');
            } else {
                managePlatformGroup.style.display = 'none';
                console.log('隐藏管理平台选择框');
            }
        }
        
        // 初始化管理平台多选下拉框
        function initManagePlatformSelect() {
            const platformSelect = document.querySelector('#manage-platform-select');
            if (!platformSelect) return;
            
            const header = platformSelect.querySelector('.multi-select-header');
            const dropdown = platformSelect.querySelector('.multi-select-dropdown');
            const options = platformSelect.querySelectorAll('.multi-select-option input');
            const headerText = header.querySelector('span');
            
            // 默认隐藏管理平台选项（除非用户是平台管理员）
            handleRoleChange();
            
            // 切换下拉框显示
            header.addEventListener('click', (e) => {
                e.stopPropagation();
                
                // 关闭其他打开的下拉框
                document.querySelectorAll('.multi-select-dropdown.active').forEach(d => {
                    if (d !== dropdown) {
                        d.classList.remove('active');
                        d.closest('.multi-select').querySelector('.multi-select-header').classList.remove('active');
                    }
                });
                
                // 切换当前下拉框
                dropdown.classList.toggle('active');
                header.classList.toggle('active');
            });
            
            // 处理选项选择
            options.forEach(option => {
                option.addEventListener('change', (e) => {
                    e.stopPropagation();
                    updateManagePlatformHeaderText(platformSelect);
                });
                
                // 防止点击选项时关闭下拉框
                option.parentElement.addEventListener('click', (e) => {
                    e.stopPropagation();
                });
            });
            
            // 初始化标题文本
            updateManagePlatformHeaderText(platformSelect);
        }
        
        // 更新管理平台下拉框标题文本
        function updateManagePlatformHeaderText(select) {
            const header = select.querySelector('.multi-select-header span');
            const options = select.querySelectorAll('.multi-select-option input');
            const selectedOptions = Array.from(options).filter(opt => opt.checked);
            
            if (selectedOptions.length === 0) {
                header.textContent = '请选择管理平台';
            } else if (selectedOptions.length === options.length) {
                header.textContent = '管理所有平台';
            } else if (selectedOptions.length <= 2) {
                const labels = selectedOptions.map(opt => {
                    const text = opt.parentElement.textContent.trim();
                    return text;
                });
                header.textContent = labels.join(', ');
            } else {
                header.textContent = `已选 ${selectedOptions.length} 个平台`;
            }
        }

        // 在页面加载时为管理平台多选框添加样式和事件
        document.addEventListener('DOMContentLoaded', function() {
            // 已有的事件处理...
            
            // 确保管理平台多选框样式正确
            const managePlatformSelect = document.querySelector('#manage-platform-select');
            if (managePlatformSelect) {
                console.log('初始化管理平台多选框样式');
                
                // 确保下拉框的相对定位
                managePlatformSelect.style.position = 'relative';
                
                // 确保多选框下拉菜单的宽度与头部一致
                const dropdown = managePlatformSelect.querySelector('.multi-select-dropdown');
                if (dropdown) {
                    dropdown.style.width = '100%';
                }
            }
        });

        // 用于测试的辅助函数
        function toggleManagePlatform() {
            const managePlatformGroup = document.querySelector('#manage-platform-select').closest('.form-group');
            const currentDisplay = managePlatformGroup.style.display;
            
            if (currentDisplay === 'none') {
                managePlatformGroup.style.display = 'block';
                document.getElementById('manage-platform-status').textContent = '状态: 显示';
            } else {
                managePlatformGroup.style.display = 'none';
                document.getElementById('manage-platform-status').textContent = '状态: 隐藏';
            }
        }

        // 添加DOM观察器以监听模态框的状态变化
        document.addEventListener('DOMContentLoaded', function() {
            // 已有的事件处理...
            
            // 创建模态框可见性变化观察器
            const modalObserver = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.attributeName === 'style') {
                        const modal = document.getElementById('add-user-modal');
                        const isModalVisible = modal.style.display === 'flex';
                        
                        if (isModalVisible) {
                            console.log('模态框显示了，确保管理平台多选框状态正确');
                            
                            // 确保角色选择正确初始化
                            setTimeout(() => {
                                // 确保普通用户单选按钮选中
                                const userRoleRadio = document.querySelector('#add-user-modal input[name="role"][value="user"]');
                                if (userRoleRadio && !userRoleRadio.checked) {
                                    userRoleRadio.checked = true;
                                }
                                
                                // 手动触发角色变更处理
                                handleRoleChange();
                                
                                // 强制设置管理平台组的样式
                                const managePlatformGroup = document.querySelector('#manage-platform-select').closest('.form-group');
                                if (managePlatformGroup) {
                                    // 如果是平台管理员则显示，否则隐藏
                                    const isPlatformAdmin = document.querySelector('#add-user-modal input[name="role"][value="platform-admin"]').checked;
                                    managePlatformGroup.style.display = isPlatformAdmin ? 'block' : 'none';
                                    console.log('设置管理平台多选框状态:', isPlatformAdmin ? '显示' : '隐藏');
                                }
                            }, 200);
                        }
                    }
                });
            });
            
            // 观察模态框的style属性变化
            const modal = document.getElementById('add-user-modal');
            if (modal) {
                modalObserver.observe(modal, { attributes: true, attributeFilter: ['style'] });
            }
        });
    </script>
</body>
</html> 
