<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>耀耀工厂 - 权限管理后台</title>
    <link rel="stylesheet" href="permission-admin.css">
    <style>
        /* 添加到现有样式表或添加到<head>部分 */
        .action-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* 可以添加实际禁用状态的样式 */
        .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* 添加一个样式，用于当复选框处于indeterminate状态时更改外观 */
        input[type="checkbox"]:indeterminate {
            background-color: #e0e0e0;
            border-color: #999;
        }
        
        /* 添加到现有样式 */
        input[type="checkbox"]:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background-color: #f0f0f0;
        }
        
        /* 可以为已处理行添加一个轻微的背景色 */
        #approval-tab tbody tr:has(td:nth-child(9) .status-approved),
        #approval-tab tbody tr:has(td:nth-child(9) .status-rejected) {
            background-color: #f9f9f9;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- 侧边栏 -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <img src="logo.png" alt="耀耀工厂">
                </div>
                <h2>耀耀工厂</h2>
            </div>
            <div class="sidebar-nav">
                <a href="dashboard.html" class="nav-item">
                    <i>📊</i>
                    <span>系统概览</span>
                </a>
                <a href="permission-admin.html" class="nav-item active">
                    <i>🔑</i>
                    <span>权限管理</span>
                </a>
                <a href="system-logs.html" class="nav-item">
                    <i>📝</i>
                    <span>系统日志</span>
                </a>
            </div>
        </div>

        <!-- 主内容区域 -->
        <div class="main-content">
            <!-- 顶部导航 -->
            <div class="top-nav">
                <div class="breadcrumb">
                    权限管理
                </div>
                <div class="user-profile">
                    <div class="user-info" onclick="toggleUserMenu()">
                        <div class="avatar">戴</div>
                        <span class="username">管理员-戴倚凡</span>
                        <i class="dropdown-icon">▼</i>
                    </div>
                    <div class="user-menu" id="userMenu">
                        <div class="menu-item" onclick="logout()">
                            <i class="menu-icon">↩</i>
                            <span>退出登录</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 标签页 -->
            <div class="tabs">
                <div class="tab-item" onclick="showTab('approval')">权限审批</div>
                <div class="tab-item active" onclick="showTab('authorized')">已授权用户</div>
                <div class="tab-item" onclick="showTab('active')">当前登录用户</div>
            </div>

            <!-- 权限审批内容卡片 -->
            <div id="approval-tab" class="card tab-content" style="display: none;">
                <div class="card-header">
                    <h3 class="card-title">权限申请列表</h3>
                </div>
                <div class="card-body">
                    <!-- 筛选区域 -->
                    <div class="filter-area">
                        <div class="filter-item">
                            <label>姓名:</label>
                            <input type="text" placeholder="请输入姓名">
                        </div>
                        <div class="filter-item">
                            <label>工号:</label>
                            <input type="text" placeholder="请输入工号">
                        </div>
                        <div class="filter-item">
                            <label>部门:</label>
                            <select>
                                <option value="">全部</option>
                                <option value="tech">技术部</option>
                                <option value="marketing">市场部</option>
                                <option value="product">产品部</option>
                                <option value="hr">人力资源</option>
                            </select>
                        </div>
                        <div class="filter-item">
                            <label>申请时间:</label>
                            <input type="date" class="date-picker">
                            <span class="date-separator">至</span>
                            <input type="date" class="date-picker">
                        </div>
                        <div class="filter-item">
                            <label>状态:</label>
                            <select>
                                <option value="">全部</option>
                                <option value="pending">待审批</option>
                                <option value="approved">已通过</option>
                                <option value="rejected">已拒绝</option>
                            </select>
                        </div>
                        <div class="filter-item">
                            <label>平台:</label>
                            <div class="multi-select" id="approval-platform-filter">
                                <div class="multi-select-header">
                                    <span>全部</span>
                                    <span class="arrow">▼</span>
                                </div>
                                <div class="multi-select-dropdown">
                                    <div class="multi-select-option">
                                        <input type="checkbox" value="一" checked> 第一平台
                                    </div>
                                    <div class="multi-select-option">
                                        <input type="checkbox" value="二" checked> 第二平台
                                    </div>
                                    <div class="multi-select-option">
                                        <input type="checkbox" value="三" checked> 第三平台
                                    </div>
                                    <div class="multi-select-option">
                                        <input type="checkbox" value="四" checked> 第四平台
                                    </div>
                                    <div class="multi-select-option">
                                        <input type="checkbox" value="五" checked> 第五平台
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="filter-item">
                            <label>角色:</label>
                            <div class="multi-select" id="approval-role-filter">
                                <div class="multi-select-header">
                                    <span>全部</span>
                                    <span class="arrow">▼</span>
                                </div>
                                <div class="multi-select-dropdown">
                                    <div class="multi-select-option">
                                    <input type="checkbox" value="user" checked> 普通用户
                                </div>
                                    <div class="multi-select-option">
                                    <input type="checkbox" value="platform-admin" checked> 平台管理员
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="filter-item">
                            <button class="search-btn">搜索</button>
                            <button class="reset-btn">重置</button>
                        </div>
                    </div>

                    <!-- 批量操作 -->
                    <div class="batch-actions">
                        <button class="action-btn approve-btn">批量通过</button>
                        <button class="action-btn reject-btn">批量拒绝</button>
                    </div>

                    <!-- 表格内容 -->
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th><input type="checkbox"></th>
                                    <th>姓名</th>
                                    <th>工号</th>
                                    <th>部门</th>
                                    <th>平台</th>
                                    <th>角色</th>
                                    <th>申请时间</th>
                                    <th>申请理由</th>
                                    <th>状态</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><input type="checkbox"></td>
                                    <td>张三</td>
                                    <td>ZH001</td>
                                    <td>技术部</td>
                                    <td><span class="platform-badge platform-1">第一平台</span></td>
                                    <td><span class="role-badge role-user">普通用户</span></td>
                                    <td>2024-10-15 14:30</td>
                                    <td>需要使用AI工具提升工作效率</td>
                                    <td><span class="status status-pending">待审批</span></td>
                                    <td>
                                        <button class="action-btn view-btn">查看</button>
                                        <button class="action-btn approve-btn">通过</button>
                                        <button class="action-btn reject-btn">拒绝</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox"></td>
                                    <td>李四</td>
                                    <td>ZH002</td>
                                    <td>市场部</td>
                                    <td><span class="platform-badge platform-2">第二平台</span></td>
                                    <td><span class="role-badge role-user">普通用户</span></td>
                                    <td>2024-10-15 10:15</td>
                                    <td>需要调研AI产品功能</td>
                                    <td><span class="status status-pending">待审批</span></td>
                                    <td>
                                        <button class="action-btn view-btn">查看</button>
                                        <button class="action-btn approve-btn">通过</button>
                                        <button class="action-btn reject-btn">拒绝</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox"></td>
                                    <td>王五</td>
                                    <td>ZH003</td>
                                    <td>产品部</td>
                                    <td><span class="platform-badge platform-3">第三平台</span></td>
                                    <td><span class="role-badge role-user">普通用户</span></td>
                                    <td>2024-07-05 10:00</td>
                                    <td>产品设计需要使用AI助手</td>
                                    <td><span class="status status-approved">已通过</span></td>
                                    <td>
                                        <button class="action-btn view-btn">查看</button>
                                        <!-- <button class="action-btn remove-btn">拒绝</button> -->
                                    </td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox"></td>
                                    <td>赵六</td>
                                    <td>ZH004</td>
                                    <td>人力资源</td>
                                    <td><span class="platform-badge platform-4">第四平台</span></td>
                                    <td><span class="role-badge role-user">普通用户</span></td>
                                    <td>2024-09-30 09:30</td>
                                    <td>需要使用系统管理员工培训数据</td>
                                    <td><span class="status status-rejected">已拒绝</span></td>
                                    <td>
                                        <button class="action-btn view-btn">查看</button>
                                        <!-- <button class="action-btn approve-btn">通过</button> -->
                                    </td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox"></td>
                                    <td>钱七</td>
                                    <td>ZH005</td>
                                    <td>技术部</td>
                                    <td><span class="platform-badge platform-5">第五平台</span></td>
                                    <td><span class="role-badge role-user">普通用户</span></td>
                                    <td>2024-10-01 09:30</td>
                                    <td>开发需要使用AI接口</td>
                                    <td><span class="status status-pending">待审批</span></td>
                                    <td>
                                        <button class="action-btn view-btn">查看</button>
                                        <button class="action-btn approve-btn">通过</button>
                                        <button class="action-btn reject-btn">拒绝</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- 分页 -->
                    <div class="pagination">
                        <button>&lt;</button>
                        <button class="active">1</button>
                        <button>2</button>
                        <button>3</button>
                        <button>&gt;</button>
                    </div>
                </div>
            </div>

            <!-- 已授权用户内容卡片 -->
            <div id="authorized-tab" class="card tab-content">
                <div class="card-header">
                    <h3 class="card-title">已授权用户列表</h3>
                    <button class="add-btn"  onclick="showAddUserModal()"">+ 添加用户权限</button>
                </div>
                <div class="card-body">
                    <!-- 筛选区域 -->
                    <div class="filter-area">
                        <div class="filter-item">
                            <label>姓名:</label>
                            <input type="text" placeholder="请输入姓名">
                        </div>
                        <div class="filter-item">
                            <label>工号:</label>
                            <input type="text" placeholder="请输入工号">
                        </div>
                        <div class="filter-item">
                            <label>部门:</label>
                            <select>
                                <option value="">全部</option>
                                <option value="tech">技术部</option>
                                <option value="marketing">市场部</option>
                                <option value="product">产品部</option>
                                <option value="hr">人力资源</option>
                            </select>
                        </div>
                        <div class="filter-item">
                            <label>授权时间:</label>
                            <input type="date" class="date-picker">
                            <span class="date-separator">至</span>
                            <input type="date" class="date-picker">
                        </div>
                        <div class="filter-item">
                            <label>平台:</label>
                            <div class="multi-select" id="authorized-platform-filter">
                                <div class="multi-select-header">
                                    <span>全部</span>
                                    <span class="arrow">▼</span>
                                </div>
                                <div class="multi-select-dropdown">
                                    <div class="multi-select-option">
                                        <input type="checkbox" value="一" checked> 第一平台
                                    </div>
                                    <div class="multi-select-option">
                                        <input type="checkbox" value="二" checked> 第二平台
                                    </div>
                                    <div class="multi-select-option">
                                        <input type="checkbox" value="三" checked> 第三平台
                                    </div>
                                    <div class="multi-select-option">
                                        <input type="checkbox" value="四" checked> 第四平台
                                    </div>
                                    <div class="multi-select-option">
                                        <input type="checkbox" value="五" checked> 第五平台
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="filter-item">
                            <label>角色:</label>
                            <div class="multi-select" id="authorized-role-filter">
                                <div class="multi-select-header">
                                    <span>全部</span>
                                    <span class="arrow">▼</span>
                                </div>
                                <div class="multi-select-dropdown">
                                    <div class="multi-select-option">
                                        <input type="checkbox" value="user" checked> 普通用户
                                    </div>
                                    <div class="multi-select-option">
                                        <input type="checkbox" value="platform-admin" checked> 平台管理员
                                    </div>
                                    <div class="multi-select-option">
                                        <input type="checkbox" value="admin" checked> 超级管理员
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="filter-item filter-buttons">
                            <button class="search-btn">搜索</button>
                            <button class="reset-btn">重置</button>
                        </div>
                    </div>

                    <!-- 添加批量操作区域 -->
                    <div class="batch-actions">
                        <button class="action-btn remove-btn">批量收回权限</button>
                    </div>

                    <!-- 表格内容 -->
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th><input type="checkbox"></th>
                                    <th>姓名</th>
                                    <th>工号</th>
                                    <th>部门</th>
                                    <th>平台</th>
                                    <th>角色</th>
                                    <th>授权时间</th>
                                    <th>最近登录</th>
                                    <th>访问次数</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><input type="checkbox"></td>
                                    <td>张三</td>
                                    <td>ZH001</td>
                                    <td>技术部</td>
                                    <td><span class="platform-badge platform-1">第一平台</span></td>
                                    <td><span class="role-badge role-user">普通用户</span></td>
                                    <td>2024-09-15</td>
                                    <td>2024-10-15 14:30</td>
                                    <td>42次</td>
                                    <td>
                                        <button class="action-btn view-btn">查看</button>
                                        <button class="action-btn remove-btn">收回权限</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox"></td>
                                    <td>李四</td>
                                    <td>ZH002</td>
                                    <td>市场部</td>
                                    <td><span class="platform-badge platform-2">第二平台</span></td>
                                    <td><span class="role-badge role-platform-admin">平台管理员</span></td>
                                    <td>2024-08-20</td>
                                    <td>2024-10-15 09:15</td>
                                    <td>68次</td>
                                    <td>
                                        <button class="action-btn view-btn">查看</button>
                                        <button class="action-btn remove-btn">收回权限</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox"></td>
                                    <td>王五</td>
                                    <td>ZH003</td>
                                    <td>产品部</td>
                                    <td><span class="platform-badge platform-3">第三平台</span></td>
                                    <td><span class="role-badge role-user">普通用户</span></td>
                                    <td>2024-07-05</td>
                                    <td>2024-10-14 16:45</td>
                                    <td>126次</td>
                                    <td>
                                        <button class="action-btn view-btn">查看</button>
                                        <button class="action-btn remove-btn">收回权限</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox"></td>
                                    <td>赵六</td>
                                    <td>ZH004</td>
                                    <td>人力资源</td>
                                    <td><span class="platform-badge platform-4">第四平台</span></td>
                                    <td><span class="role-badge role-user">普通用户</span></td>
                                    <td>2024-09-30</td>
                                    <td>2024-10-13 11:20</td>
                                    <td>18次</td>
                                    <td>
                                        <button class="action-btn view-btn">查看</button>
                                        <button class="action-btn remove-btn">收回权限</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox"></td>
                                    <td>钱七</td>
                                    <td>ZH005</td>
                                    <td>技术部</td>
                                    <td><span class="platform-badge platform-5">第五平台</span></td>
                                    <td><span class="role-badge role-user">普通用户</span></td>
                                    <td>2024-10-01</td>
                                    <td>2024-10-15 08:30</td>
                                    <td>24次</td>
                                    <td>
                                        <button class="action-btn view-btn">查看</button>
                                        <button class="action-btn remove-btn">收回权限</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- 分页 -->
                    <div class="pagination">
                        <button>&lt;</button>
                        <button class="active">1</button>
                        <button>2</button>
                        <button>3</button>
                        <button>&gt;</button>
                    </div>
                </div>
            </div>

            <!-- 当前登录用户内容卡片 -->
            <div id="active-tab" class="card tab-content" style="display: none;">
                <div class="card-header">
                    <h3 class="card-title">当前登录用户</h3>
                </div>
                <div class="card-body">
                    <!-- 筛选区域 -->
                    <div class="filter-area">
                        <div class="filter-item">
                            <label>姓名:</label>
                            <input type="text" placeholder="请输入姓名">
                        </div>
                        <div class="filter-item">
                            <label>工号:</label>
                            <input type="text" placeholder="请输入工号">
                        </div>
                        <div class="filter-item">
                            <label>部门:</label>
                            <select>
                                <option value="">全部</option>
                                <option value="tech">技术部</option>
                                <option value="marketing">市场部</option>
                                <option value="product">产品部</option>
                                <option value="hr">人力资源</option>
                            </select>
                        </div>
                        <div class="filter-item">
                            <label>平台:</label>
                            <div class="multi-select" id="platform-filter">
                                <div class="multi-select-header">
                                    <span>全部</span>
                                    <span class="arrow">▼</span>
                                </div>
                                <div class="multi-select-dropdown">
                                    <div class="multi-select-option">
                                        <input type="checkbox" value="一" checked> 第一平台
                                    </div>
                                    <div class="multi-select-option">
                                        <input type="checkbox" value="二" checked> 第二平台
                                    </div>
                                    <div class="multi-select-option">
                                        <input type="checkbox" value="三" checked> 第三平台
                                    </div>
                                    <div class="multi-select-option">
                                        <input type="checkbox" value="四" checked> 第四平台
                                    </div>
                                    <div class="multi-select-option">
                                        <input type="checkbox" value="五" checked> 第五平台
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="filter-item">
                            <label>角色:</label>
                            <div class="multi-select" id="role-filter">
                                <div class="multi-select-header">
                                    <span>全部</span>
                                    <span class="arrow">▼</span>
                                </div>
                                <div class="multi-select-dropdown">
                                    <div class="multi-select-option">
                                        <input type="checkbox" value="user" checked> 普通用户
                                    </div>
                                    <div class="multi-select-option">
                                        <input type="checkbox" value="platform-admin" checked> 平台管理员
                                    </div>
                                    <div class="multi-select-option">
                                        <input type="checkbox" value="admin" checked> 超级管理员
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="filter-item">
                            <label>登录时间:</label>
                            <input type="date" class="date-picker">
                            <span class="date-separator">至</span>
                            <input type="date" class="date-picker">
                        </div>
                        <div class="filter-item">
                            <button class="search-btn">搜索</button>
                            <button class="reset-btn">重置</button>
                        </div>
                    </div>

                    <!-- 添加批量操作区域 -->
                    <div class="batch-actions">
                        <button class="action-btn force-logout-btn">批量强制退出</button>
                    </div>

                    <!-- 表格内容 -->
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th><input type="checkbox"></th>
                                    <th>姓名</th>
                                    <th>工号</th>
                                    <th>部门</th>
                                    <th>平台</th>
                                    <th>角色</th>
                                    <th>登录时间</th>
                                    <th>IP地址</th>
                                    <th>登录设备</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><input type="checkbox"></td>
                                    <td>张三</td>
                                    <td>ZH001</td>
                                    <td>技术部</td>
                                    <td><span class="platform-badge platform-1">第一平台</span></td>
                                    <td><span class="role-badge role-user">普通用户</span></td>
                                    <td>2024-10-15 14:30</td>
                                    <td>192.168.1.101</td>
                                    <td>Chrome Windows</td>
                                    <td>
                                        <button class="action-btn view-btn">查看详情</button>
                                        <button class="action-btn force-logout-btn">强制登出</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox"></td>
                                    <td>李四</td>
                                    <td>ZH002</td>
                                    <td>市场部</td>
                                    <td><span class="platform-badge platform-2">第二平台</span></td>
                                    <td><span class="role-badge role-platform-admin">平台管理员</span></td>
                                    <td>2024-10-15 09:15</td>
                                    <td>192.168.1.102</td>
                                    <td>Safari MacOS</td>
                                    <td>
                                        <button class="action-btn view-btn">查看详情</button>
                                        <button class="action-btn force-logout-btn">强制登出</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox"></td>
                                    <td>王五</td>
                                    <td>ZH003</td>
                                    <td>产品部</td>
                                    <td><span class="platform-badge platform-3">第三平台</span></td>
                                    <td><span class="role-badge role-user">普通用户</span></td>
                                    <td>2024-10-15 10:45</td>
                                    <td>192.168.1.103</td>
                                    <td>Edge Windows</td>
                                    <td>
                                        <button class="action-btn view-btn">查看详情</button>
                                        <button class="action-btn force-logout-btn">强制登出</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox"></td>
                                    <td>赵六</td>
                                    <td>ZH004</td>
                                    <td>人力资源</td>
                                    <td><span class="platform-badge platform-4">第四平台</span></td>
                                    <td><span class="role-badge role-user">普通用户</span></td>
                                    <td>2024-10-15 11:30</td>
                                    <td>192.168.1.104</td>
                                    <td>Firefox Linux</td>
                                    <td>
                                        <button class="action-btn view-btn">查看详情</button>
                                        <button class="action-btn force-logout-btn">强制登出</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox"></td>
                                    <td>钱七</td>
                                    <td>ZH005</td>
                                    <td>技术部</td>
                                    <td><span class="platform-badge platform-5">第五平台</span></td>
                                    <td><span class="role-badge role-user">普通用户</span></td>
                                    <td>2024-10-15 08:30</td>
                                    <td>192.168.1.105</td>
                                    <td>Chrome Android</td>
                                    <td>
                                        <button class="action-btn view-btn">查看详情</button>
                                        <button class="action-btn force-logout-btn">强制登出</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 用户详情弹窗 -->
            <div id="user-detail-modal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>申请详情 - 张三</h3>
                        <span class="close-btn">&times;</span>
                    </div>
                    <div class="modal-body">
                        <div class="detail-section">
                            <h4>申请信息</h4>
                            <div class="detail-grid">
                                <div class="detail-item">
                                    <div class="detail-label">申请人</div>
                                    <div class="detail-value">张三</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">所属部门</div>
                                    <div class="detail-value">技术部</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">工号</div>
                                    <div class="detail-value">ZH001</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">岗位名称</div>
                                    <div class="detail-value">高级开发工程师</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">邮箱</div>
                                    <div class="detail-value">zhangsan@example.com</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">申请时间</div>
                                    <div class="detail-value">2024-10-15 14:30</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">申请时长</div>
                                    <div class="detail-value">30天</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">状态</div>
                                    <div class="detail-value">待审批</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="detail-section">
                            <h4>申请原因</h4>
                            <div class="detail-remarks">
                                需要使用AI工具提升工作效率
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 审批操作弹窗 -->
            <div id="approval-action-modal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>审批操作</h3>
                        <span class="close-btn">&times;</span>
                    </div>
                    <div class="modal-body">
                        <div class="approval-form">
                            <div class="form-group">
                                <label for="approval-comment">审批意见</label>
                                <textarea id="approval-comment" rows="3" placeholder="请输入您的审批意见..."></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="modal-btn submit-btn">提交</button>
                        <button class="modal-btn cancel-btn">关闭</button>
                    </div>
                </div>
            </div>

            <!-- 修改添加用户权限弹窗，改为先根据邮箱查找用户，再确认添加 -->
            <div class="modal" id="add-user-modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>添加用户权限</h3>
                        <button class="close-btn" onclick="closeAddUserModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <form id="addUserForm">
                            <!-- 第一步：邮箱搜索表单 -->
                            <div id="step-search" style="display: block;">
                                <div class="form-group">
                                    <label class="form-label required">用户邮箱</label>
                                    <div class="email-search-container">
                                        <input type="email" class="form-input" id="search-email" placeholder="请输入企业邮箱进行查找" required>
                                        <!-- <button type="button" class="search-user-btn" onclick="searchUserByEmail()">查找用户</button> -->
                                    </div>
                                    <span class="field-hint">请输入用户的完整企业邮箱，将从企业IM系统中查找对应的用户信息</span>
                                </div>
                                <div id="email-search-message" class="search-message" style="display: none;"></div>
                            </div>

                            <!-- 第二步：用户信息确认和授权设置 -->
                            <div id="step-confirm" style="display: none;">
                                <div class="form-group">
                                    <div class="section-header">
                                        <label class="form-label">查找到的用户信息</label>
                                        <button type="button" class="back-btn" onclick="backToSearch()">返回重新查找</button>
                                    </div>
                                    <div class="user-info-card">
                                        <div class="user-avatar">
                                            <div class="avatar-placeholder">
                                                <span id="user-initials">--</span>
                                            </div>
                                        </div>
                                        <div class="user-details">
                                            <div class="detail-row">
                                                <span class="detail-label">姓名:</span>
                                                <span class="detail-value" id="user-name">--</span>
                                            </div>
                                            <div class="detail-row">
                                                <span class="detail-label">工号:</span>
                                                <span class="detail-value" id="user-employeeId">--</span>
                                            </div>
                                            <div class="detail-row">
                                                <span class="detail-label">部门:</span>
                                                <span class="detail-value" id="user-department">--</span>
                                            </div>
                                            <div class="detail-row">
                                                <span class="detail-label">岗位:</span>
                                                <span class="detail-value" id="user-position">--</span>
                                            </div>
                                            <div class="detail-row">
                                                <span class="detail-label">邮箱:</span>
                                                <span class="detail-value" id="user-email">--</span>
                                            </div>
                                            <!-- 添加所属平台 -->
                                            <div class="detail-row">
                                                <span class="detail-label">所属平台:</span>
                                                <span class="detail-value" id="user-platform">
                                                    <span class="platform-badge platform-1">第一平台</span>
                                                </span>
                                                <input type="hidden" name="platform" id="platform-input" value="1">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="confirm-message">
                                        <p>请确认以上用户信息是否正确，如不正确请返回重新查找</p>
                                    </div>
                                </div>
                                
                                <div class="form-group role-selection-group" id="roleSelectionGroup">
                                    <label class="form-label required">用户角色</label>
                                    <div class="role-options">
                                        <div class="role-option">
                                            <label class="role-option-label">
                                                <input type="radio" name="role" value="user" checked>
                                                <div>
                                                    <div class="role-option-title">普通用户</div>
                                                    <div class="role-option-desc">可以使用平台的基本功能，无管理权限</div>
                                                </div>
                                            </label>
                                        </div>
                                        <div class="role-option" id="platformAdminOption">
                                            <label class="role-option-label">
                                                <input type="radio" name="role" value="platform-admin">
                                                <div>
                                                    <div class="role-option-title">平台管理员</div>
                                                    <div class="role-option-desc">可以管理所在平台的用户和审批权限申请</div>
                                                </div>
                                            </label>
                                        </div>
                                    </div>
                                    <span class="field-hint">选择适合的用户角色，不同角色具有不同的权限</span>
                                    <span class="field-hint">只有超级管理员可以看到这项，平台管理员只能开通普通用户权限</span>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label required">授权时长</label>
                                    <select class="form-select" name="duration" required>
                                        <option value="3days">3天</option>
                                        <option value="7days">7天</option>
                                        <option value="30days" selected>30天</option>
                                        <option value="60days">60天</option>
                                        <option value="90days">90天</option>
                                        <option value="1year">1年</option>
                                        <option value="permanent">长期</option>
                                    </select>
                                    <span class="field-hint">选择适合的授权时长，到期后将自动收回权限</span>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label required">授权备注</label>
                                    <textarea class="form-input" name="reason" placeholder="请详细说明授权原因、业务需求或用途..." required></textarea>
                                    <span class="field-hint">详细的说明有助于记录和追踪权限授予的原因，也便于以后的权限审计</span>
                                </div>
                            </div>
                            
                            <div class="form-actions">
                                <button type="button" class="btn btn-default" onclick="closeAddUserModal()">取消</button>
                                <button type="button" id="step-search-btn" class="btn btn-primary" style="display: none;" onclick="searchUserByEmail()">查找用户</button>
                                <button type="button" id="step-confirm-btn" class="btn btn-primary" style="display: none;" onclick="addUser()">确认添加</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 页面加载时显示默认标签页
        document.addEventListener('DOMContentLoaded', function() {
            // 修改默认显示为权限审批标签页
            showTab('approval');
            
            // 确保模态框初始隐藏
            const modal = document.getElementById('user-detail-modal');
            if (modal) {
                modal.style.display = 'none';
            }
            
            // 使用正确的选择器绑定查看按钮事件
            const viewButtons = document.querySelectorAll('.view-btn');
            viewButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // 获取当前行的数据
                    const row = this.closest('tr');
                    const name = row.querySelector('td:nth-child(2)').textContent;
                    const jobId = row.querySelector('td:nth-child(3)').textContent;
                    const department = row.querySelector('td:nth-child(4)').textContent;
                    const applyTime = row.querySelector('td:nth-child(5)').textContent;
                    const reason = row.querySelector('td:nth-child(6)').textContent;
                    const statusEl = row.querySelector('td:nth-child(7) .status');
                    const status = statusEl ? statusEl.textContent : '待审批';
                    
                    // 根据不同用户设置不同信息
                    let email = '';
                    let position = '';
                    let duration = '30天';
                    
                    if (name === '张三') {
                        email = 'zhangsan@example.com';
                        position = '高级开发工程师';
                    } else if (name === '李四') {
                        email = 'lisi@example.com';
                        position = '市场专员';
                        duration = '7天';
                    } else if (name === '王五') {
                        email = 'wangwu@example.com';
                        position = '产品经理';
                        duration = '90天';
                    } else if (name === '赵六') {
                        email = 'zhaoliu@example.com';
                        position = 'HR专员';
                        duration = '1年';
                    } else if (name === '钱七') {
                        email = 'qianqi@example.com';
                        position = '开发工程师';
                        duration = '60天';
                    }
                    
                    // 更新模态框内容 - 使用HTML模板
                    modal.querySelector('.modal-content').innerHTML = `
                        <div class="modal-header">
                            <h3>申请详情 - ${name}</h3>
                            <span class="close-btn">&times;</span>
                        </div>
                        <div class="modal-body">
                            <div class="detail-section">
                                <h4>申请信息</h4>
                                <div class="detail-grid">
                                    <div class="detail-item">
                                        <div class="detail-label">申请人</div>
                                        <div class="detail-value">${name}</div>
                                    </div>
                                    <div class="detail-item">
                                        <div class="detail-label">所属部门</div>
                                        <div class="detail-value">${department}</div>
                                    </div>
                                    <div class="detail-item">
                                        <div class="detail-label">工号</div>
                                        <div class="detail-value">${jobId}</div>
                                    </div>
                                    <div class="detail-item">
                                        <div class="detail-label">岗位名称</div>
                                        <div class="detail-value">${position}</div>
                                    </div>
                                    <div class="detail-item">
                                        <div class="detail-label">邮箱</div>
                                        <div class="detail-value">${email}</div>
                                    </div>
                                    <div class="detail-item">
                                        <div class="detail-label">申请时间</div>
                                        <div class="detail-value">${applyTime}</div>
                                    </div>
                                    <div class="detail-item">
                                        <div class="detail-label">申请时长</div>
                                        <div class="detail-value">${duration}</div>
                                    </div>
                                    <div class="detail-item">
                                        <div class="detail-label">状态</div>
                                        <div class="detail-value">${status}</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="detail-section">
                                <h4>申请原因</h4>
                                <div class="detail-remarks">
                                    ${reason}
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // 为新生成的关闭按钮添加事件
                    const newCloseBtn = modal.querySelector('.close-btn');
                    if (newCloseBtn) {
                        newCloseBtn.addEventListener('click', function() {
                            modal.style.display = 'none';
                        });
                    }
                    
                    // 显示模态框
                    modal.style.display = 'flex';
                });
            });
            
            // 点击模态框外部关闭
            window.addEventListener('click', function(event) {
                const modal = document.getElementById('user-detail-modal');
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        });

        function showTab(tabName) {
            // 隐藏所有tab内容
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.style.display = 'none';
            });
            
            // 显示选中的tab内容
            document.getElementById(tabName + '-tab').style.display = 'block';
            
            // 更新tab状态
            document.querySelectorAll('.tab-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // 找到对应的tab项并添加active类
            const tabs = document.querySelectorAll('.tab-item');
            switch(tabName) {
                case 'approval':
                    tabs[0].classList.add('active');
                    break;
                case 'authorized':
                    tabs[1].classList.add('active');
                    break;
                case 'active':
                    tabs[2].classList.add('active');
                    break;
            }
        }
        
        // 为标签项添加点击事件监听器
        document.querySelectorAll('.tab-item').forEach((tab, index) => {
            tab.addEventListener('click', function() {
                const tabNames = ['approval', 'authorized', 'active'];
                showTab(tabNames[index]);
            });
        });

        function toggleUserMenu() {
            const menu = document.getElementById('userMenu');
            if (menu.style.display === 'block') {
                menu.style.display = 'none';
            } else {
                menu.style.display = 'block';
            }
        }

        // 点击页面其他地方关闭菜单
        document.addEventListener('click', function(event) {
            const userInfo = document.querySelector('.user-info');
            const userMenu = document.getElementById('userMenu');
            
            if (!userInfo.contains(event.target) && userMenu.style.display === 'block') {
                userMenu.style.display = 'none';
            }
        }, true);

        function logout() {
            if (confirm('确定要退出登录吗？')) {
                window.location.href = 'login.html';
            }
        }

        // 审批操作弹窗功能
        document.addEventListener('DOMContentLoaded', function() {
            // 获取模态框元素
            const approvalModal = document.getElementById('approval-action-modal');
            
            // 确保审批模态框初始隐藏
            if (approvalModal) {
                approvalModal.style.display = 'none';
            }
            
            // 保存当前操作类型(通过/拒绝)
            let currentAction = '';
            
            // 获取通过和拒绝按钮
            const approveButtons = document.querySelectorAll('.approve-btn');
            const rejectButtons = document.querySelectorAll('.reject-btn');
            
            // 为通过按钮添加事件监听器
            approveButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // 设置当前操作为通过
                    currentAction = 'approve';
                    
                    // 设置模态框标题
                    approvalModal.querySelector('.modal-header h3').textContent = '审批通过';
                    
                    // 显示模态框
                    approvalModal.style.display = 'flex';
                    
                    // 聚焦到文本框
                    setTimeout(() => {
                        document.getElementById('approval-comment').focus();
                    }, 100);
                });
            });
            
            // 为拒绝按钮添加事件监听器
            rejectButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // 设置当前操作为拒绝
                    currentAction = 'reject';
                    
                    // 设置模态框标题
                    approvalModal.querySelector('.modal-header h3').textContent = '审批拒绝';
                    
                    // 显示模态框
                    approvalModal.style.display = 'flex';
                    
                    // 聚焦到文本框
                    setTimeout(() => {
                        document.getElementById('approval-comment').focus();
                    }, 100);
                });
            });
            
            // 为提交按钮添加事件监听器
            const submitBtn = approvalModal.querySelector('.submit-btn');
            if (submitBtn) {
                submitBtn.addEventListener('click', function() {
                    // 获取审批意见
                    const comment = document.getElementById('approval-comment').value.trim();
                    
                    // 执行审批操作（这里只是简单的提示，实际中应该向后端发送请求）
                    if (currentAction === 'approve') {
                        alert('已审批通过！\n审批意见: ' + (comment || '无'));
                    } else if (currentAction === 'reject') {
                        alert('已审批拒绝！\n拒绝理由: ' + (comment || '无'));
                    }
                    
                    // 关闭模态框
                    approvalModal.style.display = 'none';
                    
                    // 清空文本框
                    document.getElementById('approval-comment').value = '';
                });
            }
            
            // 为关闭按钮添加事件监听器
            const closeButtons = approvalModal.querySelectorAll('.close-btn, .cancel-btn');
            closeButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // 关闭模态框
                    approvalModal.style.display = 'none';
                    
                    // 清空文本框
                    document.getElementById('approval-comment').value = '';
                });
            });
            
            // 点击模态框外部关闭
            window.addEventListener('click', function(event) {
                if (event.target === approvalModal) {
                    approvalModal.style.display = 'none';
                    
                    // 清空文本框
                    document.getElementById('approval-comment').value = '';
                }
            });
        });

        // 显示添加用户弹窗 - 修改为显示第一步
        function showAddUserModal() {
            const modal = document.getElementById('add-user-modal');
            
            // 重置表单状态
            document.getElementById('step-search').style.display = 'block';
            document.getElementById('step-confirm').style.display = 'none';
            document.getElementById('step-search-btn').style.display = 'block';
            document.getElementById('step-confirm-btn').style.display = 'none';
            
            // 清空邮箱搜索框
            document.getElementById('search-email').value = '';
            
            // 隐藏搜索消息
            const searchMessage = document.getElementById('email-search-message');
            searchMessage.style.display = 'none';
            searchMessage.className = 'search-message';
            searchMessage.textContent = '';
            
            modal.style.display = 'flex';
            
            // Initialize role selection when modal opens
            initRoleSelection();
        }

        // 关闭添加用户弹窗
        function closeAddUserModal() {
            const modal = document.getElementById('add-user-modal');
            modal.style.display = 'none';
            
            // 重置表单
            document.getElementById('addUserForm').reset();
        }

        // 根据邮箱查找用户
        function searchUserByEmail() {
            const email = document.getElementById('search-email').value.trim();
            const searchMessage = document.getElementById('email-search-message');
            
            // 验证邮箱格式
            if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                searchMessage.className = 'search-message error';
                searchMessage.textContent = '请输入有效的企业邮箱地址';
                searchMessage.style.display = 'block';
                return;
            }
            
            // 显示加载状态
            searchMessage.className = 'search-message loading';
            searchMessage.textContent = '正在查询用户信息，请稍候...';
            searchMessage.style.display = 'block';
            
            // 模拟API请求延迟
            setTimeout(() => {
                // 这里是模拟的用户数据，实际应该从API获取
                const userData = mockSearchUserByEmail(email);
                
                if (userData) {
                    // 用户找到了，填充用户信息
                    populateUserInfo(userData);
                    
                    // 切换到第二步
                    document.getElementById('step-search').style.display = 'none';
                    document.getElementById('step-confirm').style.display = 'block';
                    document.getElementById('step-search-btn').style.display = 'none';
                    document.getElementById('step-confirm-btn').style.display = 'block';
                    
                    // 隐藏搜索消息
                    searchMessage.style.display = 'none';
                    
                    // Initialize role selection
                    initRoleSelection();
                } else {
                    // 用户未找到
                    searchMessage.className = 'search-message error';
                    searchMessage.textContent = '未找到此邮箱对应的用户，请检查邮箱地址是否正确';
                    searchMessage.innerHTML += '<br>样例: zhangsan@example.com, lisi@example.com';
                    searchMessage.style.display = 'block';
                }
            }, 1000); // 模拟1秒延迟
        }

        // 模拟根据邮箱搜索用户（实际实现中应该调用后端API）
        function mockSearchUserByEmail(email) {
            // 模拟的用户数据库
            const users = {
                'zhangsan@example.com': {
                    name: '张三',
                    employeeId: 'EMP1001',
                    department: '技术部',
                    position: '后端开发工程师',
                    email: 'zhangsan@example.com',
                    platform: '一'  // 添加平台信息
                },
                'lisi@example.com': {
                    name: '李四',
                    employeeId: 'EMP1002',
                    department: '集团科技管理部',
                    position: '产品经理',
                    email: 'lisi@example.com',
                    platform: '二'  // 添加平台信息
                },
                'wangwu@example.com': {
                    name: '王五',
                    employeeId: 'EMP1003',
                    department: '产品部',
                    position: '产品经理',
                    email: 'wangwu@example.com',
                    platform: '三'  // 添加平台信息
                },
                'zhaoliu@example.com': {
                    name: '赵六',
                    employeeId: 'EMP1004',
                    department: '人力资源',
                    position: 'HR专员',
                    email: 'zhaoliu@example.com',
                    platform: '四'  // 添加平台信息
                }
            };
            
            // 返回找到的用户或null
            return users[email] || null;
        }

        // 填充用户信息到确认页面
        function populateUserInfo(userData) {
            document.getElementById('user-name').textContent = userData.name;
            document.getElementById('user-employeeId').textContent = userData.employeeId;
            document.getElementById('user-department').textContent = userData.department;
            document.getElementById('user-position').textContent = userData.position;
            document.getElementById('user-email').textContent = userData.email;
            
            // 设置用户的平台信息
            const platformElement = document.getElementById('user-platform');
            const platformInput = document.getElementById('platform-input');
            const platformNumber = userData.platform || '一'; // 如果未指定平台，默认为第一平台
            
            platformElement.innerHTML = `<span class="platform-badge platform-${platformNumber}">第${platformNumber}平台</span>`;
            platformInput.value = platformNumber;
            
            // 设置头像缩写
            if (userData.name) {
                const initials = userData.name.substring(0, 1);
                document.getElementById('user-initials').textContent = initials;
            }
        }

        // 返回到搜索步骤
        function backToSearch() {
            document.getElementById('step-search').style.display = 'block';
            document.getElementById('step-confirm').style.display = 'none';
            document.getElementById('step-search-btn').style.display = 'block';
            document.getElementById('step-confirm-btn').style.display = 'none';
        }

        // 添加用户（确认步骤后）
        function addUser() {
            // 获取用户信息
            const name = document.getElementById('user-name').textContent;
            const employeeId = document.getElementById('user-employeeId').textContent;
            const department = document.getElementById('user-department').textContent;
            const position = document.getElementById('user-position').textContent;
            const email = document.getElementById('user-email').textContent;
            
            // 获取授权信息
            const duration = document.querySelector('#add-user-modal select[name="duration"]').value;
            const reason = document.querySelector('#add-user-modal textarea[name="reason"]').value.trim();
            
            // 获取平台和角色
            const platform = document.getElementById('platform-input').value;
            const role = document.querySelector('#add-user-modal input[name="role"]:checked').value;
            
            // 验证授权理由
            if (!reason) {
                alert('请填写授权备注');
                return;
            }
            
            // 构建添加用户数据
            const userData = {
                user: {
                    name: name,
                    employeeId: employeeId,
                    department: department,
                    position: position,
                    email: email
                },
                duration: duration,
                reason: reason,
                platform: platform,
                role: role,
                addTime: new Date().toISOString()
            };
            
            console.log('添加用户权限数据:', userData);
            
            // 模拟添加成功 - 添加到已授权用户列表中
            const authorizedTable = document.querySelector('#authorized-tab table tbody');
            
            // 生成权限到期日期
            const today = new Date();
            let expiryDate = new Date(today);
            
            switch(duration) {
                case '3days':
                    expiryDate.setDate(today.getDate() + 3);
                    break;
                case '7days':
                    expiryDate.setDate(today.getDate() + 7);
                    break;
                case '30days':
                    expiryDate.setDate(today.getDate() + 30);
                    break;
                case '60days':
                    expiryDate.setDate(today.getDate() + 60);
                    break;
                case '90days':
                    expiryDate.setDate(today.getDate() + 90);
                    break;
                case '1year':
                    expiryDate.setFullYear(today.getFullYear() + 1);
                    break;
                case 'permanent':
                    expiryDate = '永久';
                    break;
            }
            
            const expiryFormatted = expiryDate === '永久' ? '永久' : 
                `${expiryDate.getFullYear()}-${(expiryDate.getMonth()+1).toString().padStart(2, '0')}-${expiryDate.getDate().toString().padStart(2, '0')}`;
            
            const now = new Date();
            const dateFormatted = `${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2, '0')}-${now.getDate().toString().padStart(2, '0')}`;
            
            // 创建新行
            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td><input type="checkbox"></td>
                <td>${name}</td>
                <td>${employeeId}</td>
                <td>${department}</td>
                <td><span class="platform-badge platform-${platform}">第${platform}平台</span></td>
                <td><span class="role-badge ${role === 'user' ? 'role-user' : role === 'platform-admin' ? 'role-platform-admin' : 'role-admin'}">${role === 'user' ? '普通用户' : role === 'platform-admin' ? '平台管理员' : '超级管理员'}</span></td>
                <td>${dateFormatted}</td>
                <td>${expiryFormatted}</td>
                <td>
                    <div class="status status-active">0次</div>
                </td>
                <td>
                    <button class="action-btn view-btn">查看</button>
                    <button class="action-btn remove-btn">收回权限</button>
                </td>
            `;
            
            // 将新行添加到表格顶部
            if (authorizedTable) {
                authorizedTable.insertBefore(newRow, authorizedTable.firstChild);
                
                // 绑定新行上的按钮事件
                const viewBtn = newRow.querySelector('.view-btn');
                const revokeBtn = newRow.querySelector('.remove-btn');
                
                if (viewBtn) {
                    viewBtn.addEventListener('click', function() {
                        // 显示用户详情
                        showUserDetail(name, employeeId, department, dateFormatted, reason, '0次');
                    });
                }
                
                if (revokeBtn) {
                    revokeBtn.addEventListener('click', function() {
                        if (confirm(`确定要收回 ${name} 的权限吗？`)) {
                            // 删除整行，而不只是更改状态
                            authorizedTable.removeChild(newRow);
                            // 显示收回成功的消息
                            alert(`已成功收回 ${name} 的权限`);
                        }
                    });
                }
            }
            
            // 关闭弹窗
            alert('用户权限添加成功');
            closeAddUserModal();
        }

        // Function to check if current user is super admin
        function isSuperAdmin() {
            // In real implementation, this would check the current user's role from session/API
            // For demo purposes, we'll assume the current user is a super admin
            return true;
        }
        
        // Handle platform change
        function handlePlatformChange() {
            const platformSelect = document.querySelector('.platform-select');
            const platformAdminOption = document.getElementById('platformAdminOption');
            
            if (platformSelect && platformAdminOption) {
                // Only enable platform admin role for super admins on any platform
                // or platform admins on their own platform
                if (isSuperAdmin()) {
                    platformAdminOption.classList.remove('disabled');
                    platformAdminOption.querySelector('input').disabled = false;
                } else {
                    // For non-super admins, disable platform admin option
                    platformAdminOption.classList.add('disabled');
                    platformAdminOption.querySelector('input').disabled = true;
                    // Ensure "user" option is selected
                    document.querySelector('input[name="role"][value="user"]').checked = true;
                }
            }
        }
        
        // Initialize role selection when tab is switched or form is shown
        function initRoleSelection() {
            // Apply initial state for role selection based on user type
            handlePlatformChange();
            
            // Add event listener for platform change
            const platformSelect = document.querySelector('.platform-select');
            if (platformSelect) {
                platformSelect.addEventListener('change', handlePlatformChange);
            }
        }

        // Initialize all multi-select dropdowns
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize multi-select dropdowns
            initMultiSelectDropdowns();
        });

        function initMultiSelectDropdowns() {
            // Find all multi-select elements
            const multiSelects = document.querySelectorAll('.multi-select');
            
            multiSelects.forEach(select => {
                const header = select.querySelector('.multi-select-header');
                const dropdown = select.querySelector('.multi-select-dropdown');
                const options = select.querySelectorAll('.multi-select-option input');
                const headerText = header.querySelector('span');
                
                // Toggle dropdown on header click
                header.addEventListener('click', (e) => {
                    e.stopPropagation();
                    
                    // Close all other open dropdowns
                    document.querySelectorAll('.multi-select-dropdown.active').forEach(d => {
                        if (d !== dropdown) {
                            d.classList.remove('active');
                            d.closest('.multi-select').querySelector('.multi-select-header').classList.remove('active');
                        }
                    });
                    
                    // Toggle current dropdown
                    dropdown.classList.toggle('active');
                    header.classList.toggle('active');
                });
                
                // Handle option selection
                options.forEach(option => {
                    option.addEventListener('change', (e) => {
                        e.stopPropagation();
                        updateHeaderText(select);
                    });
                    
                    // Prevent dropdown from closing when clicking on options
                    option.parentElement.addEventListener('click', (e) => {
                        e.stopPropagation();
                    });
                });
                
                // Initial header text
                updateHeaderText(select);
            });
            
            // Close dropdowns when clicking outside
            document.addEventListener('click', () => {
                document.querySelectorAll('.multi-select-dropdown.active').forEach(dropdown => {
                    dropdown.classList.remove('active');
                    dropdown.closest('.multi-select').querySelector('.multi-select-header').classList.remove('active');
                });
            });
        }

        // Update the header text based on selected options
        function updateHeaderText(select) {
            const header = select.querySelector('.multi-select-header span');
            const options = select.querySelectorAll('.multi-select-option input');
            const selectedOptions = Array.from(options).filter(opt => opt.checked);
            
            if (selectedOptions.length === 0) {
                header.textContent = '请选择';
            } else if (selectedOptions.length === options.length) {
                header.textContent = '全部';
            } else if (selectedOptions.length <= 2) {
                const labels = selectedOptions.map(opt => {
                    const text = opt.parentElement.textContent.trim();
                    return text;
                });
                header.textContent = labels.join(', ');
            } else {
                header.textContent = `已选 ${selectedOptions.length} 项`;
            }
        }

        // 显示用户详情
        function showUserDetail(name, employeeId, department, addTime, reason, usageCount) {
            // 获取用户详情模态框
            const modal = document.getElementById('user-detail-modal');
            
            // 更新模态框标题和内容
            modal.querySelector('.modal-header h3').textContent = `用户详情 - ${name}`;
            
            // 填充用户信息
            const modalBody = modal.querySelector('.modal-body');
            modalBody.innerHTML = `
                <div class="detail-section">
                    <h4>用户信息</h4>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-label">姓名</div>
                            <div class="detail-value">${name}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">工号</div>
                            <div class="detail-value">${employeeId}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">部门</div>
                            <div class="detail-value">${department}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">授权时间</div>
                            <div class="detail-value">${addTime}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">使用次数</div>
                            <div class="detail-value">${usageCount}</div>
                        </div>
                    </div>
                </div>
                
                <div class="detail-section">
                    <h4>授权备注</h4>
                    <div class="detail-remarks">
                        ${reason || '无'}
                    </div>
                </div>
            `;
            
            // 显示模态框
            modal.style.display = 'flex';
            
            // 确保关闭按钮有事件
            const closeBtn = modal.querySelector('.close-btn');
            if (closeBtn) {
                closeBtn.addEventListener('click', function() {
                    modal.style.display = 'none';
                });
            }
        }

        // 在页面加载时为已存在的收回权限按钮添加点击事件
        document.addEventListener('DOMContentLoaded', function() {
            // 为已授权用户表格中的所有收回权限按钮添加事件
            const removeButtons = document.querySelectorAll('#authorized-tab .remove-btn');
            removeButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const row = this.closest('tr');
                    const name = row.querySelector('td:nth-child(2)').textContent;
                    
                    if (confirm(`确定要收回 ${name} 的权限吗？`)) {
                        // 获取表格的tbody元素，然后移除整行
                        const tbody = row.parentNode;
                        tbody.removeChild(row);
                    }
                });
            });
            
            // 为已授权用户表格中的所有查看按钮添加事件
            const viewButtons = document.querySelectorAll('#authorized-tab .view-btn');
            viewButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const row = this.closest('tr');
                    const name = row.querySelector('td:nth-child(2)').textContent;
                    const employeeId = row.querySelector('td:nth-child(3)').textContent;
                    const department = row.querySelector('td:nth-child(4)').textContent;
                    const addTime = row.querySelector('td:nth-child(7)').textContent;
                    const usageCount = row.querySelector('td:nth-child(9)').textContent;
                    
                    // 模拟授权备注
                    const reasons = {
                        '张三': '需要使用AI工具提升工作效率',
                        '李四': '需要调研AI产品功能',
                        '王五': '产品设计需要使用AI助手',
                        '赵六': '需要使用系统管理员工培训数据',
                        '钱七': '开发需要使用AI接口'
                    };
                    
                    const reason = reasons[name] || '用户申请使用系统';
                    
                    // 显示用户详情
                    showUserDetail(name, employeeId, department, addTime, reason, usageCount);
                });
            });
        });

        // 添加表格全选/取消全选功能
        function setupTableCheckboxes() {
            // 获取已授权用户表格的表头复选框
            const authorizedHeaderCheckbox = document.querySelector('#authorized-tab table thead th:first-child input[type="checkbox"]');
            
            // 为表头复选框添加点击事件
            if (authorizedHeaderCheckbox) {
                authorizedHeaderCheckbox.addEventListener('change', function() {
                    // 获取表格中所有行的复选框
                    const rowCheckboxes = document.querySelectorAll('#authorized-tab table tbody td:first-child input[type="checkbox"]');
                    
                    // 设置所有行的复选框状态与表头复选框一致
                    rowCheckboxes.forEach(checkbox => {
                        checkbox.checked = authorizedHeaderCheckbox.checked;
                    });
                    
                    // 更新批量操作按钮的状态
                    updateBatchActionStatus('authorized');
                });
            }
            
            // 获取当前登录用户表格的表头复选框
            const activeHeaderCheckbox = document.querySelector('#active-tab table thead th:first-child input[type="checkbox"]');
            
            // 为表头复选框添加点击事件
            if (activeHeaderCheckbox) {
                activeHeaderCheckbox.addEventListener('change', function() {
                    // 获取表格中所有行的复选框
                    const rowCheckboxes = document.querySelectorAll('#active-tab table tbody td:first-child input[type="checkbox"]');
                    
                    // 设置所有行的复选框状态与表头复选框一致
                    rowCheckboxes.forEach(checkbox => {
                        checkbox.checked = activeHeaderCheckbox.checked;
                    });
                    
                    // 更新批量操作按钮的状态
                    updateBatchActionStatus('active');
                });
            }
            
            // 移除原来的审批表格表头复选框逻辑 (由新函数替代)
            
            // 为每个表格中的行复选框添加事件，以便在单个选择变化时更新表头复选框状态
            setupRowCheckboxes('authorized');
            setupRowCheckboxes('active');
            setupApprovalRowCheckboxes(); // 为审批表格使用特殊处理
        }

        // 设置表格行复选框的事件
        function setupRowCheckboxes(tabId) {
            const rowCheckboxes = document.querySelectorAll(`#${tabId}-tab table tbody td:first-child input[type="checkbox"]`);
            const headerCheckbox = document.querySelector(`#${tabId}-tab table thead th:first-child input[type="checkbox"]`);
            
            rowCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    // 检查是否所有行都被选中
                    const allChecked = Array.from(rowCheckboxes).every(cb => cb.checked);
                    const anyChecked = Array.from(rowCheckboxes).some(cb => cb.checked);
                    
                    // 更新表头复选框状态
                    if (headerCheckbox) {
                        headerCheckbox.checked = allChecked;
                        // 可以添加indeterminate状态表示部分选中
                        headerCheckbox.indeterminate = anyChecked && !allChecked;
                    }
                    
                    // 更新批量操作按钮的状态
                    updateBatchActionStatus(tabId);
                });
            });
        }

        // 更新批量操作按钮的状态（启用/禁用）
        function updateBatchActionStatus(tabId) {
            const rowCheckboxes = document.querySelectorAll(`#${tabId}-tab table tbody td:first-child input[type="checkbox"]`);
            const batchActionButtons = document.querySelectorAll(`#${tabId}-tab .batch-actions button`);
            
            // 检查是否有任何行被选中
            const anyChecked = Array.from(rowCheckboxes).some(cb => cb.checked);
            
            // 更新批量操作按钮的禁用状态
            batchActionButtons.forEach(button => {
                button.disabled = !anyChecked;
                if (anyChecked) {
                    button.classList.remove('disabled');
                } else {
                    button.classList.add('disabled');
                }
            });
        }

        // 初始化页面中所有批量操作按钮的状态
        function initBatchActionButtons() {
            // 为每个标签页更新批量操作按钮状态
            updateBatchActionStatus('authorized');
            updateBatchActionStatus('approval');
            updateBatchActionStatus('active');
        }

        // 修改批量收回权限功能
        function setupBatchRemovePermission() {
            // 获取批量收回权限按钮
            const batchRemoveBtn = document.querySelector('#authorized-tab .batch-actions .remove-btn');
            
            if (batchRemoveBtn) {
                batchRemoveBtn.addEventListener('click', function() {
                    // 获取所有选中的行复选框
                    const checkedRows = document.querySelectorAll('#authorized-tab table tbody td:first-child input[type="checkbox"]:checked');
                    
                    // 如果没有选中的行，按钮应该是禁用的，所以这里不需要额外检查
                    // 直接获取选中用户的姓名
                    const selectedUsers = Array.from(checkedRows).map(checkbox => {
                        const row = checkbox.closest('tr');
                        return row.querySelector('td:nth-child(2)').textContent;
                    });
                    
                    // 显示确认对话框
                    if (confirm(`确定要收回以下用户的权限吗？\n${selectedUsers.join('\n')}`)) {
                        // 遍历选中的行并删除
                        checkedRows.forEach(checkbox => {
                            const row = checkbox.closest('tr');
                            if (row && row.parentNode) {
                                row.parentNode.removeChild(row);
                            }
                        });
                        
                        // 重置表头复选框
                        const headerCheckbox = document.querySelector('#authorized-tab table thead th:first-child input[type="checkbox"]');
                        if (headerCheckbox) {
                            headerCheckbox.checked = false;
                            headerCheckbox.indeterminate = false;
                        }
                        
                        // 更新批量操作按钮状态
                        updateBatchActionStatus('authorized');
                    }
                });
            }
        }

        // 在页面加载完成后设置复选框联动
        document.addEventListener('DOMContentLoaded', function() {
            // ...现有的DOMContentLoaded事件处理程序...
            
            // 设置表格复选框联动
            setupTableCheckboxes();
            
            // 专门设置审批表头复选框
            setupApprovalHeaderCheckbox();
            
            // 禁用已处理的审批单复选框
            disableProcessedApprovalCheckboxes();
            
            // 设置批量收回权限功能
            setupBatchRemovePermission();
            
            // 初始化批量操作按钮状态 (禁用)
            initBatchActionButtons();
        });

        // 添加一个函数来禁用已处理审批单的复选框
        function disableProcessedApprovalCheckboxes() {
            // 获取所有审批单行
            const approvalRows = document.querySelectorAll('#approval-tab table tbody tr');
            
            approvalRows.forEach(row => {
                // 获取状态列，检查是否为"已通过"或"已拒绝"
                const statusElement = row.querySelector('td:nth-child(9) .status');
                if (statusElement) {
                    const status = statusElement.textContent;
                    
                    // 如果是已处理的状态，禁用复选框
                    if (status === '已通过' || status === '已拒绝') {
                        const checkbox = row.querySelector('td:first-child input[type="checkbox"]');
                        if (checkbox) {
                            checkbox.disabled = true;
                            checkbox.checked = false; // 确保未被选中
                            checkbox.parentElement.title = '已处理的审批单不可选择'; // 添加提示
                        }
                    }
                }
            });
        }

        // 修改表头复选框事件，只影响未禁用的复选框
        function setupApprovalHeaderCheckbox() {
            const approvalHeaderCheckbox = document.querySelector('#approval-tab table thead th:first-child input[type="checkbox"]');
            
            if (approvalHeaderCheckbox) {
                approvalHeaderCheckbox.addEventListener('change', function() {
                    // 只获取未禁用的行复选框
                    const availableRowCheckboxes = document.querySelectorAll('#approval-tab table tbody td:first-child input[type="checkbox"]:not([disabled])');
                    
                    // 设置所有可用行的复选框状态与表头复选框一致
                    availableRowCheckboxes.forEach(checkbox => {
                        checkbox.checked = approvalHeaderCheckbox.checked;
                    });
                    
                    // 更新批量操作按钮的状态
                    updateBatchActionStatus('approval');
                });
            }
        }

        // 专门为审批表格行复选框设置事件
        function setupApprovalRowCheckboxes() {
            const rowCheckboxes = document.querySelectorAll('#approval-tab table tbody td:first-child input[type="checkbox"]');
            const headerCheckbox = document.querySelector('#approval-tab table thead th:first-child input[type="checkbox"]');
            
            rowCheckboxes.forEach(checkbox => {
                // 只为未禁用的复选框添加事件
                if (!checkbox.disabled) {
                    checkbox.addEventListener('change', function() {
                        // 获取所有未禁用的复选框
                        const availableCheckboxes = document.querySelectorAll('#approval-tab table tbody td:first-child input[type="checkbox"]:not([disabled])');
                        
                        // 检查是否所有可用行都被选中
                        const allChecked = Array.from(availableCheckboxes).every(cb => cb.checked);
                        const anyChecked = Array.from(availableCheckboxes).some(cb => cb.checked);
                        
                        // 更新表头复选框状态
                        if (headerCheckbox) {
                            headerCheckbox.checked = allChecked;
                            // 可以添加indeterminate状态表示部分选中
                            headerCheckbox.indeterminate = anyChecked && !allChecked;
                        }
                        
                        // 更新批量操作按钮的状态
                        updateBatchActionStatus('approval');
                    });
                }
            });
        }
    </script>
</body>
</html> 
